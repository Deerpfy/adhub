<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚡ Blitzfit - Personal Coordination Platform</title>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
/* Blitzfit - Visual System & Design Tokens */

:root {
    /* Primary color palette - Purple & Lime Green Blitzfit theme */
    --bf-primary-500: #9333EA; /* Purple */
    --bf-primary-600: #7E22CE;
    --bf-primary-700: #6B21A8;
    --bf-accent-500: #A855F7; /* Light purple */
    --bf-accent-600: #9333EA;
    --bf-success-500: #84CC16; /* Lime green */
    --bf-success-600: #65A30D;
    --bf-warning-500: #F59E0B;
    --bf-danger-500: #DC2626;

    /* Light theme - Neutral / UI surfaces */
    --bf-bg: #FFFFFF;
    --bf-surface-100: #F8FAFC;
    --bf-surface-200: #F1F5F9;
    --bf-surface-300: #E2E8F0;
    --bf-text-900: #0F172A;
    --bf-text-700: #334155;
    --bf-text-500: #64748B;
    --bf-text-300: #CBD5E1;

    /* Spacing & radii */
    --bf-radius-sm: 6px;
    --bf-radius-md: 12px;
    --bf-radius-lg: 24px;
    --bf-spacing-xs: 4px;
    --bf-spacing-sm: 8px;
    --bf-spacing-md: 16px;
    --bf-spacing-lg: 24px;
    --bf-spacing-xl: 32px;

    /* Typography */
    --bf-font-family-sans: Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    --bf-font-size-xs: 12px;
    --bf-font-size-sm: 14px;
    --bf-font-size-base: 16px;
    --bf-font-size-lg: 18px;
    --bf-font-size-xl: 20px;
    --bf-font-size-2xl: 24px;
    --bf-font-size-3xl: 30px;

    /* Shadows */
    --bf-shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --bf-shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --bf-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --bf-shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);

    /* Transitions */
    --bf-transition-fast: 150ms ease;
    --bf-transition-base: 200ms ease;
    --bf-transition-slow: 300ms ease;
}

/* Dark theme - Purple tinted */
[data-theme="dark"] {
    --bf-bg: #0F0519; /* Dark purple background */
    --bf-surface-100: #1A0F2E; /* Purple tinted surface */
    --bf-surface-200: #251A3A;
    --bf-surface-300: #2D1F47;
    --bf-text-100: #F3E8FF; /* Light purple text */
    --bf-text-300: #E9D5FF; /* Brighter for better contrast */
    --bf-text-500: #C4B5FD;
    --bf-text-700: #A78BFA;
    --bf-text-900: #F3E8FF; /* Main text color */
}

/* Dark theme - Blue variant */
[data-theme="dark-blue"] {
    --bf-bg: #0A0E1A;
    --bf-surface-100: #141B2E;
    --bf-surface-200: #1E2A47;
    --bf-surface-300: #283A5C;
    --bf-text-100: #E0E7FF;
    --bf-text-300: #C7D2FE;
    --bf-text-500: #A5B4FC;
    --bf-text-700: #818CF8;
    --bf-text-900: #E0E7FF;
}

/* Dark theme - Green variant */
[data-theme="dark-green"] {
    --bf-bg: #0A1A0F;
    --bf-surface-100: #142E1A;
    --bf-surface-200: #1E4728;
    --bf-surface-300: #285C35;
    --bf-text-100: #E0FFE7;
    --bf-text-300: #C7FED2;
    --bf-text-500: #A5FCB4;
    --bf-text-700: #81F88C;
    --bf-text-900: #E0FFE7;
}

/* High contrast theme */
[data-theme="high-contrast"] {
    --bf-bg: #FFFFFF;
    --bf-surface-100: #F5F5F5;
    --bf-surface-200: #E0E0E0;
    --bf-surface-300: #CCCCCC;
    --bf-text-900: #000000;
    --bf-text-700: #333333;
    --bf-text-500: #666666;
    --bf-text-300: #999999;
    --bf-text-100: #CCCCCC;
    --bf-primary-500: #0066CC;
    --bf-primary-600: #0052A3;
    --bf-accent-500: #0099FF;
    --bf-success-500: #00AA00;
    --bf-warning-500: #FF8800;
    --bf-danger-500: #CC0000;
}

/* Special innovative theme - Mind-Eye */
[data-theme="mind-eye"] {
    --bf-bg: #0A0A15;
    --bf-surface-100: #151525;
    --bf-surface-200: #1F1F35;
    --bf-surface-300: #2A2A45;
    --bf-text-100: #E8F4FF;
    --bf-text-300: #B8D9FF;
    --bf-text-500: #8BB5FF;
    --bf-text-700: #5E8FFF;
    --bf-text-900: #E8F4FF;
    --bf-primary-500: #6B46FF;
    --bf-primary-600: #5B36EF;
    --bf-primary-700: #4B26DF;
    --bf-accent-500: #00D9FF;
    --bf-accent-600: #00B8E6;
    --bf-success-500: #00FF88;
    --bf-success-600: #00E677;
    --bf-warning-500: #FFB800;
    --bf-danger-500: #FF3366;
}

/* Mind-Eye animated background */
[data-theme="mind-eye"] body {
    position: relative;
    overflow-x: hidden;
}

/* RGB animované pozadí - vrstva 1 (červená) */
[data-theme="mind-eye"] body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: 
        radial-gradient(circle at 30% 30%, rgba(255, 0, 0, 0.15) 0%, transparent 45%),
        radial-gradient(circle at 70% 70%, rgba(255, 50, 0, 0.12) 0%, transparent 50%),
        radial-gradient(circle at 50% 20%, rgba(255, 100, 0, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 10% 60%, rgba(255, 0, 50, 0.08) 0%, transparent 35%);
    animation: rgbMove1 60s ease-in-out infinite, rgbFade1 40s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
    mix-blend-mode: screen;
    filter: blur(60px);
}

/* RGB animované pozadí - vrstva 2 (zelená) */
[data-theme="mind-eye"] body::after {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: 
        radial-gradient(circle at 60% 40%, rgba(0, 255, 0, 0.15) 0%, transparent 45%),
        radial-gradient(circle at 20% 80%, rgba(0, 255, 50, 0.12) 0%, transparent 50%),
        radial-gradient(circle at 80% 60%, rgba(50, 255, 100, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 40% 10%, rgba(100, 255, 0, 0.08) 0%, transparent 35%);
    animation: rgbMove2 70s ease-in-out infinite, rgbFade2 45s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
    mix-blend-mode: screen;
    filter: blur(60px);
}

/* RGB animované pozadí - vrstva 3 (modrá) - pomocí pseudo-elementu na #root */
[data-theme="mind-eye"] #root::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: 
        radial-gradient(circle at 40% 60%, rgba(0, 0, 255, 0.15) 0%, transparent 45%),
        radial-gradient(circle at 80% 20%, rgba(0, 100, 255, 0.12) 0%, transparent 50%),
        radial-gradient(circle at 20% 50%, rgba(50, 150, 255, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(0, 50, 255, 0.08) 0%, transparent 35%);
    animation: rgbMove3 80s ease-in-out infinite, rgbFade3 50s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
    mix-blend-mode: screen;
    filter: blur(60px);
}

/* RGB animované pozadí - vrstva 4 (kombinované barvy) */
[data-theme="mind-eye"] #root::after {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: 
        radial-gradient(circle at 50% 50%, rgba(255, 0, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 25% 75%, rgba(255, 255, 0, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 75% 25%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 15% 30%, rgba(255, 150, 0, 0.08) 0%, transparent 40%);
    animation: rgbMove4 65s ease-in-out infinite, rgbFade4 42s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
    mix-blend-mode: screen;
    filter: blur(60px);
}

/* Animace pohybu pro červenou vrstvu */
@keyframes rgbMove1 {
    0% {
        transform: translate(0%, 0%) rotate(0deg);
    }
    25% {
        transform: translate(15%, -10%) rotate(90deg);
    }
    50% {
        transform: translate(-10%, 15%) rotate(180deg);
    }
    75% {
        transform: translate(10%, 10%) rotate(270deg);
    }
    100% {
        transform: translate(0%, 0%) rotate(360deg);
    }
}

/* Animace prolínání pro červenou vrstvu */
@keyframes rgbFade1 {
    0%, 100% {
        opacity: 0.6;
    }
    33% {
        opacity: 0.9;
    }
    66% {
        opacity: 0.4;
    }
}

/* Animace pohybu pro zelenou vrstvu */
@keyframes rgbMove2 {
    0% {
        transform: translate(0%, 0%) rotate(0deg);
    }
    25% {
        transform: translate(-15%, 10%) rotate(-90deg);
    }
    50% {
        transform: translate(10%, -15%) rotate(-180deg);
    }
    75% {
        transform: translate(-10%, -10%) rotate(-270deg);
    }
    100% {
        transform: translate(0%, 0%) rotate(-360deg);
    }
}

/* Animace prolínání pro zelenou vrstvu */
@keyframes rgbFade2 {
    0%, 100% {
        opacity: 0.5;
    }
    33% {
        opacity: 0.8;
    }
    66% {
        opacity: 0.6;
    }
}

/* Animace pohybu pro modrou vrstvu */
@keyframes rgbMove3 {
    0% {
        transform: translate(0%, 0%) rotate(0deg);
    }
    25% {
        transform: translate(10%, 15%) rotate(120deg);
    }
    50% {
        transform: translate(-15%, -10%) rotate(240deg);
    }
    75% {
        transform: translate(15%, -5%) rotate(360deg);
    }
    100% {
        transform: translate(0%, 0%) rotate(480deg);
    }
}

/* Animace prolínání pro modrou vrstvu */
@keyframes rgbFade3 {
    0%, 100% {
        opacity: 0.7;
    }
    33% {
        opacity: 0.4;
    }
    66% {
        opacity: 0.9;
    }
}

/* Animace pohybu pro kombinované barvy */
@keyframes rgbMove4 {
    0% {
        transform: translate(0%, 0%) rotate(0deg) scale(1);
    }
    25% {
        transform: translate(-10%, 10%) rotate(90deg) scale(1.1);
    }
    50% {
        transform: translate(10%, -10%) rotate(180deg) scale(0.9);
    }
    75% {
        transform: translate(-5%, -5%) rotate(270deg) scale(1.05);
    }
    100% {
        transform: translate(0%, 0%) rotate(360deg) scale(1);
    }
}

/* Animace prolínání pro kombinované barvy */
@keyframes rgbFade4 {
    0%, 100% {
        opacity: 0.4;
    }
    25% {
        opacity: 0.7;
    }
    50% {
        opacity: 0.5;
    }
    75% {
        opacity: 0.8;
    }
}

/* Mind-Eye floating particles */
.mind-eye-particles {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
    overflow: hidden;
}

.mind-eye-particle {
    position: absolute;
    width: 4px;
    height: 4px;
    background: var(--bf-accent-500);
    border-radius: 50%;
    opacity: 0.6;
    animation: float 15s infinite ease-in-out;
    box-shadow: 0 0 10px var(--bf-accent-500);
}

@keyframes float {
    0%, 100% {
        transform: translate(0, 0) scale(1);
        opacity: 0.3;
    }
    25% {
        transform: translate(100px, -100px) scale(1.5);
        opacity: 0.8;
    }
    50% {
        transform: translate(-50px, -200px) scale(0.8);
        opacity: 0.5;
    }
    75% {
        transform: translate(-150px, -100px) scale(1.2);
        opacity: 0.7;
    }
}

/* Mind-Eye special card styling */
[data-theme="mind-eye"] .card {
    background: linear-gradient(135deg, rgba(107, 70, 255, 0.1), rgba(0, 217, 255, 0.05));
    border: 1px solid rgba(107, 70, 255, 0.3);
    backdrop-filter: blur(10px);
    box-shadow: 
        0 8px 32px rgba(107, 70, 255, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
}

[data-theme="mind-eye"] .card:hover {
    border-color: rgba(0, 217, 255, 0.5);
    box-shadow: 
        0 12px 48px rgba(107, 70, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}

/* Mind-Eye button styling */
[data-theme="mind-eye"] .btn-primary {
    background: linear-gradient(135deg, var(--bf-primary-500), var(--bf-accent-500));
    border: none;
    box-shadow: 0 4px 20px rgba(107, 70, 255, 0.4);
    position: relative;
    overflow: hidden;
}

[data-theme="mind-eye"] .btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s;
}

[data-theme="mind-eye"] .btn-primary:hover::before {
    left: 100%;
}

[data-theme="mind-eye"] .btn-primary:hover {
    box-shadow: 0 6px 30px rgba(107, 70, 255, 0.6);
    transform: translateY(-1px);
}

/* Base styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* Prevent text selection in mind map blocks */
.mindmap-block {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

/* Mind Map hover animations */
.mindmap-draggable {
    position: relative;
    transition: all var(--bf-transition-base);
}

.mindmap-draggable::before {
    content: '';
    position: absolute;
    top: -4px;
    left: -4px;
    right: -4px;
    bottom: -4px;
    border: 2px solid var(--bf-primary-500);
    border-radius: var(--bf-radius-md);
    opacity: 0;
    transition: opacity var(--bf-transition-base);
    pointer-events: none;
    animation: mindmapPulse 2s ease-in-out infinite;
}

.mindmap-draggable:hover::before {
    opacity: 0.6;
}

.mindmap-draggable:hover {
    box-shadow: 0 8px 24px rgba(147, 51, 234, 0.3);
}

.mindmap-draggable:hover[style*="transform"] {
    /* Preserve existing transform and add scale */
}

@keyframes mindmapPulse {
    0%, 100% {
        transform: scale(1);
        opacity: 0.6;
    }
    50% {
        transform: scale(1.05);
        opacity: 0.8;
    }
}

/* Resize handle */
.mindmap-resize-handle {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 16px;
    height: 16px;
    background: var(--bf-primary-500);
    border-radius: var(--bf-radius-sm) 0 var(--bf-radius-sm) 0;
    cursor: nwse-resize;
    opacity: 0;
    transition: opacity var(--bf-transition-base);
    z-index: 10;
}

.mindmap-draggable:hover .mindmap-resize-handle {
    opacity: 0.7;
}

.mindmap-resize-handle:hover {
    opacity: 1;
    background: var(--bf-primary-600);
}

.mindmap-resize-handle::after {
    content: '';
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 0;
    height: 0;
    border-style: solid;
    border-width: 0 0 8px 8px;
    border-color: transparent transparent white transparent;
}

/* Selection box */
.mindmap-selection-box {
    position: absolute;
    border: 2px dashed var(--bf-primary-500);
    background: rgba(147, 51, 234, 0.1);
    pointer-events: none;
    z-index: 1000;
}

body {
    font-family: var(--bf-font-family-sans);
    font-size: var(--bf-font-size-base);
    background-color: var(--bf-bg);
    color: var(--bf-text-900);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

#root {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    position: relative;
}

/* Zajištění, že #root pseudo-elementy jsou viditelné */
[data-theme="mind-eye"] #root {
    position: relative;
}

/* Typography */
h1, h2, h3, h4, h5, h6 {
    font-weight: 600;
    line-height: 1.2;
    color: var(--bf-text-900);
}

h1 { font-size: var(--bf-font-size-3xl); }
h2 { font-size: var(--bf-font-size-2xl); }
h3 { font-size: var(--bf-font-size-xl); }
h4 { font-size: var(--bf-font-size-lg); }

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--bf-spacing-sm);
    padding: var(--bf-spacing-sm) var(--bf-spacing-md);
    border-radius: var(--bf-radius-md);
    font-size: var(--bf-font-size-base);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--bf-transition-base);
    border: none;
    outline: none;
}

.btn-primary {
    background: linear-gradient(135deg, var(--bf-primary-500), var(--bf-accent-500));
    color: white;
    box-shadow: 0 2px 4px rgba(147, 51, 234, 0.3);
}

.btn-primary:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--bf-primary-600), var(--bf-accent-600));
    box-shadow: 0 4px 8px rgba(147, 51, 234, 0.4);
    transform: translateY(-1px);
}

.btn-secondary {
    background-color: var(--bf-surface-100);
    color: var(--bf-text-900);
    border: 1px solid var(--bf-surface-200);
}

.btn-secondary:hover:not(:disabled) {
    background-color: var(--bf-surface-200);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-icon {
    width: 36px;
    height: 36px;
    padding: 0;
    border-radius: var(--bf-radius-md);
    background-color: transparent;
}

.btn-icon:hover {
    background-color: var(--bf-surface-100);
}

/* Inputs */
.input {
    width: 100%;
    padding: var(--bf-spacing-sm) var(--bf-spacing-md);
    border: 1px solid var(--bf-surface-200);
    border-radius: var(--bf-radius-md);
    background-color: var(--bf-surface-100);
    color: var(--bf-text-900);
    font-size: var(--bf-font-size-base);
    font-family: inherit;
    outline: none;
    transition: border-color var(--bf-transition-base);
}

.input:focus {
    border-color: var(--bf-primary-500);
    box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.2);
}

/* Cards */
.card {
    background-color: var(--bf-surface-100);
    border: 1px solid var(--bf-surface-200);
    border-radius: var(--bf-radius-md);
    padding: var(--bf-spacing-md);
    transition: all var(--bf-transition-base);
}

.card:hover {
    border-color: var(--bf-primary-500);
    box-shadow: 0 4px 12px rgba(147, 51, 234, 0.2);
    transform: translateY(-2px);
    transition: all var(--bf-transition-base);
}

/* Checkbox */
.checkbox {
    width: 44px;
    height: 44px;
    cursor: pointer;
    accent-color: var(--bf-success-500);
}

/* Scrollbar */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--bf-surface-100);
}

::-webkit-scrollbar-thumb {
    background: var(--bf-primary-500);
    border-radius: var(--bf-radius-sm);
    opacity: 0.5;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--bf-primary-600);
    opacity: 0.8;
}

/* Focus visible */
*:focus-visible {
    outline: 2px solid var(--bf-primary-500);
    outline-offset: 2px;
}

/* Blitzfit accent colors */
.accent-lime {
    color: var(--bf-success-500);
}

.accent-purple {
    color: var(--bf-primary-500);
}

/* Gradient backgrounds */
.gradient-purple {
    background: linear-gradient(135deg, var(--bf-primary-500), var(--bf-accent-500));
}

.gradient-blitzfit {
    background: linear-gradient(135deg, var(--bf-primary-500) 0%, var(--bf-success-500) 100%);
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-4px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in {
    animation: fadeIn var(--bf-transition-base);
}

/* Utility classes */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- All scripts inline to avoid CORS issues with file:// protocol -->
    <script type="text/babel">
// Blitzfit - Storage Service (LocalStorage implementation)
const StorageService = {
    getCurrentUser() {
        const user = localStorage.getItem('blitzfit_user');
        return user ? JSON.parse(user) : null;
    },
    setCurrentUser(user) {
        if (user) {
            localStorage.setItem('blitzfit_user', JSON.stringify(user));
        } else {
            localStorage.removeItem('blitzfit_user');
        }
    },
    getTasks(filters = {}) {
        const tasks = JSON.parse(localStorage.getItem('blitzfit_tasks') || '[]');
        let filtered = [...tasks];
        if (filters.status) filtered = filtered.filter(t => t.status === filters.status);
        if (filters.project_id) filtered = filtered.filter(t => t.project_id === filters.project_id);
        if (filters.archived !== undefined) filtered = filtered.filter(t => t.archived === filters.archived);
        if (filters.due_today) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            filtered = filtered.filter(t => {
                if (!t.due_at) return false;
                const dueDate = new Date(t.due_at);
                return dueDate >= today && dueDate < tomorrow;
            });
        }
        if (filters.priority) filtered = filtered.filter(t => t.priority === filters.priority);
        return filtered;
    },
    getTask(id) {
        const tasks = this.getTasks();
        return tasks.find(t => t.id === id);
    },
    saveTasks(tasks) {
        localStorage.setItem('blitzfit_tasks', JSON.stringify(tasks));
    },
    createTask(task) {
        const tasks = this.getTasks();
        const user = this.getCurrentUser();
        const newTask = {
            id: this.generateId(),
            user_id: user?.id || 'local',
            project_id: task.project_id || null,
            parent_id: task.parent_id || null,
            title: task.title,
            body: task.body || '',
            status: task.status || 'todo',
            priority: task.priority || 2,
            due_at: task.due_at || null,
            scheduled_at: task.scheduled_at || null,
            metadata: task.metadata || {},
            archived: false,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
        };
        tasks.push(newTask);
        this.saveTasks(tasks);
        return newTask;
    },
    updateTask(id, updates) {
        const tasks = this.getTasks();
        const index = tasks.findIndex(t => t.id === id);
        if (index !== -1) {
            tasks[index] = { ...tasks[index], ...updates, updated_at: new Date().toISOString() };
            this.saveTasks(tasks);
            return tasks[index];
        }
        return null;
    },
    deleteTask(id) {
        const tasks = this.getTasks();
        const filtered = tasks.filter(t => t.id !== id);
        this.saveTasks(filtered);
    },
    getProjects() {
        return JSON.parse(localStorage.getItem('blitzfit_projects') || '[]');
    },
    getProject(id) {
        const projects = this.getProjects();
        return projects.find(p => p.id === id);
    },
    saveProjects(projects) {
        localStorage.setItem('blitzfit_projects', JSON.stringify(projects));
    },
    createProject(project) {
        const projects = this.getProjects();
        const user = this.getCurrentUser();
        const newProject = {
            id: this.generateId(),
            user_id: user?.id || 'local',
            title: project.title,
            description: project.description || '',
            type: project.type || 'list',
            settings: project.settings || {},
            parent_project_id: project.parent_project_id || null,
            archived: false,
            created_at: new Date().toISOString(),
        };
        projects.push(newProject);
        this.saveProjects(projects);
        return newProject;
    },
    updateProject(id, updates) {
        const projects = this.getProjects();
        const index = projects.findIndex(p => p.id === id);
        if (index !== -1) {
            projects[index] = { ...projects[index], ...updates };
            this.saveProjects(projects);
            return projects[index];
        }
        return null;
    },
    deleteProject(id) {
        const projects = this.getProjects();
        const filtered = projects.filter(p => p.id !== id);
        this.saveProjects(filtered);
    },
    getTags() {
        return JSON.parse(localStorage.getItem('blitzfit_tags') || '[]');
    },
    getTag(id) {
        const tags = this.getTags();
        return tags.find(t => t.id === id);
    },
    saveTags(tags) {
        localStorage.setItem('blitzfit_tags', JSON.stringify(tags));
    },
    createTag(tag) {
        const tags = this.getTags();
        const user = this.getCurrentUser();
        const newTag = {
            id: this.generateId(),
            user_id: user?.id || 'local',
            name: tag.name,
            color: tag.color || '#E5E7EB',
        };
        tags.push(newTag);
        this.saveTags(tags);
        return newTag;
    },
    getOrCreateTag(name) {
        const tags = this.getTags();
        let tag = tags.find(t => t.name.toLowerCase() === name.toLowerCase());
        if (!tag) {
            tag = this.createTag({ name, color: '#E5E7EB' });
        }
        return tag;
    },
    getTaskTags(taskId) {
        const taskTags = JSON.parse(localStorage.getItem('blitzfit_task_tags') || '[]');
        return taskTags.filter(tt => tt.task_id === taskId).map(tt => this.getTag(tt.tag_id)).filter(Boolean);
    },
    addTaskTag(taskId, tagId) {
        const taskTags = JSON.parse(localStorage.getItem('blitzfit_task_tags') || '[]');
        if (!taskTags.find(tt => tt.task_id === taskId && tt.tag_id === tagId)) {
            taskTags.push({ task_id: taskId, tag_id: tagId });
            localStorage.setItem('blitzfit_task_tags', JSON.stringify(taskTags));
        }
    },
    removeTaskTag(taskId, tagId) {
        const taskTags = JSON.parse(localStorage.getItem('blitzfit_task_tags') || '[]');
        const filtered = taskTags.filter(tt => !(tt.task_id === taskId && tt.tag_id === tagId));
        localStorage.setItem('blitzfit_task_tags', JSON.stringify(filtered));
    },
    searchTasks(query) {
        const tasks = this.getTasks();
        if (!query || !query.trim()) return tasks;
        const lowerQuery = query.toLowerCase();
        return tasks.filter(task => {
            const titleMatch = task.title?.toLowerCase().includes(lowerQuery);
            const bodyMatch = task.body?.toLowerCase().includes(lowerQuery);
            return titleMatch || bodyMatch;
        });
    },
    generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
    },
    getSettings() {
        return JSON.parse(localStorage.getItem('blitzfit_settings') || '{}');
    },
    updateSettings(settings) {
        const current = this.getSettings();
        const updated = { ...current, ...settings };
        localStorage.setItem('blitzfit_settings', JSON.stringify(updated));
        return updated;
    },
    getMindMapPositions() {
        return JSON.parse(localStorage.getItem('blitzfit_mindmap_positions') || '{}');
    },
    saveMindMapPosition(id, type, x, y) {
        const positions = this.getMindMapPositions();
        if (!positions[type]) positions[type] = {};
        positions[type][id] = { x, y };
        localStorage.setItem('blitzfit_mindmap_positions', JSON.stringify(positions));
    },
    getMindMapSizes() {
        return JSON.parse(localStorage.getItem('blitzfit_mindmap_sizes') || '{}');
    },
    saveMindMapSize(id, type, width, height) {
        const sizes = this.getMindMapSizes();
        if (!sizes[type]) sizes[type] = {};
        sizes[type][id] = { width, height };
        localStorage.setItem('blitzfit_mindmap_sizes', JSON.stringify(sizes));
    },
    getExpenses() {
        return JSON.parse(localStorage.getItem('blitzfit_expenses') || '[]');
    },
    createExpense(expense) {
        const expenses = this.getExpenses();
        const newExpense = {
            id: this.generateId(),
            amount: parseFloat(expense.amount) || 0,
            category: expense.category || 'other',
            subcategory: expense.subcategory || '',
            description: expense.description || '',
            date: expense.date || new Date().toISOString(),
            created_at: new Date().toISOString(),
        };
        expenses.push(newExpense);
        localStorage.setItem('blitzfit_expenses', JSON.stringify(expenses));
        return newExpense;
    },
    updateExpense(id, updates) {
        const expenses = this.getExpenses();
        const index = expenses.findIndex(e => e.id === id);
        if (index !== -1) {
            expenses[index] = { ...expenses[index], ...updates };
            localStorage.setItem('blitzfit_expenses', JSON.stringify(expenses));
            return expenses[index];
        }
        return null;
    },
    deleteExpense(id) {
        const expenses = this.getExpenses();
        const filtered = expenses.filter(e => e.id !== id);
        localStorage.setItem('blitzfit_expenses', JSON.stringify(filtered));
    },
};
    </script>

    <script type="text/babel">
// Blitzfit - Utility Functions
const Utils = {
    formatDate(dateString) {
        if (!dateString) return null;
        const date = new Date(dateString);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const dateOnly = new Date(date);
        dateOnly.setHours(0, 0, 0, 0);
        if (dateOnly.getTime() === today.getTime()) return 'Today';
        if (dateOnly.getTime() === tomorrow.getTime()) return 'Tomorrow';
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined });
    },
    isOverdue(dateString) {
        if (!dateString) return false;
        const date = new Date(dateString);
        const now = new Date();
        return date < now && date.toDateString() !== now.toDateString();
    },
    parseTags(text) {
        const tagRegex = /#(\w+)/g;
        const matches = text.match(tagRegex);
        return matches ? matches.map(m => m.slice(1)) : [];
    },
    removeTags(text) {
        return text.replace(/#\w+/g, '').trim();
    },
    showToast(message, type = 'info', duration = 3000) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `position: fixed; top: 20px; right: 20px; padding: 12px 16px; background-color: var(--bf-surface-100); border: 1px solid var(--bf-surface-200); border-radius: var(--bf-radius-md); box-shadow: var(--bf-shadow-lg); z-index: 10000; animation: fadeIn 0.2s ease;`;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.2s';
            setTimeout(() => toast.remove(), 200);
        }, duration);
    },
    isModKey(e) {
        return e.metaKey || e.ctrlKey;
    },
};
    </script>

    <script type="text/babel">
// Blitzfit - React Contexts
const { useState, useEffect, createContext, useContext } = React;

const ThemeContext = createContext();
function ThemeProvider({ children }) {
    const [theme, setTheme] = useState(() => {
        const stored = localStorage.getItem('blitzfit_theme');
        return stored || 'light';
    });
    useEffect(() => {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('blitzfit_theme', theme);
    }, [theme]);
    const toggleTheme = () => {
        setTheme(prev => {
            const themes = ['light', 'dark', 'dark-blue', 'dark-green', 'mind-eye', 'high-contrast'];
            const currentIndex = themes.indexOf(prev);
            return themes[(currentIndex + 1) % themes.length];
        });
    };
    const setThemeValue = (newTheme) => {
        const validThemes = ['light', 'dark', 'dark-blue', 'dark-green', 'mind-eye', 'high-contrast'];
        if (validThemes.includes(newTheme)) setTheme(newTheme);
    };
    return <ThemeContext.Provider value={{ theme, toggleTheme, setTheme: setThemeValue }}>{children}</ThemeContext.Provider>;
}
function useTheme() {
    const context = useContext(ThemeContext);
    if (!context) throw new Error('useTheme must be used within ThemeProvider');
    return context;
}

const AuthContext = createContext();
function AuthProvider({ children }) {
    const [user, setUser] = useState(() => StorageService.getCurrentUser());
    const [isLoading, setIsLoading] = useState(false);
    const login = async (email, name) => {
        setIsLoading(true);
        await new Promise(resolve => setTimeout(resolve, 100));
        const userData = {
            id: StorageService.generateId(),
            email,
            name: name || email.split('@')[0],
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            prefs: {},
            created_at: new Date().toISOString(),
        };
        StorageService.setCurrentUser(userData);
        setUser(userData);
        setIsLoading(false);
        return userData;
    };
    const register = async (email, name) => login(email, name);
    const logout = () => {
        StorageService.setCurrentUser(null);
        setUser(null);
    };
    return <AuthContext.Provider value={{ user, login, register, logout, isLoading }}>{children}</AuthContext.Provider>;
}
function useAuth() {
    const context = useContext(AuthContext);
    if (!context) throw new Error('useAuth must be used within AuthProvider');
    return context;
}

const RefreshContext = createContext();
function RefreshProvider({ children }) {
    const [refreshKey, setRefreshKey] = useState(0);
    const refresh = () => setRefreshKey(prev => prev + 1);
    return <RefreshContext.Provider value={{ refreshKey, refresh }}>{children}</RefreshContext.Provider>;
}
function useRefresh() {
    const context = useContext(RefreshContext);
    if (!context) throw new Error('useRefresh must be used within RefreshProvider');
    return context;
}
    </script>

    <script type="text/babel">
// Blitzfit - UI Components
const { useState, useEffect, useRef } = React;

function QuickCapture({ onTaskAdded }) {
    const [title, setTitle] = useState('');
    const [showOptions, setShowOptions] = useState(false);
    const [projectId, setProjectId] = useState('');
    const [priority, setPriority] = useState(2);
    const [dueDate, setDueDate] = useState('');
    const inputRef = useRef(null);
    const projects = StorageService.getProjects();
    const handleSubmit = (e) => {
        e.preventDefault();
        if (!title.trim()) return;
        const tags = Utils.parseTags(title);
        const cleanTitle = Utils.removeTags(title);
        const task = StorageService.createTask({
            title: cleanTitle,
            project_id: projectId || null,
            priority: parseInt(priority),
            due_at: dueDate ? new Date(dueDate).toISOString() : null,
            status: 'todo',
        });
        tags.forEach(tagName => {
            const tag = StorageService.getOrCreateTag(tagName);
            StorageService.addTaskTag(task.id, tag.id);
        });
        setTitle('');
        setProjectId('');
        setPriority(2);
        setDueDate('');
        setShowOptions(false);
        inputRef.current?.focus();
        if (onTaskAdded) onTaskAdded();
        Utils.showToast('Task added to inbox', 'success');
    };
    return (
        <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
            <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                <input ref={inputRef} type="text" className="input" placeholder="Capture anything... (use #tag for tags)" value={title} onChange={(e) => setTitle(e.target.value)} onFocus={() => setShowOptions(true)} style={{ flex: 1 }} />
                <button type="submit" className="btn btn-primary" disabled={!title.trim()}>Add</button>
            </div>
            {showOptions && (
                <div style={{ display: 'flex', gap: '8px', padding: '8px', backgroundColor: 'var(--bf-surface-100)', borderRadius: 'var(--bf-radius-md)', border: '1px solid var(--bf-surface-200)' }}>
                    <select className="input" value={projectId} onChange={(e) => setProjectId(e.target.value)} style={{ flex: 1, minWidth: '120px' }}>
                        <option value="">No project</option>
                        {projects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                    </select>
                    <select className="input" value={priority} onChange={(e) => setPriority(e.target.value)} style={{ width: '100px' }}>
                        <option value="1">Low</option>
                        <option value="2">Normal</option>
                        <option value="3">High</option>
                    </select>
                    <input type="date" className="input" value={dueDate} onChange={(e) => setDueDate(e.target.value)} style={{ width: '140px' }} />
                </div>
            )}
        </form>
    );
}

function TaskCard({ task, onUpdate, onSelect }) {
    const [isHovered, setIsHovered] = useState(false);
    const [showDetail, setShowDetail] = useState(false);
    const [isEditing, setIsEditing] = useState(false);
    const [editTitle, setEditTitle] = useState(task.title);
    const tags = StorageService.getTaskTags(task.id);
    const project = task.project_id ? StorageService.getProject(task.project_id) : null;
    const allProjects = StorageService.getProjects();
    const allTags = StorageService.getTags();
    const handleComplete = (e) => {
        e.stopPropagation();
        const newStatus = task.status === 'done' ? 'todo' : 'done';
        StorageService.updateTask(task.id, { status: newStatus });
        if (onUpdate) onUpdate();
        Utils.showToast(`Task ${newStatus === 'done' ? 'completed' : 'reopened'}`, 'success');
    };
    const handleClick = () => { 
        if (!isEditing) {
            setShowDetail(true);
            if (onSelect) onSelect(task);
        }
    };
    const handleKeyDown = (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            if (e.key === ' ') handleComplete(e);
            else handleClick();
        }
    };
    const handleDelete = () => {
        if (confirm(`Delete task "${task.title}"?`)) {
            StorageService.deleteTask(task.id);
            if (onUpdate) onUpdate();
            setShowDetail(false);
            Utils.showToast('Task deleted', 'success');
        }
    };
    const handleRename = () => {
        if (editTitle.trim() && editTitle !== task.title) {
            StorageService.updateTask(task.id, { title: editTitle.trim() });
            if (onUpdate) onUpdate();
            setIsEditing(false);
            Utils.showToast('Task renamed', 'success');
        } else {
            setIsEditing(false);
            setEditTitle(task.title);
        }
    };
    const handleUpdateField = (field, value) => {
        StorageService.updateTask(task.id, { [field]: value });
        if (onUpdate) onUpdate();
        Utils.showToast('Task updated', 'success');
    };
    return (
        <>
            <div className="card" onMouseEnter={() => setIsHovered(true)} onMouseLeave={() => setIsHovered(false)} onClick={handleClick} onKeyDown={handleKeyDown} tabIndex={0} role="button" style={{ display: 'flex', alignItems: 'flex-start', gap: '12px', cursor: 'pointer', opacity: task.status === 'done' ? 0.6 : 1 }}>
                <input type="checkbox" className="checkbox" checked={task.status === 'done'} onChange={handleComplete} onClick={(e) => e.stopPropagation()} />
                <div style={{ flex: 1, minWidth: 0 }}>
                    {isEditing ? (
                        <input type="text" className="input" value={editTitle} onChange={(e) => setEditTitle(e.target.value)} onBlur={handleRename} onKeyDown={(e) => { if (e.key === 'Enter') handleRename(); if (e.key === 'Escape') { setIsEditing(false); setEditTitle(task.title); } }} autoFocus style={{ width: '100%', marginBottom: '4px' }} />
                    ) : (
                        <>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                                <h3 style={{ fontSize: 'var(--bf-font-size-base)', fontWeight: 500, color: 'var(--bf-text-900)', textDecoration: task.status === 'done' ? 'line-through' : 'none', margin: 0 }}>{task.title}</h3>
                                {task.priority === 3 && <span style={{ fontSize: 'var(--bf-font-size-xs)', color: 'var(--bf-success-500)', fontWeight: 600, backgroundColor: 'rgba(132, 204, 22, 0.1)', padding: '2px 6px', borderRadius: 'var(--bf-radius-sm)' }}>HIGH</span>}
                            </div>
                            {task.due_at && <div style={{ fontSize: 'var(--bf-font-size-sm)', color: Utils.isOverdue(task.due_at) ? 'var(--bf-danger-500)' : 'var(--bf-primary-500)', marginBottom: '4px', fontWeight: Utils.isOverdue(task.due_at) ? 600 : 400 }}>{Utils.formatDate(task.due_at)}{Utils.isOverdue(task.due_at) && ' (Overdue)'}</div>}
                            {project && <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-primary-500)', marginBottom: '4px', fontWeight: 500, display: 'flex', alignItems: 'center', gap: '6px' }}>
                                <Icon name="project" size={14} color="var(--bf-primary-500)" />
                                {project.title}
                            </div>}
                            {tags.length > 0 && (
                                <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap', marginTop: '8px' }}>
                                    {tags.map(tag => <span key={tag.id} style={{ padding: '2px 8px', borderRadius: 'var(--bf-radius-sm)', fontSize: 'var(--bf-font-size-xs)', backgroundColor: tag.color || 'var(--bf-primary-500)', color: 'white', fontWeight: 500 }}>{tag.name}</span>)}
                                </div>
                            )}
                        </>
                    )}
                </div>
                {isHovered && !isEditing && (
                    <button className="btn-icon" onClick={(e) => { e.stopPropagation(); setShowDetail(true); }} style={{ fontSize: '20px' }}>⋯</button>
                )}
            </div>
            {showDetail && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0, 0, 0, 0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 2000 }} onClick={() => setShowDetail(false)}>
                    <div className="card" style={{ width: '90%', maxWidth: '500px', maxHeight: '90vh', overflowY: 'auto' }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', paddingBottom: '16px', borderBottom: '1px solid var(--bf-surface-200)' }}>
                            <h2 style={{ margin: 0 }}>Task Details</h2>
                            <button className="btn btn-secondary" onClick={() => setShowDetail(false)} style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '4px 8px' }}>
                                <Icon name="close" size={16} />
                            </button>
                        </div>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                            <div>
                                <label style={{ display: 'block', marginBottom: '8px', fontSize: 'var(--bf-font-size-sm)', fontWeight: 500 }}>Title</label>
                                <div style={{ display: 'flex', gap: '8px' }}>
                                    <input type="text" className="input" value={editTitle} onChange={(e) => setEditTitle(e.target.value)} style={{ flex: 1 }} />
                                    <button className="btn btn-secondary" onClick={() => { setIsEditing(true); }} style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '6px' }}>
                                        <Icon name="edit" size={16} />
                                    </button>
                                    <button className="btn btn-secondary" onClick={handleRename}>Save</button>
                                </div>
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '8px', fontSize: 'var(--bf-font-size-sm)', fontWeight: 500 }}>Status</label>
                                <select className="input" value={task.status} onChange={(e) => handleUpdateField('status', e.target.value)}>
                                    <option value="todo">To Do</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="done">Done</option>
                                </select>
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '8px', fontSize: 'var(--bf-font-size-sm)', fontWeight: 500 }}>Priority</label>
                                <select className="input" value={task.priority} onChange={(e) => handleUpdateField('priority', parseInt(e.target.value))}>
                                    <option value="1">Low</option>
                                    <option value="2">Normal</option>
                                    <option value="3">High</option>
                                </select>
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '8px', fontSize: 'var(--bf-font-size-sm)', fontWeight: 500 }}>Due Date</label>
                                <input type="datetime-local" className="input" value={task.due_at ? new Date(task.due_at).toISOString().slice(0, 16) : ''} onChange={(e) => handleUpdateField('due_at', e.target.value ? new Date(e.target.value).toISOString() : null)} />
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '8px', fontSize: 'var(--bf-font-size-sm)', fontWeight: 500 }}>Project</label>
                                <select className="input" value={task.project_id || ''} onChange={(e) => handleUpdateField('project_id', e.target.value || null)}>
                                    <option value="">No project</option>
                                    {allProjects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                                </select>
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '8px', fontSize: 'var(--bf-font-size-sm)', fontWeight: 500 }}>Tags</label>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', marginBottom: '8px' }}>
                                    {tags.map(tag => (
                                        <span key={tag.id} style={{ padding: '4px 12px', borderRadius: 'var(--bf-radius-sm)', fontSize: 'var(--bf-font-size-sm)', backgroundColor: tag.color || 'var(--bf-primary-500)', color: 'white', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            {tag.name}
                                            <button onClick={() => { StorageService.removeTaskTag(task.id, tag.id); if (onUpdate) onUpdate(); }} style={{ background: 'none', border: 'none', color: 'white', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '2px', lineHeight: 1 }}>
                                                <Icon name="remove" size={14} color="white" style={{ strokeWidth: 3 }} />
                                            </button>
                                        </span>
                                    ))}
                                </div>
                                <select className="input" onChange={(e) => { if (e.target.value) { const tag = StorageService.getOrCreateTag({ name: e.target.value }); StorageService.addTaskTag(task.id, tag.id); if (onUpdate) onUpdate(); e.target.value = ''; } }}>
                                    <option value="">Add tag...</option>
                                    {allTags.filter(t => !tags.find(tag => tag.id === t.id)).map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                </select>
                            </div>
                            <div style={{ display: 'flex', gap: '8px', marginTop: '8px' }}>
                                <button className="btn btn-primary" onClick={() => { setIsEditing(true); setShowDetail(false); }} style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                    <Icon name="edit" size={16} />
                                    Rename
                                </button>
                                <button className="btn btn-secondary" onClick={() => { setShowDetail(false); }}>Close</button>
                                <button className="btn btn-secondary" style={{ backgroundColor: 'var(--bf-danger-500)', color: 'white', display: 'flex', alignItems: 'center', gap: '6px' }} onClick={handleDelete}>
                                    <Icon name="delete" size={16} color="white" />
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </>
    );
}

function CommandPalette({ isOpen, onClose, onSelect }) {
    const [query, setQuery] = useState('');
    const [results, setResults] = useState([]);
    const [selectedIndex, setSelectedIndex] = useState(0);
    const inputRef = useRef(null);
    useEffect(() => {
        if (isOpen) {
            inputRef.current?.focus();
            setQuery('');
            setSelectedIndex(0);
        }
    }, [isOpen]);
    useEffect(() => {
        if (!query.trim()) { setResults([]); return; }
        const lowerQuery = query.toLowerCase();
        const allResults = [];
        if (lowerQuery.includes('new') || lowerQuery.includes('create')) {
            allResults.push({ type: 'action', label: 'Create new task', action: () => {
                const title = query.replace(/^(new|create)\s*/i, '');
                if (title.trim()) {
                    StorageService.createTask({ title: title.trim() });
                    Utils.showToast('Task created', 'success');
                }
            }});
        }
        const tasks = StorageService.searchTasks(query);
        tasks.slice(0, 5).forEach(task => {
            allResults.push({ type: 'task', label: task.title, task, action: () => { if (onSelect) onSelect(task); }});
        });
        const projects = StorageService.getProjects();
        projects.filter(p => p.title.toLowerCase().includes(lowerQuery)).slice(0, 3).forEach(project => {
            allResults.push({ type: 'project', label: `Project: ${project.title}`, project, action: () => { window.location.hash = `projects/${project.id}`; }});
        });
        setResults(allResults);
        setSelectedIndex(0);
    }, [query]);
    const handleKeyDown = (e) => {
        if (e.key === 'Escape') onClose();
        else if (e.key === 'ArrowDown') { e.preventDefault(); setSelectedIndex(prev => Math.min(prev + 1, results.length - 1)); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); setSelectedIndex(prev => Math.max(prev - 1, 0)); }
        else if (e.key === 'Enter' && results[selectedIndex]) { e.preventDefault(); results[selectedIndex].action(); onClose(); }
    };
    if (!isOpen) return null;
    return (
        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0, 0, 0, 0.5)', display: 'flex', alignItems: 'flex-start', justifyContent: 'center', paddingTop: '100px', zIndex: 1000 }} onClick={onClose}>
            <div style={{ width: '100%', maxWidth: '600px', backgroundColor: 'var(--bf-bg)', borderRadius: 'var(--bf-radius-lg)', boxShadow: 'var(--bf-shadow-xl)', overflow: 'hidden' }} onClick={(e) => e.stopPropagation()}>
                <input ref={inputRef} type="text" className="input" placeholder="Type to search or create..." value={query} onChange={(e) => setQuery(e.target.value)} onKeyDown={handleKeyDown} style={{ border: 'none', borderBottom: '1px solid var(--bf-surface-200)', borderRadius: 0, padding: '16px', fontSize: 'var(--bf-font-size-lg)' }} />
                {results.length > 0 && (
                    <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                        {results.map((result, index) => (
                            <div key={index} onClick={() => { result.action(); onClose(); }} style={{ padding: '12px 16px', cursor: 'pointer', backgroundColor: index === selectedIndex ? 'var(--bf-surface-100)' : 'transparent', borderLeft: index === selectedIndex ? '3px solid var(--bf-success-500)' : '3px solid transparent' }}>
                                <div style={{ fontWeight: 500 }}>{result.label}</div>
                                {result.type === 'task' && <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)', marginTop: '4px' }}>{Utils.formatDate(result.task.due_at)}</div>}
                            </div>
                        ))}
                    </div>
                )}
                {query && results.length === 0 && <div style={{ padding: '16px', color: 'var(--bf-text-500)', textAlign: 'center' }}>No results found</div>}
            </div>
        </div>
    );
}
    </script>

    <script type="text/babel">
// Blitzfit - Icon Component
function Icon({ name, size = 20, color = 'currentColor', style = {} }) {
    const iconStyle = { width: size, height: size, fill: 'none', stroke: color, strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...style };
    const icons = {
        dashboard: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <rect x="3" y="3" width="7" height="7" rx="1" />
                <rect x="14" y="3" width="7" height="7" rx="1" />
                <rect x="3" y="14" width="7" height="7" rx="1" />
                <rect x="14" y="14" width="7" height="7" rx="1" />
            </svg>
        ),
        inbox: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <path d="M22 12h-4l-3 9H9l-3-9H2" />
                <path d="M7 21h10" />
                <rect x="3" y="3" width="18" height="4" rx="1" />
            </svg>
        ),
        today: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <rect x="3" y="4" width="18" height="18" rx="2" />
                <path d="M16 2v4" />
                <path d="M8 2v4" />
                <path d="M3 10h18" />
                <circle cx="12" cy="16" r="1" />
            </svg>
        ),
        mindmap: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <circle cx="12" cy="12" r="3" />
                <path d="M12 1v6m0 6v6" />
                <path d="M12 7l-4-4m4 4l4-4" />
                <path d="M12 13l-4 4m4-4l4 4" />
                <path d="M1 12h6m6 0h6" />
                <path d="M7 12l-4-4m4 4l-4 4" />
                <path d="M17 12l4-4m-4 4l4 4" />
            </svg>
        ),
        projects: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <path d="M4 7h16" />
                <path d="M4 12h16" />
                <path d="M4 17h16" />
                <rect x="2" y="5" width="20" height="14" rx="1" />
            </svg>
        ),
        calendar: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <rect x="3" y="4" width="18" height="18" rx="2" />
                <path d="M16 2v4" />
                <path d="M8 2v4" />
                <path d="M3 10h18" />
                <path d="M8 14h.01" />
                <path d="M12 14h.01" />
                <path d="M16 14h.01" />
                <path d="M8 18h.01" />
                <path d="M12 18h.01" />
                <path d="M16 18h.01" />
            </svg>
        ),
        habits: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <path d="M12 2L2 7l10 5 10-5-10-5z" />
                <path d="M2 17l10 5 10-5" />
                <path d="M2 12l10 5 10-5" />
            </svg>
        ),
        settings: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <circle cx="12" cy="12" r="3" />
                <path d="M12 1v6m0 6v6" />
                <path d="M21 12h-6m-6 0H3" />
                <path d="M19.07 4.93l-4.24 4.24m0 5.66l4.24 4.24" />
                <path d="M4.93 4.93l4.24 4.24m0 5.66l-4.24 4.24" />
            </svg>
        ),
        theme: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <circle cx="12" cy="12" r="5" />
                <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
            </svg>
        ),
        logout: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                <polyline points="16 17 21 12 16 7" />
                <line x1="21" y1="12" x2="9" y2="12" />
            </svg>
        ),
        edit: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
            </svg>
        ),
        delete: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <polyline points="3 6 5 6 21 6" />
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                <line x1="10" y1="11" x2="10" y2="17" />
                <line x1="14" y1="11" x2="14" y2="17" />
            </svg>
        ),
        lightning: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
            </svg>
        ),
        project: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <path d="M4 7h16" />
                <path d="M4 12h16" />
                <path d="M4 17h16" />
                <rect x="2" y="5" width="20" height="14" rx="1" />
            </svg>
        ),
        close: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
        ),
        remove: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <circle cx="12" cy="12" r="10" />
                <line x1="8" y1="12" x2="16" y2="12" />
            </svg>
        ),
        zoomIn: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <circle cx="11" cy="11" r="8" />
                <path d="M21 21l-4.35-4.35" />
                <line x1="11" y1="8" x2="11" y2="14" />
                <line x1="8" y1="11" x2="14" y2="11" />
            </svg>
        ),
        zoomOut: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <circle cx="11" cy="11" r="8" />
                <path d="M21 21l-4.35-4.35" />
                <line x1="8" y1="11" x2="14" y2="11" />
            </svg>
        ),
        check: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <polyline points="20 6 9 17 4 12" />
            </svg>
        ),
        fire: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z" />
            </svg>
        ),
        todo: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <circle cx="12" cy="12" r="10" fill="none" />
                <line x1="12" y1="8" x2="12" y2="12" />
                <line x1="12" y1="16" x2="12.01" y2="16" />
            </svg>
        ),
        inProgress: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
            </svg>
        ),
        done: (
            <svg viewBox="0 0 24 24" style={iconStyle}>
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <polyline points="22 4 12 14.01 9 11.01" />
            </svg>
        ),
    };
    return icons[name] || null;
}

// Blitzfit - Pages
const { useState, useEffect } = React;

function DashboardPage({ refreshKey }) {
    const [stats, setStats] = useState({ 
        tasks: 0, completed: 0, projects: 0, today: 0, overdue: 0, habits: 0,
        inProgress: 0, highPriority: 0, avgCompletionTime: 0, productivityScore: 0,
        totalExpenses: 0, expensesByCategory: {}, expensesByMonth: [],
        habitStreak: 0, habitCompletionRate: 0, weeklyTrend: 0
    });
    const [expenses, setExpenses] = useState([]);
    const [newExpense, setNewExpense] = useState({ amount: '', category: 'food', subcategory: '', description: '' });
    const [editingExpense, setEditingExpense] = useState(null);
    const [editExpense, setEditExpense] = useState({ amount: '', category: 'food', subcategory: '', description: '' });
    const [expensePeriod, setExpensePeriod] = useState('month'); // 'week', 'month', 'half-year', 'year'
    const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
    const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
    const loadExpenses = () => {
        const allExpenses = StorageService.getExpenses();
        setExpenses(allExpenses.sort((a, b) => new Date(b.date || b.created_at) - new Date(a.date || a.created_at)));
    };
    const loadStats = () => {
        const allTasks = StorageService.getTasks({ archived: false });
        const completed = allTasks.filter(t => t.status === 'done').length;
        const inProgress = allTasks.filter(t => t.status === 'in_progress').length;
        const highPriority = allTasks.filter(t => t.priority === 3).length;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const todayTasks = allTasks.filter(t => {
            if (!t.due_at) return false;
            const dueDate = new Date(t.due_at);
            dueDate.setHours(0, 0, 0, 0);
            return dueDate >= today && dueDate < tomorrow;
        }).length;
        const overdue = allTasks.filter(t => Utils.isOverdue(t.due_at)).length;
        const projects = StorageService.getProjects().filter(p => !p.archived).length;
        const habits = JSON.parse(localStorage.getItem('blitzfit_habits') || '[]');
        
        // Výpočet průměrné doby dokončení (dny mezi vytvořením a dokončením)
        const completedTasks = allTasks.filter(t => t.status === 'done' && t.created_at && t.updated_at);
        let avgCompletionTime = 0;
        if (completedTasks.length > 0) {
            const totalDays = completedTasks.reduce((sum, t) => {
                const created = new Date(t.created_at);
                const updated = new Date(t.updated_at);
                return sum + Math.max(0, (updated - created) / (1000 * 60 * 60 * 24));
            }, 0);
            avgCompletionTime = Math.round(totalDays / completedTasks.length);
        }
        
        // Productivity Score (0-100): kombinace completion rate, habit streaks, a timely completion)
        const completionRate = allTasks.length > 0 ? (completed / allTasks.length) * 100 : 0;
        const habitStreaks = habits.map(h => {
            const dates = Object.keys(h.completed || {}).filter(d => h.completed[d]);
            if (dates.length === 0) return 0;
            dates.sort();
            let streak = 1;
            for (let i = dates.length - 1; i > 0; i--) {
                const d1 = new Date(dates[i]);
                const d2 = new Date(dates[i-1]);
                const diffDays = (d1 - d2) / (1000 * 60 * 60 * 24);
                if (diffDays === 1) streak++;
                else break;
            }
            return streak;
        });
        const avgHabitStreak = habitStreaks.length > 0 ? habitStreaks.reduce((a, b) => a + b, 0) / habitStreaks.length : 0;
        const onTimeRate = allTasks.length > 0 ? ((allTasks.length - overdue) / allTasks.length) * 100 : 100;
        const productivityScore = Math.round((completionRate * 0.5) + (Math.min(avgHabitStreak, 30) / 30 * 100 * 0.3) + (onTimeRate * 0.2));
        
        // Statistiky výdajů podle vybraného období
        const allExpenses = StorageService.getExpenses();
        let filteredExpenses = allExpenses;
        let periodStart, periodEnd;
        const now = new Date();
        
        if (expensePeriod === 'week') {
            // Aktuální týden (pondělí - neděle)
            periodStart = new Date(now);
            const dayOfWeek = periodStart.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Pondělí = 1, neděle = 0
            periodStart.setDate(periodStart.getDate() + diff);
            periodStart.setHours(0, 0, 0, 0);
            periodEnd = new Date(periodStart);
            periodEnd.setDate(periodEnd.getDate() + 6);
            periodEnd.setHours(23, 59, 59);
        } else if (expensePeriod === 'month') {
            periodStart = new Date(selectedYear, selectedMonth, 1);
            periodEnd = new Date(selectedYear, selectedMonth + 1, 0, 23, 59, 59);
        } else if (expensePeriod === 'half-year') {
            // Půlrok: leden-červen (0-5) nebo červenec-prosinec (6-11)
            const halfYearStart = selectedMonth < 6 ? 0 : 6;
            periodStart = new Date(selectedYear, halfYearStart, 1);
            periodEnd = new Date(selectedYear, halfYearStart + 6, 0, 23, 59, 59);
        } else if (expensePeriod === 'year') {
            periodStart = new Date(selectedYear, 0, 1);
            periodEnd = new Date(selectedYear, 11, 31, 23, 59, 59);
        }
        
        filteredExpenses = allExpenses.filter(e => {
            const expenseDate = new Date(e.date || e.created_at);
            return expenseDate >= periodStart && expenseDate <= periodEnd;
        });
        
        const totalExpenses = filteredExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
        const expensesByCategory = {};
        filteredExpenses.forEach(e => {
            const cat = e.category || 'other';
            expensesByCategory[cat] = (expensesByCategory[cat] || 0) + (e.amount || 0);
        });
        
        // Výdaje podle měsíců/tydnů podle období
        const expensesByMonth = [];
        if (expensePeriod === 'week') {
            // Pro týden zobrazíme dny
            for (let i = 0; i < 7; i++) {
                const day = new Date(periodStart);
                day.setDate(day.getDate() + i);
                const dayStart = new Date(day);
                dayStart.setHours(0, 0, 0, 0);
                const dayEnd = new Date(day);
                dayEnd.setHours(23, 59, 59);
                const dayExpenses = filteredExpenses.filter(e => {
                    const expenseDate = new Date(e.date || e.created_at);
                    return expenseDate >= dayStart && expenseDate <= dayEnd;
                });
                const dayTotal = dayExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                expensesByMonth.push({
                    month: day.toLocaleDateString('cs-CZ', { weekday: 'short', day: 'numeric' }),
                    total: dayTotal
                });
            }
        } else if (expensePeriod === 'month') {
            // Pro měsíc zobrazíme týdny
            let weekStart = new Date(periodStart);
            // Najdeme první pondělí v měsíci nebo začátek měsíce
            const firstDayOfWeek = weekStart.getDay();
            if (firstDayOfWeek !== 1) {
                const diff = firstDayOfWeek === 0 ? -6 : 1 - firstDayOfWeek;
                weekStart = new Date(weekStart);
                weekStart.setDate(weekStart.getDate() + diff);
            }
            let weekIndex = 1;
            while (weekStart <= periodEnd) {
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                weekEnd.setHours(23, 59, 59);
                const actualWeekEnd = weekEnd > periodEnd ? periodEnd : weekEnd;
                const weekExpenses = filteredExpenses.filter(e => {
                    const expenseDate = new Date(e.date || e.created_at);
                    return expenseDate >= weekStart && expenseDate <= actualWeekEnd;
                });
                const weekTotal = weekExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                expensesByMonth.push({
                    month: `Týden ${weekIndex}`,
                    total: weekTotal
                });
                weekStart.setDate(weekStart.getDate() + 7);
                weekIndex++;
            }
        } else if (expensePeriod === 'half-year') {
            // Pro půlrok zobrazíme měsíce
            const halfYearStart = selectedMonth < 6 ? 0 : 6;
            for (let i = 0; i < 6; i++) {
                const month = new Date(selectedYear, halfYearStart + i, 1);
                const monthStart = new Date(month.getFullYear(), month.getMonth(), 1);
                const monthEnd = new Date(month.getFullYear(), month.getMonth() + 1, 0);
                const monthExpenses = filteredExpenses.filter(e => {
                    const expenseDate = new Date(e.date || e.created_at);
                    return expenseDate >= monthStart && expenseDate <= monthEnd;
                });
                const monthTotal = monthExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                expensesByMonth.push({
                    month: month.toLocaleDateString('cs-CZ', { month: 'short' }),
                    total: monthTotal
                });
            }
        } else if (expensePeriod === 'year') {
            // Pro rok zobrazíme měsíce
            for (let i = 0; i < 12; i++) {
                const month = new Date(selectedYear, i, 1);
                const monthStart = new Date(month.getFullYear(), month.getMonth(), 1);
                const monthEnd = new Date(month.getFullYear(), month.getMonth() + 1, 0);
                const monthExpenses = filteredExpenses.filter(e => {
                    const expenseDate = new Date(e.date || e.created_at);
                    return expenseDate >= monthStart && expenseDate <= monthEnd;
                });
                const monthTotal = monthExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                expensesByMonth.push({
                    month: month.toLocaleDateString('cs-CZ', { month: 'short' }),
                    total: monthTotal
                });
            }
        }
        
        // Habit statistiky
        const habitStreak = habitStreaks.length > 0 ? Math.max(...habitStreaks) : 0;
        const habitCompletionRate = habits.length > 0 ? (habits.filter(h => {
            const dates = Object.keys(h.completed || {});
            const last30Days = dates.filter(d => {
                const date = new Date(d);
                const daysAgo = (today - date) / (1000 * 60 * 60 * 24);
                return daysAgo <= 30;
            });
            return last30Days.length > 0;
        }).length / habits.length) * 100 : 0;
        
        // Weekly trend (porovnání dokončených úkolů tento týden vs minulý týden)
        const weekAgo = new Date(today);
        weekAgo.setDate(weekAgo.getDate() - 7);
        const thisWeekCompleted = completedTasks.filter(t => {
            const completed = new Date(t.updated_at);
            return completed >= weekAgo && completed <= today;
        }).length;
        const twoWeeksAgo = new Date(today);
        twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
        const lastWeekCompleted = completedTasks.filter(t => {
            const completed = new Date(t.updated_at);
            return completed >= twoWeeksAgo && completed < weekAgo;
        }).length;
        const weeklyTrend = lastWeekCompleted > 0 ? Math.round(((thisWeekCompleted - lastWeekCompleted) / lastWeekCompleted) * 100) : (thisWeekCompleted > 0 ? 100 : 0);
        
        setStats({ 
            tasks: allTasks.length, completed, projects, today: todayTasks, overdue, habits: habits.length,
            inProgress, highPriority, avgCompletionTime, productivityScore,
            totalExpenses, expensesByCategory, expensesByMonth,
            habitStreak, habitCompletionRate, weeklyTrend
        });
    };
    useEffect(() => { loadStats(); loadExpenses(); }, [refreshKey, expensePeriod, selectedMonth, selectedYear]);
    const completionRate = stats.tasks > 0 ? Math.round((stats.completed / stats.tasks) * 100) : 0;
    const handleAddExpense = () => {
        if (!newExpense.amount || parseFloat(newExpense.amount) <= 0) {
            Utils.showToast('Please enter a valid amount', 'error');
            return;
        }
        StorageService.createExpense(newExpense);
        setNewExpense({ amount: '', category: 'food', subcategory: '', description: '' });
        loadExpenses();
        loadStats();
        Utils.showToast('Výdaj přidán', 'success');
    };
    const handleEditExpense = (expense) => {
        setEditingExpense(expense.id);
        setEditExpense({
            amount: expense.amount.toString(),
            category: expense.category || 'food',
            subcategory: expense.subcategory || '',
            description: expense.description || ''
        });
    };
    const handleSaveExpense = () => {
        if (!editExpense.amount || parseFloat(editExpense.amount) <= 0) {
            Utils.showToast('Zadejte platnou částku', 'error');
            return;
        }
        StorageService.updateExpense(editingExpense, editExpense);
        setEditingExpense(null);
        setEditExpense({ amount: '', category: 'food', subcategory: '', description: '' });
        loadExpenses();
        loadStats();
        Utils.showToast('Výdaj upraven', 'success');
    };
    const handleDeleteExpense = (id) => {
        if (confirm('Opravdu chcete smazat tento výdaj?')) {
            StorageService.deleteExpense(id);
            loadExpenses();
            loadStats();
            Utils.showToast('Výdaj smazán', 'success');
        }
    };
    const handleCancelEdit = () => {
        setEditingExpense(null);
        setEditExpense({ amount: '', category: 'food', subcategory: '', description: '' });
    };
    const expenseCategories = ['food', 'transport', 'housing', 'utilities', 'entertainment', 'health', 'shopping', 'other'];
    const foodSubcategories = ['groceries', 'restaurant', 'takeout', 'coffee', 'snacks', 'other'];
    const getCategoryLabel = (cat) => {
        const labels = { food: 'Jídlo', transport: 'Doprava', housing: 'Bydlení', utilities: 'Služby', entertainment: 'Zábava', health: 'Zdraví', shopping: 'Nákupy', other: 'Ostatní' };
        return labels[cat] || cat;
    };
    return (
        <div>
            <h1 style={{ fontSize: 'var(--bf-font-size-2xl)', fontWeight: 700, marginBottom: '24px' }}>Nástěnka</h1>
            
            {/* Main Stats Grid */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px', marginBottom: '24px' }}>
                <div className="card" style={{ background: 'linear-gradient(135deg, var(--bf-primary-500), var(--bf-accent-500))', color: 'white' }}>
                    <div style={{ fontSize: 'var(--bf-font-size-3xl)', fontWeight: 700, marginBottom: '8px' }}>{stats.tasks}</div>
                    <div style={{ fontSize: 'var(--bf-font-size-sm)', opacity: 0.9 }}>Celkem úkolů</div>
                </div>
                <div className="card" style={{ background: 'linear-gradient(135deg, var(--bf-success-500), #65A30D)', color: 'white' }}>
                    <div style={{ fontSize: 'var(--bf-font-size-3xl)', fontWeight: 700, marginBottom: '8px' }}>{stats.completed}</div>
                    <div style={{ fontSize: 'var(--bf-font-size-sm)', opacity: 0.9 }}>Dokončeno</div>
                </div>
                <div className="card" style={{ background: 'linear-gradient(135deg, var(--bf-primary-500), var(--bf-success-500))', color: 'white' }}>
                    <div style={{ fontSize: 'var(--bf-font-size-3xl)', fontWeight: 700, marginBottom: '8px' }}>{completionRate}%</div>
                    <div style={{ fontSize: 'var(--bf-font-size-sm)', opacity: 0.9 }}>Míra dokončení</div>
                </div>
                <div className="card" style={{ background: 'linear-gradient(135deg, #9333EA, #A855F7)', color: 'white' }}>
                    <div style={{ fontSize: 'var(--bf-font-size-3xl)', fontWeight: 700, marginBottom: '8px' }}>{stats.productivityScore}</div>
                    <div style={{ fontSize: 'var(--bf-font-size-sm)', opacity: 0.9 }}>Skóre produktivity</div>
                </div>
                <div className="card">
                    <div style={{ fontSize: 'var(--bf-font-size-3xl)', fontWeight: 700, marginBottom: '8px', color: 'var(--bf-primary-500)' }}>{stats.projects}</div>
                    <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)' }}>Projekty</div>
                </div>
                <div className="card">
                    <div style={{ fontSize: 'var(--bf-font-size-3xl)', fontWeight: 700, marginBottom: '8px', color: stats.today > 0 ? 'var(--bf-warning-500)' : 'var(--bf-text-500)' }}>{stats.today}</div>
                    <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)' }}>Dnes splatné</div>
                </div>
                <div className="card">
                    <div style={{ fontSize: 'var(--bf-font-size-3xl)', fontWeight: 700, marginBottom: '8px', color: stats.overdue > 0 ? 'var(--bf-danger-500)' : 'var(--bf-text-500)' }}>{stats.overdue}</div>
                    <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)' }}>Po termínu</div>
                </div>
                <div className="card">
                    <div style={{ fontSize: 'var(--bf-font-size-3xl)', fontWeight: 700, marginBottom: '8px', color: 'var(--bf-accent-500)' }}>{stats.habits}</div>
                    <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)' }}>Zvyky</div>
                </div>
            </div>

            {/* Advanced Stats Grid */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px', marginBottom: '24px' }}>
                <div className="card">
                    <div style={{ fontSize: 'var(--bf-font-size-2xl)', fontWeight: 700, marginBottom: '8px', color: 'var(--bf-primary-500)' }}>{stats.inProgress}</div>
                    <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)' }}>V průběhu</div>
                </div>
                <div className="card">
                    <div style={{ fontSize: 'var(--bf-font-size-2xl)', fontWeight: 700, marginBottom: '8px', color: 'var(--bf-danger-500)' }}>{stats.highPriority}</div>
                    <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)' }}>Vysoká priorita</div>
                </div>
                <div className="card">
                    <div style={{ fontSize: 'var(--bf-font-size-2xl)', fontWeight: 700, marginBottom: '8px', color: 'var(--bf-text-700)' }}>{stats.avgCompletionTime}</div>
                    <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)' }}>Průměrná doba (dny)</div>
                </div>
                <div className="card">
                    <div style={{ fontSize: 'var(--bf-font-size-2xl)', fontWeight: 700, marginBottom: '8px', color: stats.weeklyTrend >= 0 ? 'var(--bf-success-500)' : 'var(--bf-danger-500)' }}>
                        {stats.weeklyTrend >= 0 ? '+' : ''}{stats.weeklyTrend}%
                    </div>
                    <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)' }}>Týdenní trend</div>
                </div>
                <div className="card">
                    <div style={{ fontSize: 'var(--bf-font-size-2xl)', fontWeight: 700, marginBottom: '8px', color: 'var(--bf-success-500)' }}>{stats.habitStreak}</div>
                    <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)' }}>Nejdelší série</div>
                </div>
                <div className="card">
                    <div style={{ fontSize: 'var(--bf-font-size-2xl)', fontWeight: 700, marginBottom: '8px', color: 'var(--bf-primary-500)' }}>{Math.round(stats.habitCompletionRate)}%</div>
                    <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)' }}>Dokončení zvyků</div>
                </div>
            </div>

            {/* Expenses Section */}
            <div className="card" style={{ marginBottom: '16px' }}>
                <h3 style={{ marginBottom: '16px' }}>Výběr období pro výdaje</h3>
                <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap', alignItems: 'center' }}>
                    <select
                        className="input"
                        value={expensePeriod}
                        onChange={(e) => setExpensePeriod(e.target.value)}
                        style={{ minWidth: '150px' }}
                    >
                        <option value="week">Týden</option>
                        <option value="month">Měsíc</option>
                        <option value="half-year">Půlrok</option>
                        <option value="year">Rok</option>
                    </select>
                    {(expensePeriod === 'month' || expensePeriod === 'half-year' || expensePeriod === 'year') && (
                        <>
                            <select
                                className="input"
                                value={selectedMonth}
                                onChange={(e) => setSelectedMonth(parseInt(e.target.value))}
                                style={{ minWidth: '150px' }}
                            >
                                {Array.from({ length: 12 }, (_, i) => (
                                    <option key={i} value={i}>
                                        {new Date(2000, i, 1).toLocaleDateString('cs-CZ', { month: 'long' })}
                                    </option>
                                ))}
                            </select>
                            <select
                                className="input"
                                value={selectedYear}
                                onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                                style={{ minWidth: '100px' }}
                            >
                                {Array.from({ length: 5 }, (_, i) => {
                                    const year = new Date().getFullYear() - 2 + i;
                                    return <option key={year} value={year}>{year}</option>;
                                })}
                            </select>
                        </>
                    )}
                </div>
            </div>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '16px', marginBottom: '24px' }}>
                <div className="card">
                    <h3 style={{ marginBottom: '16px' }}>Výdaje</h3>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginBottom: '16px' }}>
                        <input
                            type="number"
                            className="input"
                            placeholder="Částka"
                            value={newExpense.amount}
                            onChange={(e) => setNewExpense({ ...newExpense, amount: e.target.value })}
                        />
                        <select
                            className="input"
                            value={newExpense.category}
                            onChange={(e) => setNewExpense({ ...newExpense, category: e.target.value, subcategory: '' })}
                        >
                            {expenseCategories.map(cat => (
                                <option key={cat} value={cat}>{getCategoryLabel(cat)}</option>
                            ))}
                        </select>
                        {newExpense.category === 'food' && (
                            <select
                                className="input"
                                value={newExpense.subcategory}
                                onChange={(e) => setNewExpense({ ...newExpense, subcategory: e.target.value })}
                            >
                                <option value="">Vyberte podkategorii...</option>
                                {foodSubcategories.map(sub => (
                                    <option key={sub} value={sub}>{sub.charAt(0).toUpperCase() + sub.slice(1)}</option>
                                ))}
                            </select>
                        )}
                        <input
                            type="text"
                            className="input"
                            placeholder="Popis (volitelné)"
                            value={newExpense.description}
                            onChange={(e) => setNewExpense({ ...newExpense, description: e.target.value })}
                        />
                        <button className="btn btn-primary" onClick={handleAddExpense}>Přidat výdaj</button>
                    </div>
                    <div style={{ paddingTop: '16px', borderTop: '1px solid var(--bf-surface-200)' }}>
                        <div style={{ fontSize: 'var(--bf-font-size-2xl)', fontWeight: 700, marginBottom: '8px', color: 'var(--bf-primary-500)' }}>
                            {stats.totalExpenses.toFixed(2)} Kč
                        </div>
                        <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)' }}>
                            {expensePeriod === 'week' && 'Výdaje tento týden'}
                            {expensePeriod === 'month' && `Výdaje za ${new Date(selectedYear, selectedMonth, 1).toLocaleDateString('cs-CZ', { month: 'long', year: 'numeric' })}`}
                            {expensePeriod === 'half-year' && `Výdaje za ${selectedMonth < 6 ? '1. ' : '2. '}půlrok ${selectedYear}`}
                            {expensePeriod === 'year' && `Výdaje za rok ${selectedYear}`}
                        </div>
                    </div>
                </div>
                <div className="card">
                    <h3 style={{ marginBottom: '16px' }}>Seznam výdajů</h3>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', maxHeight: '500px', overflowY: 'auto' }}>
                        {expenses.length === 0 ? (
                            <div style={{ textAlign: 'center', padding: '16px', color: 'var(--bf-text-500)' }}>Žádné výdaje</div>
                        ) : (
                            expenses.map(expense => (
                                <div key={expense.id} style={{ padding: '12px', backgroundColor: 'var(--bf-surface-100)', borderRadius: 'var(--bf-radius-sm)', border: editingExpense === expense.id ? '2px solid var(--bf-primary-500)' : '1px solid var(--bf-surface-200)' }}>
                                    {editingExpense === expense.id ? (
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                                                <input
                                                    type="number"
                                                    className="input"
                                                    placeholder="Částka"
                                                    value={editExpense.amount}
                                                    onChange={(e) => setEditExpense({ ...editExpense, amount: e.target.value })}
                                                    style={{ fontSize: 'var(--bf-font-size-sm)' }}
                                                />
                                                <select
                                                    className="input"
                                                    value={editExpense.category}
                                                    onChange={(e) => setEditExpense({ ...editExpense, category: e.target.value, subcategory: '' })}
                                                    style={{ fontSize: 'var(--bf-font-size-sm)' }}
                                                >
                                                    {expenseCategories.map(cat => (
                                                        <option key={cat} value={cat}>{getCategoryLabel(cat)}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            {editExpense.category === 'food' && (
                                                <select
                                                    className="input"
                                                    value={editExpense.subcategory}
                                                    onChange={(e) => setEditExpense({ ...editExpense, subcategory: e.target.value })}
                                                    style={{ fontSize: 'var(--bf-font-size-sm)' }}
                                                >
                                                    <option value="">Vyberte podkategorii...</option>
                                                    {foodSubcategories.map(sub => (
                                                        <option key={sub} value={sub}>{sub.charAt(0).toUpperCase() + sub.slice(1)}</option>
                                                    ))}
                                                </select>
                                            )}
                                            <input
                                                type="text"
                                                className="input"
                                                placeholder="Popis (volitelné)"
                                                value={editExpense.description}
                                                onChange={(e) => setEditExpense({ ...editExpense, description: e.target.value })}
                                                style={{ fontSize: 'var(--bf-font-size-sm)' }}
                                            />
                                            <div style={{ display: 'flex', gap: '8px' }}>
                                                <button className="btn btn-primary" onClick={handleSaveExpense} style={{ flex: 1, fontSize: 'var(--bf-font-size-sm)', padding: '6px 12px' }}>Uložit</button>
                                                <button className="btn btn-secondary" onClick={handleCancelEdit} style={{ flex: 1, fontSize: 'var(--bf-font-size-sm)', padding: '6px 12px' }}>Zrušit</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: '12px' }}>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                                                    <span style={{ fontSize: 'var(--bf-font-size-base)', fontWeight: 600, color: 'var(--bf-text-900)' }}>
                                                        {expense.amount.toFixed(2)} Kč
                                                    </span>
                                                    <span style={{ fontSize: 'var(--bf-font-size-xs)', color: 'var(--bf-text-500)', backgroundColor: 'var(--bf-surface-200)', padding: '2px 8px', borderRadius: 'var(--bf-radius-sm)' }}>
                                                        {getCategoryLabel(expense.category)}
                                                    </span>
                                                    {expense.subcategory && (
                                                        <span style={{ fontSize: 'var(--bf-font-size-xs)', color: 'var(--bf-text-500)' }}>
                                                            • {expense.subcategory}
                                                        </span>
                                                    )}
                                                </div>
                                                {expense.description && (
                                                    <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)', marginBottom: '4px' }}>
                                                        {expense.description}
                                                    </div>
                                                )}
                                                <div style={{ fontSize: 'var(--bf-font-size-xs)', color: 'var(--bf-text-500)' }}>
                                                    {Utils.formatDate(expense.date || expense.created_at) || new Date(expense.date || expense.created_at).toLocaleDateString('cs-CZ')}
                                                </div>
                                            </div>
                                            <div style={{ display: 'flex', gap: '4px' }}>
                                                <button
                                                    onClick={() => handleEditExpense(expense)}
                                                    style={{ padding: '6px 10px', backgroundColor: 'var(--bf-primary-500)', color: 'white', border: 'none', borderRadius: 'var(--bf-radius-sm)', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                                                    title="Upravit"
                                                >
                                                    <Icon name="edit" size={14} color="white" />
                                                </button>
                                                <button
                                                    onClick={() => handleDeleteExpense(expense.id)}
                                                    style={{ padding: '6px 10px', backgroundColor: 'var(--bf-danger-500)', color: 'white', border: 'none', borderRadius: 'var(--bf-radius-sm)', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                                                    title="Smazat"
                                                >
                                                    <Icon name="delete" size={14} color="white" />
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))
                        )}
                    </div>
                </div>
                <div className="card">
                    <h3 style={{ marginBottom: '16px' }}>Výdaje podle kategorií</h3>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {Object.entries(stats.expensesByCategory).sort((a, b) => b[1] - a[1]).map(([cat, amount]) => {
                            const percentage = stats.totalExpenses > 0 ? (amount / stats.totalExpenses) * 100 : 0;
                            return (
                                <div key={cat}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px', fontSize: 'var(--bf-font-size-sm)' }}>
                                        <span>{getCategoryLabel(cat)}</span>
                                        <span style={{ fontWeight: 500 }}>{amount.toFixed(2)} Kč ({Math.round(percentage)}%)</span>
                                    </div>
                                    <div style={{ width: '100%', height: '6px', backgroundColor: 'var(--bf-surface-200)', borderRadius: 'var(--bf-radius-sm)', overflow: 'hidden' }}>
                                        <div style={{ width: `${percentage}%`, height: '100%', backgroundColor: 'var(--bf-primary-500)', transition: 'width 0.3s ease' }} />
                                    </div>
                                </div>
                            );
                        })}
                        {Object.keys(stats.expensesByCategory).length === 0 && (
                            <div style={{ textAlign: 'center', padding: '16px', color: 'var(--bf-text-500)' }}>Žádné výdaje</div>
                        )}
                    </div>
                </div>
            </div>

            {/* Monthly Expenses Chart */}
            {stats.expensesByMonth.length > 0 && (
                <div className="card" style={{ marginBottom: '24px' }}>
                    <h3 style={{ marginBottom: '16px' }}>
                        {expensePeriod === 'week' && 'Výdaje podle dnů'}
                        {expensePeriod === 'month' && 'Výdaje podle týdnů'}
                        {(expensePeriod === 'half-year' || expensePeriod === 'year') && 'Výdaje podle měsíců'}
                    </h3>
                    <div style={{ display: 'flex', alignItems: 'flex-end', gap: '8px', height: '200px' }}>
                        {stats.expensesByMonth.map((month, index) => {
                            const maxExpense = Math.max(...stats.expensesByMonth.map(m => m.total), 1);
                            const height = (month.total / maxExpense) * 100;
                            return (
                                <div key={index} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '8px' }}>
                                    <div style={{ width: '100%', height: `${height}%`, backgroundColor: 'var(--bf-primary-500)', borderRadius: 'var(--bf-radius-sm) 4px 4px var(--bf-radius-sm)', minHeight: '4px' }} />
                                    <div style={{ fontSize: 'var(--bf-font-size-xs)', color: 'var(--bf-text-500)', textAlign: 'center' }}>
                                        {month.month}
                                        <div style={{ fontWeight: 500, marginTop: '4px' }}>{month.total.toFixed(0)} Kč</div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            )}

            {/* Recent Tasks and Projects */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '16px' }}>
                <div className="card">
                    <h3 style={{ marginBottom: '12px' }}>Nedávné úkoly</h3>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {StorageService.getTasks({ archived: false }).slice(0, 5).map(task => (
                            <div key={task.id} style={{ padding: '8px', backgroundColor: 'var(--bf-surface-100)', borderRadius: 'var(--bf-radius-sm)', fontSize: 'var(--bf-font-size-sm)' }}>
                                {task.title}
                            </div>
                        ))}
                    </div>
                </div>
                <div className="card">
                    <h3 style={{ marginBottom: '12px' }}>Aktivní projekty</h3>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {StorageService.getProjects().filter(p => !p.archived).slice(0, 5).map(project => {
                            const projectTasks = StorageService.getTasks({ archived: false }).filter(t => t.project_id === project.id);
                            const completed = projectTasks.filter(t => t.status === 'done').length;
                            const progress = projectTasks.length > 0 ? (completed / projectTasks.length) * 100 : 0;
                            return (
                                <div key={project.id} style={{ padding: '8px', backgroundColor: 'var(--bf-surface-100)', borderRadius: 'var(--bf-radius-sm)' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px', fontSize: 'var(--bf-font-size-sm)', gap: '8px' }}>
                                        <span style={{ fontWeight: 500, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', flex: 1, minWidth: 0 }}>{project.title}</span>
                                        <span style={{ color: 'var(--bf-text-500)', flexShrink: 0 }}>{Math.round(progress)}%</span>
                                    </div>
                                    <div style={{ width: '100%', height: '4px', backgroundColor: 'var(--bf-surface-200)', borderRadius: 'var(--bf-radius-sm)', overflow: 'hidden' }}>
                                        <div style={{ width: `${progress}%`, height: '100%', backgroundColor: 'var(--bf-success-500)', transition: 'width 0.3s ease' }} />
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>
        </div>
    );
}

function InboxPage({ refreshKey }) {
    const [tasks, setTasks] = useState([]);
    const { refresh } = useRefresh();
    useEffect(() => { loadTasks(); }, [refreshKey]);
    const loadTasks = () => {
        const allTasks = StorageService.getTasks({ archived: false });
        const inboxTasks = allTasks.filter(t => !t.project_id || t.project_id === null);
        setTasks(inboxTasks);
    };
    return (
        <div>
            <h1 style={{ fontSize: 'var(--bf-font-size-2xl)', fontWeight: 700, marginBottom: '24px' }}>Inbox</h1>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                {tasks.map(task => <TaskCard key={task.id} task={task} onUpdate={loadTasks} />)}
                {tasks.length === 0 && <div style={{ textAlign: 'center', padding: '48px', color: 'var(--bf-text-500)' }}>No tasks in inbox. Start capturing!</div>}
            </div>
        </div>
    );
}

function TodayPage({ refreshKey }) {
    const [tasks, setTasks] = useState([]);
    useEffect(() => { loadTasks(); }, [refreshKey]);
    const loadTasks = () => {
        const allTasks = StorageService.getTasks({ archived: false });
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const todayTasks = allTasks.filter(t => {
            if (!t.due_at) return false;
            const dueDate = new Date(t.due_at);
            dueDate.setHours(0, 0, 0, 0);
            return dueDate >= today && dueDate < tomorrow;
        });
        const highPriority = allTasks.filter(t => t.priority === 3 && (!t.due_at || new Date(t.due_at) >= today));
        const combined = [...todayTasks];
        highPriority.forEach(t => {
            if (!combined.find(tt => tt.id === t.id)) {
                combined.push(t);
            }
        });
        setTasks(combined);
    };
    return (
        <div>
            <h1 style={{ fontSize: 'var(--bf-font-size-2xl)', fontWeight: 700, marginBottom: '24px' }}>Today</h1>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                {tasks.map(task => <TaskCard key={task.id} task={task} onUpdate={loadTasks} />)}
                {tasks.length === 0 && <div style={{ textAlign: 'center', padding: '48px', color: 'var(--bf-text-500)' }}>No tasks for today</div>}
            </div>
        </div>
    );
}

function ProjectsPage({ refreshKey }) {
    const [projects, setProjects] = useState([]);
    const [tasks, setTasks] = useState([]);
    const [selectedProject, setSelectedProject] = useState(null);
    useEffect(() => { loadData(); }, [refreshKey]);
    const loadData = () => {
        const allProjects = StorageService.getProjects().filter(p => !p.archived);
        const allTasks = StorageService.getTasks({ archived: false });
        setProjects(allProjects);
        setTasks(allTasks);
    };
    if (selectedProject) {
        const projectTasks = tasks.filter(t => t.project_id === selectedProject.id);
        return (
            <div>
                <button className="btn btn-secondary" onClick={() => setSelectedProject(null)} style={{ marginBottom: '16px' }}>← Back to Projects</button>
                <h1 style={{ 
                    fontSize: 'var(--bf-font-size-2xl)', 
                    fontWeight: 700, 
                    marginBottom: '24px',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap',
                    maxWidth: '100%'
                }}>{selectedProject.title}</h1>
                {selectedProject.description && <p style={{ marginBottom: '24px', color: 'var(--bf-text-700)' }}>{selectedProject.description}</p>}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                    {projectTasks.map(task => <TaskCard key={task.id} task={task} onUpdate={loadData} />)}
                    {projectTasks.length === 0 && <div style={{ textAlign: 'center', padding: '48px', color: 'var(--bf-text-500)' }}>No tasks in this project</div>}
                </div>
            </div>
        );
    }
    return (
        <div>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                <h1 style={{ fontSize: 'var(--bf-font-size-2xl)', fontWeight: 700 }}>Projects</h1>
                <button className="btn btn-primary" onClick={() => {
                    const title = prompt('Project name:');
                    if (title) {
                        StorageService.createProject({ title });
                        loadData();
                    }
                }}>+ New Project</button>
            </div>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '16px' }}>
                {projects.map(project => {
                    const projectTasks = tasks.filter(t => t.project_id === project.id);
                    return (
                        <div key={project.id} className="card" onClick={() => setSelectedProject(project)} style={{ cursor: 'pointer' }}>
                            <h3 style={{ 
                                marginBottom: '8px', 
                                overflow: 'hidden', 
                                textOverflow: 'ellipsis', 
                                whiteSpace: 'nowrap',
                                maxWidth: '100%'
                            }}>{project.title}</h3>
                            {project.description && (
                                <p style={{ 
                                    fontSize: 'var(--bf-font-size-sm)', 
                                    color: 'var(--bf-text-700)', 
                                    marginBottom: '12px',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis',
                                    display: '-webkit-box',
                                    WebkitLineClamp: 3,
                                    WebkitBoxOrient: 'vertical',
                                    wordBreak: 'break-word'
                                }}>{project.description}</p>
                            )}
                            <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)' }}>{projectTasks.length} task{projectTasks.length !== 1 ? 's' : ''}</div>
                        </div>
                    );
                })}
                {projects.length === 0 && <div style={{ gridColumn: '1 / -1', textAlign: 'center', padding: '48px', color: 'var(--bf-text-500)' }}>No projects yet. Create your first project!</div>}
            </div>
        </div>
    );
}

function CalendarPage() {
    const [currentDate, setCurrentDate] = useState(new Date());
    const [tasks, setTasks] = useState([]);
    const [selectedDate, setSelectedDate] = useState(null);
    const { refresh } = useRefresh();
    useEffect(() => { loadTasks(); }, [currentDate]);
    const loadTasks = () => {
        const allTasks = StorageService.getTasks({ archived: false });
        setTasks(allTasks);
    };
    const getDaysInMonth = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        const days = [];
        for (let i = 0; i < startingDayOfWeek; i++) {
            days.push(null);
        }
        for (let i = 1; i <= daysInMonth; i++) {
            days.push(new Date(year, month, i));
        }
        return days;
    };
    const getTasksForDate = (date) => {
        if (!date) return [];
        const dateStr = date.toISOString().split('T')[0];
        return tasks.filter(t => {
            if (!t.due_at) return false;
            const taskDate = new Date(t.due_at).toISOString().split('T')[0];
            return taskDate === dateStr;
        });
    };
    const navigateMonth = (direction) => {
        setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + direction, 1));
    };
    const days = getDaysInMonth(currentDate);
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    return (
        <div>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                <h1 style={{ fontSize: 'var(--bf-font-size-2xl)', fontWeight: 700 }}>Calendar</h1>
                <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <button className="btn btn-secondary" onClick={() => navigateMonth(-1)}>←</button>
                    <span style={{ fontSize: 'var(--bf-font-size-lg)', fontWeight: 600, minWidth: '200px', textAlign: 'center' }}>
                        {monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}
                    </span>
                    <button className="btn btn-secondary" onClick={() => navigateMonth(1)}>→</button>
                    <button className="btn btn-secondary" onClick={() => setCurrentDate(new Date())}>Today</button>
                </div>
            </div>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '8px', marginBottom: '24px' }}>
                {dayNames.map(day => (
                    <div key={day} style={{ padding: '12px', textAlign: 'center', fontWeight: 600, color: 'var(--bf-text-700)', fontSize: 'var(--bf-font-size-sm)' }}>
                        {day}
                    </div>
                ))}
                {days.map((date, index) => {
                    const dateTasks = date ? getTasksForDate(date) : [];
                    const isToday = date && date.toDateString() === new Date().toDateString();
                    const isSelected = date && selectedDate && date.toDateString() === selectedDate.toDateString();
                    return (
                        <div
                            key={index}
                            onClick={() => date && setSelectedDate(date)}
                            style={{
                                minHeight: '100px',
                                padding: '8px',
                                backgroundColor: isSelected ? 'var(--bf-primary-500)' : isToday ? 'rgba(147, 51, 234, 0.1)' : 'var(--bf-surface-100)',
                                border: `1px solid ${isSelected ? 'var(--bf-primary-500)' : isToday ? 'var(--bf-primary-500)' : 'var(--bf-surface-200)'}`,
                                borderRadius: 'var(--bf-radius-md)',
                                cursor: date ? 'pointer' : 'default',
                                transition: 'all var(--bf-transition-base)',
                            }}
                        >
                            {date && (
                                <>
                                    <div style={{ fontWeight: isToday ? 700 : 500, color: isSelected ? 'white' : 'var(--bf-text-900)', marginBottom: '4px' }}>
                                        {date.getDate()}
                                    </div>
                                    {dateTasks.length > 0 && (
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                                            {dateTasks.slice(0, 3).map(task => (
                                                <div
                                                    key={task.id}
                                                    style={{
                                                        fontSize: 'var(--bf-font-size-xs)',
                                                        padding: '2px 4px',
                                                        backgroundColor: isSelected ? 'rgba(255,255,255,0.2)' : task.priority === 3 ? 'var(--bf-success-500)' : 'var(--bf-primary-500)',
                                                        color: 'white',
                                                        borderRadius: 'var(--bf-radius-sm)',
                                                        overflow: 'hidden',
                                                        textOverflow: 'ellipsis',
                                                        whiteSpace: 'nowrap',
                                                    }}
                                                    title={task.title}
                                                >
                                                    {task.title}
                                                </div>
                                            ))}
                                            {dateTasks.length > 3 && (
                                                <div style={{ fontSize: 'var(--bf-font-size-xs)', color: isSelected ? 'white' : 'var(--bf-text-500)', textAlign: 'center' }}>
                                                    +{dateTasks.length - 3} more
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    );
                })}
            </div>
            {selectedDate && (
                <div className="card" style={{ marginTop: '24px' }}>
                    <h3 style={{ marginBottom: '16px' }}>Tasks for {Utils.formatDate(selectedDate.toISOString())}</h3>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                        {getTasksForDate(selectedDate).map(task => <TaskCard key={task.id} task={task} onUpdate={loadTasks} />)}
                        {getTasksForDate(selectedDate).length === 0 && (
                            <div style={{ textAlign: 'center', padding: '24px', color: 'var(--bf-text-500)' }}>No tasks for this date</div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
}

function MindMapPage({ refreshKey }) {
    const [projects, setProjects] = useState([]);
    const [tasks, setTasks] = useState([]);
    const [selectedProject, setSelectedProject] = useState(null);
    const [viewMode, setViewMode] = useState('3d'); // '3d' or '2d'
    const [viewScope, setViewScope] = useState('all'); // 'all' or 'single'
    const [camera, setCamera] = useState({ x: 0, y: 0, zoom: 1 });
    const [dragging, setDragging] = useState(null); // null, 'camera', 'project', 'task', 'resize-project', 'resize-task', 'select'
    const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
    const [positions, setPositions] = useState({});
    const [blockSizes, setBlockSizes] = useState({}); // { projects: { id: { width, height } }, tasks: { id: { width, height } } }
    const [selectionBox, setSelectionBox] = useState(null); // { x1, y1, x2, y2 }
    const [selectedItems, setSelectedItems] = useState({ projects: new Set(), tasks: new Set() });
    const [movingSelected, setMovingSelected] = useState(false); // true when moving selected tasks
    const [moveOffset, setMoveOffset] = useState({ x: 0, y: 0 }); // offset for moving selected tasks
    const [contextMenu, setContextMenu] = useState(null); // { x, y, type: 'project'|'task', id, status? }
    const containerRef = React.useRef(null);
    const wasDraggingRef = React.useRef(false); // Track if we were dragging
    useEffect(() => { loadData(); }, [refreshKey]);
    const loadData = () => {
        let allProjects = StorageService.getProjects().filter(p => !p.archived);
        if (viewScope === 'single' && selectedProject) {
            allProjects = allProjects.filter(p => p.id === selectedProject.id);
        }
        const allTasks = StorageService.getTasks({ archived: false });
        setProjects(allProjects);
        setTasks(allTasks);
        const savedPositions = StorageService.getMindMapPositions();
        setPositions(savedPositions);
        const savedSizes = StorageService.getMindMapSizes();
        setBlockSizes(savedSizes || { projects: {}, tasks: {} });
    };
    useEffect(() => { loadData(); }, [viewScope, selectedProject, refreshKey]);
    const handleBackgroundMouseDown = (e) => {
        if (e.target === containerRef.current || e.target.tagName === 'svg' || e.target.tagName === 'line') {
            if (e.button === 0) {
                wasDraggingRef.current = false; // Reset drag tracking
                // Start box selection on drag (left button), Shift+Drag = pan camera
                if (e.shiftKey) {
                    // Shift+Drag = pan camera
                    setDragging('camera');
                    setDragStart({ x: e.clientX - camera.x, y: e.clientY - camera.y });
                } else {
                    // Normal drag = box selection
                    // Don't cancel selection here - it will be cancelled on click (not drag)
                    const rect = containerRef.current.getBoundingClientRect();
                    setDragging('select');
                    setDragStart({ x: e.clientX - rect.left, y: e.clientY - rect.top });
                    setSelectionBox({ x1: e.clientX - rect.left, y1: e.clientY - rect.top, x2: e.clientX - rect.left, y2: e.clientY - rect.top });
                }
            } else if (e.button === 1) {
                // Middle mouse button = pan camera
                e.preventDefault();
                wasDraggingRef.current = false;
                setDragging('camera');
                setDragStart({ x: e.clientX - camera.x, y: e.clientY - camera.y });
            }
        }
    };
    const handleContainerClick = (e) => {
        // Cancel selection only on click (not drag) - check if it was a click, not a drag
        // If we were dragging, don't cancel selection
        if (wasDraggingRef.current) {
            return; // Don't cancel if we were dragging
        }
        
        // Cancel selection if clicking on background (not on task or project)
        // Check if click was on a task or project element
        const clickedElement = e.target;
        const isTaskOrProject = clickedElement.closest('[data-task-id]') || clickedElement.closest('[data-project-id]');
        
        if (!isTaskOrProject && (e.target === containerRef.current || e.target.tagName === 'svg' || e.target.tagName === 'line')) {
            if (selectedItems.tasks.size > 0 || selectedItems.projects.size > 0) {
                setSelectedItems({ projects: new Set(), tasks: new Set() });
            }
        }
    };
    const handleMouseMove = (e) => {
        // Mark that we're dragging if mouse moved
        if (dragging) {
            wasDraggingRef.current = true;
        }
        if (dragging === 'camera') {
            setCamera({
                x: e.clientX - dragStart.x,
                y: e.clientY - dragStart.y,
                zoom: camera.zoom
            });
        } else if (dragging === 'select') {
            const rect = containerRef.current.getBoundingClientRect();
            setSelectionBox({
                x1: dragStart.x,
                y1: dragStart.y,
                x2: e.clientX - rect.left,
                y2: e.clientY - rect.top
            });
            // Update selected items based on selection box
            const box = {
                x1: Math.min(dragStart.x, e.clientX - rect.left),
                y1: Math.min(dragStart.y, e.clientY - rect.top),
                x2: Math.max(dragStart.x, e.clientX - rect.left),
                y2: Math.max(dragStart.y, e.clientY - rect.top)
            };
            const newSelected = { projects: new Set(), tasks: new Set() };
            // Check projects
            projects.forEach(project => {
                const projectElement = containerRef.current?.querySelector(`[data-project-id="${project.id}"]`);
                if (projectElement) {
                    const projectRect = projectElement.getBoundingClientRect();
                    const containerRect = containerRef.current.getBoundingClientRect();
                    const projectX = projectRect.left - containerRect.left;
                    const projectY = projectRect.top - containerRect.top;
                    const projectW = projectRect.width;
                    const projectH = projectRect.height;
                    if (projectX < box.x2 && projectX + projectW > box.x1 && projectY < box.y2 && projectY + projectH > box.y1) {
                        newSelected.projects.add(project.id);
                    }
                }
            });
            // Check tasks
            tasks.forEach(task => {
                const taskElement = containerRef.current?.querySelector(`[data-task-id="${task.id}"]`);
                if (taskElement) {
                    const taskRect = taskElement.getBoundingClientRect();
                    const containerRect = containerRef.current.getBoundingClientRect();
                    const taskX = taskRect.left - containerRect.left;
                    const taskY = taskRect.top - containerRect.top;
                    const taskW = taskRect.width;
                    const taskH = taskRect.height;
                    if (taskX < box.x2 && taskX + taskW > box.x1 && taskY < box.y2 && taskY + taskH > box.y1) {
                        newSelected.tasks.add(task.id);
                    }
                }
            });
            setSelectedItems(newSelected);
        } else if (dragging && dragging.startsWith('resize-project-')) {
            const projectId = dragging.replace('resize-project-', '');
            const projectElement = containerRef.current?.querySelector(`[data-project-id="${projectId}"]`);
            if (projectElement) {
                const projectRect = projectElement.getBoundingClientRect();
                const containerRect = containerRef.current.getBoundingClientRect();
                const mouseX = e.clientX - containerRect.left;
                const mouseY = e.clientY - containerRect.top;
                const projectCenterX = projectRect.left - containerRect.left + projectRect.width / 2;
                const projectCenterY = projectRect.top - containerRect.top + projectRect.height / 2;
                const newWidth = Math.max(200, Math.abs(mouseX - projectCenterX) * 2 / camera.zoom);
                const newHeight = Math.max(150, Math.abs(mouseY - projectCenterY) * 2 / camera.zoom);
                const newSizes = { ...blockSizes };
                if (!newSizes.projects) newSizes.projects = {};
                newSizes.projects[projectId] = { width: newWidth, height: newHeight };
                setBlockSizes(newSizes);
                StorageService.saveMindMapSize(projectId, 'projects', newWidth, newHeight);
            }
        } else if (dragging && dragging.startsWith('resize-task-')) {
            const taskId = dragging.replace('resize-task-', '').split('-')[0];
            const taskElement = containerRef.current?.querySelector(`[data-task-id="${taskId}"]`);
            if (taskElement) {
                const taskRect = taskElement.getBoundingClientRect();
                const containerRect = containerRef.current.getBoundingClientRect();
                const mouseX = e.clientX - containerRect.left;
                const mouseY = e.clientY - containerRect.top;
                const taskCenterX = taskRect.left - containerRect.left + taskRect.width / 2;
                const taskCenterY = taskRect.top - containerRect.top + taskRect.height / 2;
                const newWidth = Math.max(100, Math.abs(mouseX - taskCenterX) * 2 / camera.zoom);
                const newHeight = Math.max(60, Math.abs(mouseY - taskCenterY) * 2 / camera.zoom);
                const newSizes = { ...blockSizes };
                if (!newSizes.tasks) newSizes.tasks = {};
                newSizes.tasks[taskId] = { width: newWidth, height: newHeight };
                setBlockSizes(newSizes);
                StorageService.saveMindMapSize(taskId, 'tasks', newWidth, newHeight);
            }
        } else if (dragging && dragging.startsWith('project-')) {
            const projectId = dragging.replace('project-', '');
            const rect = containerRef.current.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            // Current mouse position in transformed space
            const mouseX = (e.clientX - rect.left - centerX - camera.x) / camera.zoom;
            const mouseY = (e.clientY - rect.top - centerY - camera.y) / camera.zoom;
            // New position = mouse position - offset
            const x = mouseX - dragStart.x;
            const y = mouseY - dragStart.y;
            const newPositions = { ...positions };
            if (!newPositions.projects) newPositions.projects = {};
            newPositions.projects[projectId] = { x, y };
            setPositions(newPositions);
            StorageService.saveMindMapPosition(projectId, 'projects', x, y);
        } else if (dragging === 'move-selected-tasks') {
            // Calculate current mouse position in transformed space
            const rect = containerRef.current.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const currentX = (e.clientX - rect.left - centerX - camera.x) / camera.zoom;
            const currentY = (e.clientY - rect.top - centerY - camera.y) / camera.zoom;
            // Calculate offset accounting for initial drag offset
            const offsetX = currentX - dragStart.x;
            const offsetY = currentY - dragStart.y;
            setMoveOffset({ x: offsetX, y: offsetY });
        } else if (dragging && dragging.startsWith('task-') && !dragging.startsWith('task-resize-')) {
            const [taskId, projectId] = dragging.replace('task-', '').split('-');
            const rect = containerRef.current.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            // Current mouse position in transformed space
            const mouseX = (e.clientX - rect.left - centerX - camera.x) / camera.zoom;
            const mouseY = (e.clientY - rect.top - centerY - camera.y) / camera.zoom;
            // New position = mouse position - offset
            const x = mouseX - dragStart.x;
            const y = mouseY - dragStart.y;
            const newPositions = { ...positions };
            if (!newPositions.tasks) newPositions.tasks = {};
            newPositions.tasks[taskId] = { x, y, projectId };
            setPositions(newPositions);
            StorageService.saveMindMapPosition(taskId, 'tasks', x, y);
        }
    };
    const handleMouseUp = () => {
        const wasDragging = dragging;
        if (wasDragging === 'select') {
            // Keep selection, just hide the selection box
            setSelectionBox(null);
            // Selection is already saved in selectedItems, so we keep it
            // Keep wasDraggingRef.current true so click handler knows it was a drag
        } else if (wasDragging === 'move-selected-tasks') {
            // Apply the move offset to all selected tasks
            const newPositions = { ...positions };
            if (!newPositions.tasks) newPositions.tasks = {};
            selectedItems.tasks.forEach(taskId => {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    // Get base position (without move offset)
                    const basePos = positions.tasks?.[taskId];
                    let currentPos;
                    if (basePos) {
                        currentPos = { x: basePos.x, y: basePos.y };
                    } else {
                        const projectPos = getProjectPosition(
                            projects.find(p => p.id === task.project_id),
                            projects.findIndex(p => p.id === task.project_id),
                            projects.length
                        );
                        const mainTasks = getMainTasks(task.project_id);
                        const taskIndex = mainTasks.findIndex(t => t.id === taskId);
                        currentPos = getTaskPosition(task, taskIndex, mainTasks.length, projectPos);
                        // Remove move offset from calculation
                        if (selectedItems.tasks.has(task.id) && movingSelected) {
                            currentPos = { x: currentPos.x - moveOffset.x, y: currentPos.y - moveOffset.y };
                        }
                    }
                    newPositions.tasks[taskId] = {
                        x: currentPos.x + moveOffset.x,
                        y: currentPos.y + moveOffset.y,
                        projectId: task.project_id
                    };
                    StorageService.saveMindMapPosition(taskId, 'tasks', newPositions.tasks[taskId].x, newPositions.tasks[taskId].y);
                }
            });
            setPositions(newPositions);
            setMoveOffset({ x: 0, y: 0 });
            setMovingSelected(false);
            loadData();
        }
        setDragging(null);
        setMovingSelected(false);
        // Reset drag tracking after a short delay to allow click handler to check
        setTimeout(() => {
            wasDraggingRef.current = false;
        }, 100);
        // Only toggle selection if we weren't dragging
        if (!wasDragging || wasDragging === 'camera' || wasDragging === 'select' || wasDragging === 'move-selected-tasks') {
            return;
        }
    };
    const handleWheel = (e) => {
        e.preventDefault();
        // Wheel = zoom in/out
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        setCamera({
            ...camera,
            zoom: Math.max(0.3, Math.min(2, camera.zoom * delta))
        });
    };
    useEffect(() => {
        const container = containerRef.current;
        if (container) {
            container.addEventListener('wheel', handleWheel, { passive: false });
            // Prevent default middle mouse button behavior (scroll)
            container.addEventListener('mousedown', (e) => {
                if (e.button === 1) {
                    e.preventDefault();
                }
            });
            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('mouseup', handleMouseUp);
            return () => {
                container.removeEventListener('wheel', handleWheel);
                window.removeEventListener('mousemove', handleMouseMove);
                window.removeEventListener('mouseup', handleMouseUp);
            };
        }
    }, [dragging, camera, positions, moveOffset, movingSelected]);
    const getElementCenter = (element) => {
        if (!element) return { x: 0, y: 0 };
        const rect = element.getBoundingClientRect();
        const containerRect = containerRef.current?.getBoundingClientRect();
        if (!containerRect) return { x: 0, y: 0 };
        return {
            x: rect.left + rect.width / 2 - containerRect.left,
            y: rect.top + rect.height / 2 - containerRect.top
        };
    };
    useEffect(() => {
        let animationFrameId;
        let lastUpdateTime = performance.now();
        
        const updateLines = (currentTime) => {
            const svg = containerRef.current?.querySelector('svg');
            if (!svg) {
                animationFrameId = requestAnimationFrame(updateLines);
                return;
            }
            
            // Dynamic FPS: 60 FPS when dragging, 30 FPS when idle
            const targetFPS = dragging ? 60 : 30;
            const frameInterval = 1000 / targetFPS;
            
            // Throttle updates when not dragging for better performance
            const elapsed = currentTime - lastUpdateTime;
            if (elapsed < frameInterval) {
                animationFrameId = requestAnimationFrame(updateLines);
                return;
            }
            lastUpdateTime = currentTime;
            
            const rect = containerRef.current.getBoundingClientRect();
            
            // Aktualizace čar mezi projekty - použijeme skutečné pozice z DOM
            projects.forEach((project) => {
                if (project.parent_project_id) {
                    const parentProject = projects.find(p => p.id === project.parent_project_id);
                    if (parentProject) {
                        const projectElement = containerRef.current?.querySelector(`[data-project-id="${project.id}"]`);
                        const parentElement = containerRef.current?.querySelector(`[data-project-id="${parentProject.id}"]`);
                        if (projectElement && parentElement) {
                            const projectRect = projectElement.getBoundingClientRect();
                            const parentRect = parentElement.getBoundingClientRect();
                            const projectX = projectRect.left + projectRect.width / 2 - rect.left;
                            const projectY = projectRect.top + projectRect.height / 2 - rect.top;
                            const parentX = parentRect.left + parentRect.width / 2 - rect.left;
                            const parentY = parentRect.top + parentRect.height / 2 - rect.top;
                            const line = svg.querySelector(`#line-project-${parentProject.id}-to-${project.id}`);
                            if (line) {
                                line.setAttribute('x1', parentX);
                                line.setAttribute('y1', parentY);
                                line.setAttribute('x2', projectX);
                                line.setAttribute('y2', projectY);
                            }
                        }
                    }
                }
            });
            
            // Aktualizace čar z projektů na tasky - použijeme skutečné pozice z DOM
            projects.forEach((project) => {
                const projectElement = containerRef.current?.querySelector(`[data-project-id="${project.id}"]`);
                if (!projectElement) return;
                // Use getBoundingClientRect for accurate position, but ensure element is in DOM
                const projectRect = projectElement.getBoundingClientRect();
                if (projectRect.width === 0 || projectRect.height === 0) return; // Element not visible
                const projectX = projectRect.left + projectRect.width / 2 - rect.left;
                const projectY = projectRect.top + projectRect.height / 2 - rect.top;
                const mainTasks = getMainTasks(project.id);
                mainTasks.forEach((task) => {
                    const taskElement = containerRef.current?.querySelector(`[data-task-id="${task.id}"]`);
                    if (taskElement) {
                        const taskRect = taskElement.getBoundingClientRect();
                        if (taskRect.width === 0 || taskRect.height === 0) return; // Element not visible
                        const taskX = taskRect.left + taskRect.width / 2 - rect.left;
                        const taskY = taskRect.top + taskRect.height / 2 - rect.top;
                        // Aktualizace čáry z projektu na task
                        const line = svg.querySelector(`#line-project-${project.id}-task-${task.id}`);
                        if (line) {
                            line.setAttribute('x1', projectX);
                            line.setAttribute('y1', projectY);
                            line.setAttribute('x2', taskX);
                            line.setAttribute('y2', taskY);
                        }
                        // Aktualizace čar z tasku na subtasky
                        const subtasks = getSubtasks(task.id);
                        subtasks.forEach((subtask) => {
                            const subtaskElement = containerRef.current?.querySelector(`[data-task-id="${subtask.id}"]`);
                            if (subtaskElement) {
                                const subtaskRect = subtaskElement.getBoundingClientRect();
                                if (subtaskRect.width === 0 || subtaskRect.height === 0) return; // Element not visible
                                const subtaskX = subtaskRect.left + subtaskRect.width / 2 - rect.left;
                                const subtaskY = subtaskRect.top + subtaskRect.height / 2 - rect.top;
                                const subtaskLine = svg.querySelector(`#line-task-${task.id}-subtask-${subtask.id}`);
                                if (subtaskLine) {
                                    subtaskLine.setAttribute('x1', taskX);
                                    subtaskLine.setAttribute('y1', taskY);
                                    subtaskLine.setAttribute('x2', subtaskX);
                                    subtaskLine.setAttribute('y2', subtaskY);
                                }
                            }
                        });
                    }
                });
            });
            
            // Continue animation loop
            animationFrameId = requestAnimationFrame(updateLines);
        };
        
        // Start animation loop
        animationFrameId = requestAnimationFrame(updateLines);
        
        return () => {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
        };
    }, [projects, tasks, camera, positions, dragging, moveOffset, movingSelected, selectedItems]);
    const getProjectTasks = (projectId) => {
        return tasks.filter(t => t.project_id === projectId);
    };
    const getMainTasks = (projectId) => {
        return tasks.filter(t => t.project_id === projectId && !t.parent_id);
    };
    const getSubtasks = (taskId) => {
        return tasks.filter(t => t.parent_id === taskId);
    };
    const getProjectPosition = (project, index, total) => {
        const saved = positions.projects?.[project.id];
        if (saved) return saved;
        // Pokud má projekt parent, umístíme ho vedle parent projektu
        if (project.parent_project_id) {
            const parentProject = projects.find(p => p.id === project.parent_project_id);
            if (parentProject) {
                const parentIndex = projects.findIndex(p => p.id === parentProject.id);
                const parentPos = getProjectPosition(parentProject, parentIndex, total);
                // Umístíme child projekt v kruhu kolem parent projektu
                const childProjects = projects.filter(p => p.parent_project_id === parentProject.id);
                const childIndex = childProjects.findIndex(p => p.id === project.id);
                const childAngle = (childIndex / Math.max(1, childProjects.length)) * Math.PI * 2;
                const childRadius = 250;
                return {
                    x: parentPos.x + Math.cos(childAngle) * childRadius,
                    y: parentPos.y + Math.sin(childAngle) * childRadius
                };
            }
        }
        if (total === 0) return { x: 0, y: 0 };
        // Hlavní projekty (bez parent) jsou v kruhu
        const mainProjects = projects.filter(p => !p.parent_project_id);
        const mainIndex = mainProjects.findIndex(p => p.id === project.id);
        if (mainIndex === -1) return { x: 0, y: 0 };
        const angle = (mainIndex / Math.max(1, mainProjects.length)) * Math.PI * 2;
        const radius = Math.max(200, mainProjects.length * 30);
        return {
            x: Math.cos(angle) * radius,
            y: Math.sin(angle) * radius
        };
    };
    const calculateFontSize = (width, height, baseSize = 14) => {
        // Calculate font size based on cell dimensions
        const area = width * height;
        const scale = Math.sqrt(area / (140 * 60)); // Base area for 140x60
        return Math.max(10, Math.min(18, baseSize * scale));
    };
    const getTaskPosition = (task, taskIndex, totalTasks, parentPos) => {
        const saved = positions.tasks?.[task.id];
        if (saved) {
            // Apply move offset if this task is selected and being moved
            if (selectedItems.tasks.has(task.id) && movingSelected && (moveOffset.x !== 0 || moveOffset.y !== 0)) {
                return { x: saved.x + moveOffset.x, y: saved.y + moveOffset.y };
            }
            return { x: saved.x, y: saved.y };
        }
        if (totalTasks === 0) {
            const basePos = parentPos;
            // Apply move offset if this task is selected and being moved
            if (selectedItems.tasks.has(task.id) && movingSelected && (moveOffset.x !== 0 || moveOffset.y !== 0)) {
                return { x: basePos.x + moveOffset.x, y: basePos.y + moveOffset.y };
            }
            return basePos;
        }
        const angle = (taskIndex / totalTasks) * Math.PI * 2;
        const radius = task.parent_id ? 80 : 120; // Subtasky jsou blíž
        const basePos = {
            x: parentPos.x + Math.cos(angle) * radius,
            y: parentPos.y + Math.sin(angle) * radius
        };
        // Apply move offset if this task is selected and being moved
        if (selectedItems.tasks.has(task.id) && movingSelected && (moveOffset.x !== 0 || moveOffset.y !== 0)) {
            return { x: basePos.x + moveOffset.x, y: basePos.y + moveOffset.y };
        }
        return basePos;
    };
    const handleMoveSelectedTasks = (direction) => {
        const step = 20; // pixels to move
        const offsets = {
            'up': { x: 0, y: -step },
            'down': { x: 0, y: step },
            'left': { x: -step, y: 0 },
            'right': { x: step, y: 0 }
        };
        const offset = offsets[direction];
        if (!offset) return;
        const newPositions = { ...positions };
        if (!newPositions.tasks) newPositions.tasks = {};
        selectedItems.tasks.forEach(taskId => {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                const currentPos = newPositions.tasks[taskId] || getTaskPosition(
                    task,
                    tasks.filter(t => t.project_id === task.project_id && !t.parent_id).findIndex(t => t.id === taskId),
                    tasks.filter(t => t.project_id === task.project_id && !t.parent_id).length,
                    getProjectPosition(projects.find(p => p.id === task.project_id), projects.findIndex(p => p.id === task.project_id), projects.length)
                );
                newPositions.tasks[taskId] = {
                    x: currentPos.x + offset.x,
                    y: currentPos.y + offset.y,
                    projectId: task.project_id
                };
                StorageService.saveMindMapPosition(taskId, 'tasks', newPositions.tasks[taskId].x, newPositions.tasks[taskId].y);
            }
        });
        setPositions(newPositions);
        loadData();
    };
    const handleDeleteSelectedTasks = () => {
        if (selectedItems.tasks.size === 0) return;
        if (window.confirm(`Opravdu chcete smazat ${selectedItems.tasks.size} vybraných úkolů?`)) {
            selectedItems.tasks.forEach(taskId => {
                StorageService.deleteTask(taskId);
            });
            setSelectedItems({ projects: new Set(), tasks: new Set() });
            loadData();
        }
    };
    const handleChangeStatusSelectedTasks = (newStatus) => {
        selectedItems.tasks.forEach(taskId => {
            StorageService.updateTask(taskId, { status: newStatus });
        });
        loadData();
    };
    const handleStartMovingSelected = (e) => {
        if (selectedItems.tasks.size === 0) return;
        e.stopPropagation();
        // Get the task that was clicked
        const taskId = e.currentTarget.getAttribute('data-task-id');
        if (!taskId) return;
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        
        // Get task position in transformed space
        const saved = positions.tasks?.[taskId];
        let taskX, taskY;
        if (saved) {
            taskX = saved.x;
            taskY = saved.y;
        } else {
            const project = projects.find(p => p.id === task.project_id);
            if (!project) return;
            const projectPos = getProjectPosition(project, projects.findIndex(p => p.id === project.id), projects.length);
            const mainTasks = getMainTasks(project.id);
            const taskIndex = mainTasks.findIndex(t => t.id === taskId);
            const taskPos = getTaskPosition(task, taskIndex, mainTasks.length, projectPos);
            taskX = taskPos.x;
            taskY = taskPos.y;
        }
        
        // Calculate offset: mouse position in transformed space - element position in transformed space
        const rect = containerRef.current.getBoundingClientRect();
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        const mouseX = (e.clientX - rect.left - centerX - camera.x) / camera.zoom;
        const mouseY = (e.clientY - rect.top - centerY - camera.y) / camera.zoom;
        const dragOffset = { 
            x: mouseX - taskX, 
            y: mouseY - taskY 
        };
        setDragging('move-selected-tasks');
        setMovingSelected(true);
        setDragStart(dragOffset);
    };
    const handleContextMenu = (e, type, id, status) => {
        e.preventDefault();
        e.stopPropagation();
        // Ensure menu is visible - adjust position if near edges
        const menuWidth = 180;
        const menuHeight = 200; // approximate
        let x = e.clientX;
        let y = e.clientY;
        if (x + menuWidth > window.innerWidth) {
            x = window.innerWidth - menuWidth - 10;
        }
        if (y + menuHeight > window.innerHeight) {
            y = window.innerHeight - menuHeight - 10;
        }
        setContextMenu({
            x,
            y,
            type,
            id,
            status
        });
    };
    const handleCloseContextMenu = () => {
        setContextMenu(null);
    };
    const handleEdit = () => {
        if (contextMenu.type === 'project') {
            const project = projects.find(p => p.id === contextMenu.id);
            if (project) {
                setSelectedProject(project);
            }
        } else if (contextMenu.type === 'task') {
            const task = tasks.find(t => t.id === contextMenu.id);
            if (task) {
                const project = projects.find(p => p.id === task.project_id);
                if (project) {
                    setSelectedProject(project);
                }
            }
        }
        handleCloseContextMenu();
    };
    const handleChangeStatus = (newStatus) => {
        if (contextMenu.type === 'task') {
            StorageService.updateTask(contextMenu.id, { status: newStatus });
            loadData();
        }
        handleCloseContextMenu();
    };
    const handleDelete = () => {
        if (window.confirm('Opravdu chcete smazat tento ' + (contextMenu.type === 'project' ? 'projekt' : 'úkol') + '?')) {
            if (contextMenu.type === 'project') {
                StorageService.deleteProject(contextMenu.id);
            } else if (contextMenu.type === 'task') {
                StorageService.deleteTask(contextMenu.id);
            }
            loadData();
            if (contextMenu.type === 'project' && selectedProject?.id === contextMenu.id) {
                setSelectedProject(null);
            }
        }
        handleCloseContextMenu();
    };
    // Close context menu on click outside
    useEffect(() => {
        const handleClickOutside = () => {
            if (contextMenu) {
                setContextMenu(null);
            }
        };
        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
    }, [contextMenu]);
    return (
        <div style={{ height: '100%', display: 'flex', gap: '16px', position: 'relative' }}>
            {contextMenu && (
                <div
                    style={{
                        position: 'fixed',
                        left: contextMenu.x,
                        top: contextMenu.y,
                        backgroundColor: 'var(--bf-surface-100)',
                        border: '1px solid var(--bf-surface-300)',
                        borderRadius: 'var(--bf-radius-md)',
                        boxShadow: 'var(--bf-shadow-lg)',
                        padding: '4px',
                        zIndex: 10000,
                        minWidth: '180px',
                        pointerEvents: 'auto'
                    }}
                    onClick={(e) => e.stopPropagation()}
                >
                    <button
                        className="btn btn-secondary"
                        onClick={handleEdit}
                        style={{ width: '100%', textAlign: 'left', padding: '8px 12px', marginBottom: '2px', fontSize: 'var(--bf-font-size-sm)' }}
                    >
                        <Icon name="edit" size={16} style={{ marginRight: '8px', verticalAlign: 'middle' }} />
                        Upravit
                    </button>
                    {contextMenu.type === 'task' && (
                        <div style={{ borderTop: '1px solid var(--bf-surface-200)', margin: '4px 0', paddingTop: '4px' }}>
                            <div style={{ padding: '4px 12px', fontSize: 'var(--bf-font-size-xs)', color: 'var(--bf-text-500)', fontWeight: 600 }}>
                                Stav: {contextMenu.status === 'todo' ? 'K udělání' : contextMenu.status === 'in_progress' ? 'V procesu' : 'Hotovo'}
                            </div>
                            <button
                                className="btn btn-secondary"
                                onClick={() => handleChangeStatus('todo')}
                                style={{ width: '100%', textAlign: 'left', padding: '6px 12px', marginBottom: '2px', fontSize: 'var(--bf-font-size-sm)', opacity: contextMenu.status === 'todo' ? 1 : 0.7 }}
                            >
                                <Icon name="todo" size={14} style={{ marginRight: '8px', verticalAlign: 'middle' }} />
                                K udělání
                            </button>
                            <button
                                className="btn btn-secondary"
                                onClick={() => handleChangeStatus('in_progress')}
                                style={{ width: '100%', textAlign: 'left', padding: '6px 12px', marginBottom: '2px', fontSize: 'var(--bf-font-size-sm)', opacity: contextMenu.status === 'in_progress' ? 1 : 0.7 }}
                            >
                                <Icon name="inProgress" size={14} style={{ marginRight: '8px', verticalAlign: 'middle' }} />
                                V procesu
                            </button>
                            <button
                                className="btn btn-secondary"
                                onClick={() => handleChangeStatus('done')}
                                style={{ width: '100%', textAlign: 'left', padding: '6px 12px', marginBottom: '2px', fontSize: 'var(--bf-font-size-sm)', opacity: contextMenu.status === 'done' ? 1 : 0.7 }}
                            >
                                <Icon name="done" size={14} style={{ marginRight: '8px', verticalAlign: 'middle' }} />
                                Hotovo
                            </button>
                        </div>
                    )}
                    <div style={{ borderTop: '1px solid var(--bf-surface-200)', margin: '4px 0' }} />
                    <button
                        className="btn btn-secondary"
                        onClick={handleDelete}
                        style={{ width: '100%', textAlign: 'left', padding: '8px 12px', color: 'var(--bf-danger-500)', fontSize: 'var(--bf-font-size-sm)' }}
                    >
                        <Icon name="delete" size={16} style={{ marginRight: '8px', verticalAlign: 'middle' }} />
                        Smazat
                    </button>
                </div>
            )}
            <div style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '12px' }}>
                <h1 style={{ fontSize: 'var(--bf-font-size-2xl)', fontWeight: 700 }}>Mind Map</h1>
                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', alignItems: 'center' }}>
                    <div style={{ fontSize: 'var(--bf-font-size-xs)', color: 'var(--bf-text-500)', padding: '4px 8px', background: 'var(--bf-surface-100)', borderRadius: 'var(--bf-radius-sm)' }}>
                        Drag = Select | Shift+Drag = Pan | Middle Mouse = Pan | Wheel = Zoom | Drag corner = Resize | Drag selected = Move all
                    </div>
                    <button className={`btn ${viewScope === 'all' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => { setViewScope('all'); setSelectedProject(null); }}>All Projects</button>
                    <button className={`btn ${viewScope === 'single' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setViewScope('single')}>Single Project</button>
                    <button className={`btn ${viewMode === '3d' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setViewMode('3d')}>3D View</button>
                    <button className={`btn ${viewMode === '2d' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setViewMode('2d')}>2D View</button>
                    <button className="btn btn-secondary" onClick={() => setCamera({ x: 0, y: 0, zoom: 1 })}>Reset View</button>
                    <button className="btn btn-secondary" onClick={() => setCamera({ ...camera, zoom: Math.min(2, camera.zoom * 1.2) })} style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                        <Icon name="zoomIn" size={16} />
                        +
                    </button>
                    <button className="btn btn-secondary" onClick={() => setCamera({ ...camera, zoom: Math.max(0.3, camera.zoom * 0.8) })} style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                        <Icon name="zoomOut" size={16} />
                        -
                    </button>
                </div>
            </div>
            {/* Toolbar for selected tasks */}
            {selectedItems.tasks.size > 0 && (
                <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    padding: '12px',
                    background: 'var(--bf-surface-100)',
                    borderRadius: 'var(--bf-radius-md)',
                    marginBottom: '16px',
                    border: '2px solid var(--bf-primary-500)',
                    flexWrap: 'wrap'
                }}>
                    <div style={{ fontWeight: 600, color: 'var(--bf-text-900)', marginRight: '8px' }}>
                        {selectedItems.tasks.size} vybraných úkolů
                    </div>
                    <button
                        className="btn btn-secondary"
                        onClick={() => handleChangeStatusSelectedTasks('todo')}
                        title="Nastavit jako 'K udělání'"
                        style={{ padding: '6px 12px', fontSize: 'var(--bf-font-size-sm)' }}
                    >
                        K udělání
                    </button>
                    <button
                        className="btn btn-secondary"
                        onClick={() => handleChangeStatusSelectedTasks('in_progress')}
                        title="Nastavit jako 'V procesu'"
                        style={{ padding: '6px 12px', fontSize: 'var(--bf-font-size-sm)' }}
                    >
                        V procesu
                    </button>
                    <button
                        className="btn btn-secondary"
                        onClick={() => handleChangeStatusSelectedTasks('done')}
                        title="Nastavit jako 'Hotovo'"
                        style={{ padding: '6px 12px', fontSize: 'var(--bf-font-size-sm)' }}
                    >
                        Hotovo
                    </button>
                    <div style={{ width: '1px', height: '24px', background: 'var(--bf-surface-300)', margin: '0 8px' }} />
                    <button
                        className="btn btn-danger"
                        onClick={handleDeleteSelectedTasks}
                        title="Smazat vybrané úkoly"
                        style={{ padding: '6px 12px', fontSize: 'var(--bf-font-size-sm)', display: 'flex', alignItems: 'center', gap: '4px' }}
                    >
                        <Icon name="delete" size={14} />
                        Smazat
                    </button>
                    <button
                        className="btn btn-secondary"
                        onClick={() => setSelectedItems({ projects: new Set(), tasks: new Set() })}
                        title="Zrušit výběr"
                        style={{ padding: '6px 12px', fontSize: 'var(--bf-font-size-sm)', marginLeft: 'auto' }}
                    >
                        ✕ Zrušit výběr
                    </button>
                </div>
            )}
                <div
                    ref={containerRef}
                    onMouseDown={handleBackgroundMouseDown}
                    onClick={handleContainerClick}
                    onContextMenu={(e) => {
                        // Prevent default context menu on background, but allow our custom menu on cells
                        // If clicking on background (not on a cell), prevent default menu
                        const target = e.target;
                        const isCell = target.closest('.mindmap-block') || target.closest('[data-project-id]') || target.closest('[data-task-id]');
                        if (!isCell) {
                            e.preventDefault();
                            e.stopPropagation();
                        }
                        // If clicking on a cell, our custom handlers will handle it
                    }}
                    style={{
                        flex: 1,
                        position: 'relative',
                        overflow: 'hidden',
                        backgroundColor: 'var(--bf-bg)',
                        cursor: dragging === 'camera' ? 'grabbing' : dragging ? 'grabbing' : 'default',
                        borderRadius: 'var(--bf-radius-md)',
                        border: '1px solid var(--bf-surface-200)'
                    }}
                >
                <svg
                    onContextMenu={(e) => {
                        // Prevent default context menu on SVG lines
                        e.preventDefault();
                        e.stopPropagation();
                    }}
                    ref={(svg) => {
                        if (svg && dragging) {
                            const updateLines = () => {
                                const rect = containerRef.current.getBoundingClientRect();
                                const centerX = rect.width / 2;
                                const centerY = rect.height / 2;
                                projects.forEach((project, pIndex) => {
                                    const projectPos = getProjectPosition(project, pIndex, projects.length);
                                    const mainTasks = getMainTasks(project.id);
                                    const projectX = centerX + projectPos.x * camera.zoom + camera.x;
                                    const projectY = centerY + projectPos.y * camera.zoom + camera.y;
                                    mainTasks.forEach((task, tIndex) => {
                                        const taskPos = getTaskPosition(task, tIndex, mainTasks.length, projectPos);
                                        const taskX = centerX + taskPos.x * camera.zoom + camera.x;
                                        const taskY = centerY + taskPos.y * camera.zoom + camera.y;
                                        // Aktualizace čáry z projektu na task
                                        const line = svg.querySelector(`#line-project-${project.id}-task-${task.id}`);
                                        if (line) {
                                            line.setAttribute('x1', projectX);
                                            line.setAttribute('y1', projectY);
                                            line.setAttribute('x2', taskX);
                                            line.setAttribute('y2', taskY);
                                        }
                                        // Aktualizace čar z tasku na subtasky
                                        const subtasks = getSubtasks(task.id);
                                        subtasks.forEach((subtask, sIndex) => {
                                            const subtaskPos = getTaskPosition(subtask, sIndex, subtasks.length, taskPos);
                                            const subtaskX = centerX + subtaskPos.x * camera.zoom + camera.x;
                                            const subtaskY = centerY + subtaskPos.y * camera.zoom + camera.y;
                                            const subtaskLine = svg.querySelector(`#line-task-${task.id}-subtask-${subtask.id}`);
                                            if (subtaskLine) {
                                                subtaskLine.setAttribute('x1', taskX);
                                                subtaskLine.setAttribute('y1', taskY);
                                                subtaskLine.setAttribute('x2', subtaskX);
                                                subtaskLine.setAttribute('y2', subtaskY);
                                            }
                                        });
                                    });
                                });
                            };
                            requestAnimationFrame(updateLines);
                        }
                    }}
                    width="100%"
                    height="100%"
                    style={{
                        position: 'absolute',
                        top: 0,
                        left: 0,
                        pointerEvents: 'none',
                        overflow: 'visible'
                    }}
                >
                    {/* Čáry mezi projekty */}
                    {projects.map((project) => {
                        if (project.parent_project_id) {
                            const parentProject = projects.find(p => p.id === project.parent_project_id);
                            if (parentProject) {
                                const projectPos = getProjectPosition(project, projects.findIndex(p => p.id === project.id), projects.length);
                                const parentPos = getProjectPosition(parentProject, projects.findIndex(p => p.id === parentProject.id), projects.length);
                                const rect = containerRef.current?.getBoundingClientRect() || { width: 0, height: 0 };
                                const centerX = rect.width / 2;
                                const centerY = rect.height / 2;
                                const projectX = centerX + projectPos.x * camera.zoom + camera.x;
                                const projectY = centerY + projectPos.y * camera.zoom + camera.y;
                                const parentX = centerX + parentPos.x * camera.zoom + camera.x;
                                const parentY = centerY + parentPos.y * camera.zoom + camera.y;
                                return (
                                    <line
                                        key={`line-project-${parentProject.id}-to-${project.id}`}
                                        id={`line-project-${parentProject.id}-to-${project.id}`}
                                        x1={parentX}
                                        y1={parentY}
                                        x2={projectX}
                                        y2={projectY}
                                        stroke="var(--bf-accent-500)"
                                        strokeWidth="3"
                                        opacity="0.5"
                                        strokeDasharray="5,5"
                                    />
                                );
                            }
                        }
                        return null;
                    })}
                    {projects.map((project, pIndex) => {
                        const projectPos = getProjectPosition(project, pIndex, projects.length);
                        const mainTasks = getMainTasks(project.id);
                        const rect = containerRef.current?.getBoundingClientRect() || { width: 0, height: 0 };
                        const centerX = rect.width / 2;
                        const centerY = rect.height / 2;
                        const projectX = centerX + projectPos.x * camera.zoom + camera.x;
                        const projectY = centerY + projectPos.y * camera.zoom + camera.y;
                        const lines = [];
                        // Čáry z projektu na hlavní tasky
                        mainTasks.forEach((task, tIndex) => {
                            const taskPos = getTaskPosition(task, tIndex, mainTasks.length, projectPos);
                            const taskX = centerX + taskPos.x * camera.zoom + camera.x;
                            const taskY = centerY + taskPos.y * camera.zoom + camera.y;
                            lines.push(
                                <line
                                    key={`line-project-${project.id}-task-${task.id}`}
                                    id={`line-project-${project.id}-task-${task.id}`}
                                    x1={projectX}
                                    y1={projectY}
                                    x2={taskX}
                                    y2={taskY}
                                    stroke="var(--bf-primary-500)"
                                    strokeWidth="2"
                                    opacity="0.4"
                                />
                            );
                            // Čáry z tasku na jeho subtasky
                            const subtasks = getSubtasks(task.id);
                            subtasks.forEach((subtask, sIndex) => {
                                const subtaskPos = getTaskPosition(subtask, sIndex, subtasks.length, taskPos);
                                const subtaskX = centerX + subtaskPos.x * camera.zoom + camera.x;
                                const subtaskY = centerY + subtaskPos.y * camera.zoom + camera.y;
                                lines.push(
                                    <line
                                        key={`line-task-${task.id}-subtask-${subtask.id}`}
                                        id={`line-task-${task.id}-subtask-${subtask.id}`}
                                        x1={taskX}
                                        y1={taskY}
                                        x2={subtaskX}
                                        y2={subtaskY}
                                        stroke="var(--bf-success-500)"
                                        strokeWidth="1.5"
                                        opacity="0.3"
                                        strokeDasharray="3,3"
                                    />
                                );
                            });
                        });
                        return lines;
                    })}
                </svg>
                {/* Selection box */}
                {selectionBox && (
                    <div
                        className="mindmap-selection-box"
                        style={{
                            left: Math.min(selectionBox.x1, selectionBox.x2),
                            top: Math.min(selectionBox.y1, selectionBox.y2),
                            width: Math.abs(selectionBox.x2 - selectionBox.x1),
                            height: Math.abs(selectionBox.y2 - selectionBox.y1)
                        }}
                    />
                )}
                <div
                    style={{
                        position: 'absolute',
                        top: '50%',
                        left: '50%',
                        transform: `translate(calc(-50% + ${camera.x}px), calc(-50% + ${camera.y}px)) scale(${camera.zoom})`,
                        transformOrigin: 'center center',
                        transition: dragging ? 'none' : (viewMode === '2d' ? 'transform 0.05s ease-out' : 'transform 0.1s ease-out'),
                        willChange: dragging ? 'transform' : 'auto'
                    }}
                >
                    {projects.map((project, pIndex) => {
                        const projectPos = getProjectPosition(project, pIndex, projects.length);
                        const projectTasks = getProjectTasks(project.id);
                        const completedTasks = projectTasks.filter(t => t.status === 'done').length;
                        const progress = projectTasks.length > 0 ? (completedTasks / projectTasks.length) * 100 : 0;
                        const isDragging = dragging === `project-${project.id}`;
                        const isSelected = selectedItems.projects.has(project.id);
                        const savedSize = blockSizes.projects?.[project.id];
                        const projectWidth = savedSize?.width || (viewMode === '3d' ? 280 : 240);
                        const projectHeight = savedSize?.height || 180;
                        return (
                            <div key={project.id} data-project-id={project.id} style={{ position: 'absolute', left: projectPos.x, top: projectPos.y, transform: 'translate(-50%, -50%)', zIndex: isDragging ? 100 : (selectedProject?.id === project.id ? 10 : (isSelected ? 5 : 1)) }}>
                                <div
                                    className={`card mindmap-block mindmap-draggable ${isSelected ? 'selected' : ''}`}
                                    onClick={(e) => {
                                        if (!isDragging && dragging === null && !e.target.classList.contains('mindmap-resize-handle')) {
                                            setSelectedProject(selectedProject?.id === project.id ? null : project);
                                        }
                                    }}
                                    onContextMenu={(e) => handleContextMenu(e, 'project', project.id, null)}
                                    onMouseDown={(e) => {
                                        if (e.button === 1) {
                                            // Middle mouse button - ignore cell and pan camera
                                            e.preventDefault();
                                            e.stopPropagation();
                                            setDragging('camera');
                                            setDragStart({ x: e.clientX - camera.x, y: e.clientY - camera.y });
                                            return;
                                        }
                                        if (e.button === 0 && !e.target.classList.contains('mindmap-resize-handle')) {
                                            e.stopPropagation();
                                            setDragging(`project-${project.id}`);
                                            // Calculate offset: mouse position in transformed space - element position in transformed space
                                            const rect = containerRef.current.getBoundingClientRect();
                                            const centerX = rect.width / 2;
                                            const centerY = rect.height / 2;
                                            // Current mouse position in transformed space
                                            const mouseX = (e.clientX - rect.left - centerX - camera.x) / camera.zoom;
                                            const mouseY = (e.clientY - rect.top - centerY - camera.y) / camera.zoom;
                                            // Element position in transformed space (use saved position or calculated)
                                            const elementX = projectPos.x;
                                            const elementY = projectPos.y;
                                            // Offset = mouse - element
                                            setDragStart({ 
                                                x: mouseX - elementX, 
                                                y: mouseY - elementY 
                                            });
                                        }
                                    }}
                                    style={{
                                        width: `${projectWidth}px`,
                                        minHeight: `${projectHeight}px`,
                                        padding: '20px',
                                        border: isSelected ? `3px solid var(--bf-primary-500)` : `2px solid var(--bf-primary-500)`,
                                        background: viewMode === '2d' 
                                            ? 'var(--bf-surface-100)'
                                            : (viewMode === '3d' 
                                                ? `linear-gradient(135deg, var(--bf-primary-500), var(--bf-accent-500))`
                                                : 'var(--bf-surface-100)'),
                                        color: viewMode === '2d' ? 'var(--bf-text-900)' : (viewMode === '3d' ? 'white' : 'var(--bf-text-900)'),
                                        boxShadow: viewMode === '2d' 
                                            ? 'var(--bf-shadow-lg)'
                                            : (viewMode === '3d' 
                                                ? '0 12px 40px rgba(147, 51, 234, 0.5), 0 0 0 1px rgba(255,255,255,0.15) inset, 0 -4px 20px rgba(0,0,0,0.2)'
                                                : 'var(--bf-shadow-lg)'),
                                        transform: viewMode === '2d' && !isDragging ? 'none' : (viewMode === '3d' && !isDragging ? 'perspective(1200px) rotateY(-10deg) rotateX(10deg) scale(1.08) translateZ(20px)' : isDragging ? 'scale(1.05)' : 'none'),
                                        cursor: 'move',
                                        transition: isDragging ? 'none' : (viewMode === '2d' ? 'transform 0.05s ease-out, box-shadow 0.05s ease-out' : 'all var(--bf-transition-base)'),
                                        willChange: isDragging ? 'transform' : 'auto',
                                        position: 'relative',
                                        opacity: isDragging ? 0.9 : 1
                                    }}
                                    onMouseEnter={(e) => {
                                        if (viewMode === '2d' && !isDragging) {
                                            e.currentTarget.style.transform = 'scale(1.02)';
                                        } else if (viewMode === '3d' && !isDragging) {
                                            e.currentTarget.style.transform = 'perspective(1200px) rotateY(-5deg) rotateX(5deg) scale(1.12) translateZ(30px)';
                                        }
                                    }}
                                    onMouseLeave={(e) => {
                                        if (viewMode === '2d' && !isDragging) {
                                            e.currentTarget.style.transform = 'none';
                                        } else if (viewMode === '3d' && !isDragging) {
                                            e.currentTarget.style.transform = 'perspective(1200px) rotateY(-10deg) rotateX(10deg) scale(1.08) translateZ(20px)';
                                        }
                                    }}
                                >
                                    <h3 style={{ 
                                        fontSize: `clamp(14px, ${projectWidth * 0.06}px, 24px)`, 
                                        fontWeight: 700, 
                                        marginBottom: '8px', 
                                        color: viewMode === '3d' ? 'white' : 'var(--bf-text-900)',
                                        overflow: 'hidden',
                                        textOverflow: 'ellipsis',
                                        whiteSpace: 'nowrap',
                                        maxWidth: '100%'
                                    }}>
                                        {project.title}
                                    </h3>
                                    {project.description && (
                                        <p style={{ 
                                            fontSize: `clamp(11px, ${projectWidth * 0.04}px, 16px)`, 
                                            marginBottom: '12px', 
                                            opacity: 0.9,
                                            overflow: 'hidden',
                                            textOverflow: 'ellipsis',
                                            display: '-webkit-box',
                                            WebkitLineClamp: 2,
                                            WebkitBoxOrient: 'vertical',
                                            wordBreak: 'break-word'
                                        }}>
                                            {project.description}
                                        </p>
                                    )}
                                    <div style={{ marginBottom: '8px' }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: `clamp(11px, ${projectWidth * 0.04}px, 16px)`, marginBottom: '4px' }}>
                                            <span>{projectTasks.length} tasks</span>
                                            <span>{Math.round(progress)}%</span>
                                        </div>
                                        <div style={{ width: '100%', height: '6px', backgroundColor: viewMode === '3d' ? 'rgba(255,255,255,0.3)' : 'var(--bf-surface-200)', borderRadius: 'var(--bf-radius-sm)', overflow: 'hidden' }}>
                                            <div style={{ width: `${progress}%`, height: '100%', backgroundColor: 'var(--bf-success-500)', transition: 'width 0.3s ease' }} />
                                        </div>
                                    </div>
                                    {projectTasks.length > 0 && (
                                        <div style={{ fontSize: `clamp(10px, ${projectWidth * 0.035}px, 14px)`, opacity: 0.8 }}>
                                            {completedTasks} completed
                                        </div>
                                    )}
                                    <div
                                        className="mindmap-resize-handle"
                                        onMouseDown={(e) => {
                                            e.stopPropagation();
                                            setDragging(`resize-project-${project.id}`);
                                        }}
                                    />
                                </div>
                                {projectTasks.map((task, tIndex) => {
                                    const taskPos = getTaskPosition(task, tIndex, projectTasks.length, projectPos);
                                    const isDraggingTask = dragging === `task-${task.id}-${project.id}`;
                                    const isSelectedTask = selectedItems.tasks.has(task.id);
                                    const savedTaskSize = blockSizes.tasks?.[task.id];
                                    const taskWidth = savedTaskSize?.width || 140;
                                    const taskHeight = savedTaskSize?.height || 60;
                                    return (
                                        <div
                                            key={task.id}
                                            data-task-id={task.id}
                                            className={`mindmap-block mindmap-draggable ${isSelectedTask ? 'selected' : ''}`}
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                // Only handle click if we weren't dragging
                                                if (!isDraggingTask && !movingSelected && !wasDraggingRef.current && !e.target.classList.contains('mindmap-resize-handle')) {
                                                    // If Ctrl or Shift is held, toggle selection
                                                    if (e.ctrlKey || e.shiftKey) {
                                                        const newSelected = { ...selectedItems };
                                                        if (!newSelected.tasks) newSelected.tasks = new Set(selectedItems.tasks);
                                                        if (newSelected.tasks.has(task.id)) {
                                                            newSelected.tasks.delete(task.id);
                                                        } else {
                                                            newSelected.tasks.add(task.id);
                                                        }
                                                        setSelectedItems(newSelected);
                                                    } else if (selectedItems.tasks.size > 0 && !selectedItems.tasks.has(task.id)) {
                                                        // If clicking on non-selected task while others are selected, clear selection
                                                        setSelectedItems({ projects: new Set(), tasks: new Set() });
                                                        const newTask = StorageService.updateTask(task.id, { status: task.status === 'done' ? 'todo' : 'done' });
                                                        if (newTask) loadData();
                                                    } else if (selectedItems.tasks.size === 0) {
                                                        // Normal click - toggle task status
                                                        const newTask = StorageService.updateTask(task.id, { status: task.status === 'done' ? 'todo' : 'done' });
                                                        if (newTask) loadData();
                                                    }
                                                    // If task is already selected, do nothing (keep selection)
                                                }
                                            }}
                                            onContextMenu={(e) => handleContextMenu(e, 'task', task.id, task.status)}
                                            onMouseDown={(e) => {
                                                if (e.button === 1) {
                                                    // Middle mouse button - ignore cell and pan camera
                                                    e.preventDefault();
                                                    e.stopPropagation();
                                                    setDragging('camera');
                                                    setDragStart({ x: e.clientX - camera.x, y: e.clientY - camera.y });
                                                    return;
                                                }
                                                e.stopPropagation();
                                                if (!e.target.classList.contains('mindmap-resize-handle')) {
                                                    // Calculate offset: mouse position in transformed space - element position in transformed space
                                                    const rect = containerRef.current.getBoundingClientRect();
                                                    const centerX = rect.width / 2;
                                                    const centerY = rect.height / 2;
                                                    // Current mouse position in transformed space
                                                    const mouseX = (e.clientX - rect.left - centerX - camera.x) / camera.zoom;
                                                    const mouseY = (e.clientY - rect.top - centerY - camera.y) / camera.zoom;
                                                    // Element position in transformed space (use saved position or calculated)
                                                    const elementX = taskPos.x;
                                                    const elementY = taskPos.y;
                                                    // Offset = mouse - element
                                                    const dragOffset = { 
                                                        x: mouseX - elementX, 
                                                        y: mouseY - elementY 
                                                    };
                                                    
                                                    // If task is selected and there are other selected tasks, move all selected
                                                    if (isSelectedTask && selectedItems.tasks.size > 1) {
                                                        handleStartMovingSelected(e);
                                                    } else if (isSelectedTask && selectedItems.tasks.size === 1) {
                                                        // Single selected task - move it normally
                                                        setDragging(`task-${task.id}-${project.id}`);
                                                        setDragStart(dragOffset);
                                                    } else {
                                                        // Normal drag for non-selected task
                                                        setDragging(`task-${task.id}-${project.id}`);
                                                        setDragStart(dragOffset);
                                                    }
                                                }
                                            }}
                                            style={{
                                                position: 'absolute',
                                                left: taskPos.x,
                                                top: taskPos.y,
                                                transform: (isDraggingTask || (movingSelected && isSelectedTask)) 
                                                    ? 'translate(-50%, -50%) scale(1.15)' 
                                                    : (viewMode === '3d' && !isDraggingTask) 
                                                        ? 'translate(-50%, -50%) perspective(1000px) rotateY(-5deg) rotateX(5deg) translateZ(15px)'
                                                        : 'translate(-50%, -50%)',
                                                opacity: (movingSelected && isSelectedTask) ? 0.8 : (isDraggingTask ? 0.95 : (task.status === 'done' ? 0.6 : 1)),
                                                width: `${taskWidth}px`,
                                                minHeight: `${taskHeight}px`,
                                                padding: '12px',
                                                border: isSelectedTask ? '3px solid var(--bf-primary-500)' : 'none',
                                                backgroundColor: task.status === 'done' 
                                                    ? '#16A34A' // Zelená pro hotovo
                                                    : task.status === 'in_progress'
                                                        ? '#F59E0B' // Oranžová pro v procesu
                                                        : '#9333EA', // Fialová pro k udělání
                                                color: 'white',
                                                borderRadius: 'var(--bf-radius-md)',
                                                fontSize: `clamp(10px, ${taskWidth * 0.08}px, 16px)`,
                                                fontWeight: 500,
                                                cursor: 'move',
                                                boxShadow: (isDraggingTask || (movingSelected && isSelectedTask)) 
                                                    ? '0 8px 24px rgba(0,0,0,0.3)' 
                                                    : (viewMode === '3d' 
                                                        ? '0 8px 24px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.15) inset, 0 -3px 15px rgba(0,0,0,0.2)'
                                                        : '0 4px 12px rgba(0,0,0,0.15)'),
                                                transition: (isDraggingTask || (movingSelected && isSelectedTask)) ? 'none' : (viewMode === '2d' ? 'transform 0.05s ease-out, box-shadow 0.05s ease-out' : 'all var(--bf-transition-base)'),
                                                willChange: (isDraggingTask || (movingSelected && isSelectedTask)) ? 'transform' : 'auto',
                                                textDecoration: task.status === 'done' ? 'line-through' : 'none',
                                                zIndex: (isDraggingTask || (movingSelected && isSelectedTask)) ? 200 : (isSelectedTask ? 10 : 5)
                                            }}
                                            onMouseEnter={(e) => {
                                                if (!isDraggingTask && !movingSelected) {
                                                    if (viewMode === '3d') {
                                                        e.currentTarget.style.transform = 'translate(-50%, -50%) perspective(1000px) rotateY(0deg) rotateX(0deg) scale(1.12) translateZ(25px)';
                                                    } else {
                                                        e.currentTarget.style.transform = 'translate(-50%, -50%) scale(1.1)';
                                                    }
                                                    e.currentTarget.style.zIndex = 6;
                                                }
                                            }}
                                            onMouseLeave={(e) => {
                                                if (!isDraggingTask && !movingSelected) {
                                                    if (viewMode === '3d') {
                                                        e.currentTarget.style.transform = 'translate(-50%, -50%) perspective(1000px) rotateY(-5deg) rotateX(5deg) translateZ(15px)';
                                                    } else {
                                                        e.currentTarget.style.transform = 'translate(-50%, -50%)';
                                                    }
                                                    e.currentTarget.style.zIndex = isSelectedTask ? 10 : 5;
                                                }
                                            }}
                                            title={task.title}
                                        >
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '6px', paddingBottom: '4px', borderBottom: '1px solid rgba(255,255,255,0.2)' }}>
                                                {task.status === 'done' && (
                                                    <>
                                                        <Icon name="done" size={Math.max(12, Math.min(18, taskWidth * 0.1))} color="white" style={{ strokeWidth: 2.5, flexShrink: 0 }} />
                                                        <span style={{ fontSize: `clamp(9px, ${taskWidth * 0.07}px, 13px)`, fontWeight: 600, opacity: 0.95, whiteSpace: 'nowrap' }}>Hotovo</span>
                                                    </>
                                                )}
                                                {task.status === 'in_progress' && (
                                                    <>
                                                        <Icon name="inProgress" size={Math.max(12, Math.min(18, taskWidth * 0.1))} color="white" style={{ strokeWidth: 2.5, flexShrink: 0 }} />
                                                        <span style={{ fontSize: `clamp(9px, ${taskWidth * 0.07}px, 13px)`, fontWeight: 600, opacity: 0.95, whiteSpace: 'nowrap' }}>V procesu</span>
                                                    </>
                                                )}
                                                {task.status === 'todo' && (
                                                    <>
                                                        <Icon name="todo" size={Math.max(12, Math.min(18, taskWidth * 0.1))} color="white" style={{ strokeWidth: 2.5, flexShrink: 0 }} />
                                                        <span style={{ fontSize: `clamp(9px, ${taskWidth * 0.07}px, 13px)`, fontWeight: 600, opacity: 0.95, whiteSpace: 'nowrap' }}>K udělání</span>
                                                    </>
                                                )}
                                            </div>
                                            <div style={{ overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', fontSize: `clamp(11px, ${taskWidth * 0.08}px, 16px)`, fontWeight: 500 }}>
                                                {task.title}
                                            </div>
                                            {task.due_at && (
                                                <div style={{ fontSize: `clamp(9px, ${taskWidth * 0.06}px, 12px)`, marginTop: '4px', opacity: 0.9 }}>
                                                    {Utils.formatDate(task.due_at)}
                                                </div>
                                            )}
                                            <div
                                                className="mindmap-resize-handle"
                                                onMouseDown={(e) => {
                                                    e.stopPropagation();
                                                    setDragging(`resize-task-${task.id}`);
                                                }}
                                            />
                                        </div>
                                    );
                                })}
                            </div>
                        );
                    })}
                </div>
                {projects.length === 0 && (
                    <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', textAlign: 'center', color: 'var(--bf-text-500)' }}>
                        <div style={{ marginBottom: '16px', display: 'flex', justifyContent: 'center' }}>
                            <Icon name="mindmap" size={48} color="var(--bf-text-500)" />
                        </div>
                        <div>No projects yet. Create a project to see it in the mind map!</div>
                    </div>
                )}
                </div>
            </div>
            {viewScope === 'single' && !selectedProject && (
                <div className="card" style={{ width: '320px', display: 'flex', flexDirection: 'column', maxHeight: '100%', overflow: 'hidden' }}>
                    <h3 style={{ marginBottom: '16px' }}>Select Project</h3>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', overflowY: 'auto' }}>
                        {StorageService.getProjects().filter(p => !p.archived).map(project => (
                            <button key={project.id} className="btn btn-secondary" onClick={() => { setSelectedProject(project); loadData(); }} style={{ 
                                textAlign: 'left',
                                overflow: 'hidden',
                                textOverflow: 'ellipsis',
                                whiteSpace: 'nowrap',
                                maxWidth: '100%'
                            }}>
                                {project.title}
                            </button>
                        ))}
                    </div>
                </div>
            )}
            {selectedProject && (
                <div className="card" style={{ width: '320px', display: 'flex', flexDirection: 'column', maxHeight: '100%', overflow: 'hidden' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', paddingBottom: '12px', borderBottom: '1px solid var(--bf-surface-200)', gap: '8px' }}>
                        <h3 style={{ 
                            margin: 0,
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            whiteSpace: 'nowrap',
                            flex: 1,
                            minWidth: 0
                        }}>{selectedProject.title}</h3>
                        <button className="btn btn-secondary" onClick={() => { setSelectedProject(null); if (viewScope === 'single') loadData(); }} style={{ padding: '4px 8px', fontSize: 'var(--bf-font-size-sm)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <Icon name="close" size={14} />
                        </button>
                    </div>
                    <div style={{ flex: 1, overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '8px', paddingBottom: '12px', borderBottom: '1px solid var(--bf-surface-200)' }}>
                            <button className="btn btn-primary" onClick={() => {
                                const title = prompt('New task title:');
                                if (title) {
                                    StorageService.createTask({ title, project_id: selectedProject.id, status: 'todo' });
                                    loadData();
                                }
                            }} style={{ fontSize: 'var(--bf-font-size-sm)' }}>+ Add Task</button>
                            <button className="btn btn-secondary" onClick={() => {
                                const title = prompt('New child project title:');
                                if (title) {
                                    StorageService.createProject({ title, parent_project_id: selectedProject.id });
                                    loadData();
                                    Utils.showToast('Child project created', 'success');
                                }
                            }} style={{ fontSize: 'var(--bf-font-size-sm)' }}>+ Create Child Project</button>
                            <button className="btn btn-secondary" onClick={() => {
                                const allProjects = StorageService.getProjects().filter(p => !p.archived && p.id !== selectedProject.id);
                                if (allProjects.length === 0) {
                                    Utils.showToast('No other projects available', 'warning');
                                    return;
                                }
                                const projectNames = allProjects.map(p => p.title).join('\n');
                                const selectedName = prompt(`Link this project to another project?\n\nAvailable projects:\n${projectNames}\n\nEnter project name (or leave empty to unlink):`);
                                if (selectedName !== null) {
                                    if (selectedName === '') {
                                        StorageService.updateProject(selectedProject.id, { parent_project_id: null });
                                        loadData();
                                        setSelectedProject({ ...selectedProject, parent_project_id: null });
                                        Utils.showToast('Project unlinked', 'success');
                                    } else {
                                        const parentProject = allProjects.find(p => p.title === selectedName);
                                        if (parentProject) {
                                            StorageService.updateProject(selectedProject.id, { parent_project_id: parentProject.id });
                                            loadData();
                                            setSelectedProject({ ...selectedProject, parent_project_id: parentProject.id });
                                            Utils.showToast('Project linked', 'success');
                                        } else {
                                            Utils.showToast('Project not found', 'error');
                                        }
                                    }
                                }
                            }} style={{ fontSize: 'var(--bf-font-size-sm)' }}>🔗 Link to Project</button>
                            {selectedProject.parent_project_id && (
                                <div style={{ fontSize: 'var(--bf-font-size-xs)', color: 'var(--bf-text-500)', padding: '8px', backgroundColor: 'var(--bf-surface-100)', borderRadius: 'var(--bf-radius-sm)' }}>
                                    Linked to: {StorageService.getProject(selectedProject.parent_project_id)?.title || 'Unknown'}
                                </div>
                            )}
                        </div>
                        {getProjectTasks(selectedProject.id).filter(t => !t.parent_id).map(task => {
                            const subtasks = getProjectTasks(selectedProject.id).filter(t => t.parent_id === task.id);
                            return (
                                <div key={task.id} style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                    <TaskCard task={task} onUpdate={loadData} />
                                    {subtasks.length > 0 && (
                                        <div style={{ marginLeft: '24px', display: 'flex', flexDirection: 'column', gap: '4px', borderLeft: '2px solid var(--bf-surface-200)', paddingLeft: '8px' }}>
                                            {subtasks.map(subtask => (
                                                <TaskCard key={subtask.id} task={subtask} onUpdate={loadData} />
                                            ))}
                                        </div>
                                    )}
                                    <button className="btn btn-secondary" onClick={() => {
                                        const title = prompt('Subtask title:');
                                        if (title) {
                                            StorageService.createTask({ title, project_id: selectedProject.id, parent_id: task.id, status: 'todo' });
                                            loadData();
                                        }
                                    }} style={{ marginLeft: '24px', fontSize: 'var(--bf-font-size-xs)', padding: '2px 6px' }}>+ Subtask</button>
                                </div>
                            );
                        })}
                        {getProjectTasks(selectedProject.id).length === 0 && (
                            <div style={{ textAlign: 'center', padding: '16px', color: 'var(--bf-text-500)' }}>No tasks in this project</div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
}

function HabitsPage() {
    const [habits, setHabits] = useState([]);
    const [currentMonth, setCurrentMonth] = useState(new Date());
    const [viewMode, setViewMode] = useState('compact'); // 'compact' or 'detailed'
    const [tileSize, setTileSize] = useState(28); // Size in pixels for detailed view
    const { refresh } = useRefresh();
    useEffect(() => { loadHabits(); }, []);
    const loadHabits = () => {
        const saved = JSON.parse(localStorage.getItem('blitzfit_habits') || '[]');
        setHabits(saved);
    };
    const saveHabits = (newHabits) => {
        localStorage.setItem('blitzfit_habits', JSON.stringify(newHabits));
        setHabits(newHabits);
    };
    const addHabit = () => {
        const name = prompt('Habit name:');
        if (name) {
            const colors = ['#9333EA', '#84CC16', '#06B6D4', '#F59E0B', '#EC4899', '#8B5CF6', '#10B981', '#F97316'];
            const newHabit = {
                id: StorageService.generateId(),
                name,
                color: colors[Math.floor(Math.random() * colors.length)],
                created_at: new Date().toISOString(),
                entries: {}
            };
            saveHabits([...habits, newHabit]);
        }
    };
    const toggleHabitDay = (habitId, date) => {
        const dateStr = date.toISOString().split('T')[0];
        const updated = habits.map(h => {
            if (h.id === habitId) {
                const entries = { ...h.entries };
                entries[dateStr] = !entries[dateStr];
                return { ...h, entries };
            }
            return h;
        });
        saveHabits(updated);
    };
    const getDaysInMonth = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        const days = [];
        for (let i = 0; i < startingDayOfWeek; i++) {
            days.push(null);
        }
        for (let i = 1; i <= daysInMonth; i++) {
            days.push(new Date(year, month, i));
        }
        return days;
    };
    const days = getDaysInMonth(currentMonth);
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const getStreak = (habit) => {
        let streak = 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        for (let i = 0; i < 365; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            if (habit.entries[dateStr]) {
                streak++;
            } else {
                break;
            }
        }
        return streak;
    };
    const getCompletionRate = (habit) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let completed = 0;
        let total = 0;
        for (let i = 0; i < 30; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            total++;
            if (habit.entries[dateStr]) completed++;
        }
        return total > 0 ? Math.round((completed / total) * 100) : 0;
    };
    const navigateMonth = (direction) => {
        setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + direction, 1));
    };
    return (
        <div>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px', flexWrap: 'wrap', gap: '16px' }}>
                <h1 style={{ fontSize: 'var(--bf-font-size-2xl)', fontWeight: 700 }}>Habits</h1>
                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                    <button className={`btn ${viewMode === 'compact' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setViewMode('compact')}>Compact</button>
                    <button className={`btn ${viewMode === 'detailed' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setViewMode('detailed')}>Detailed</button>
                    <button className="btn btn-primary" onClick={addHabit}>+ New Habit</button>
                </div>
            </div>
            {habits.length === 0 ? (
                <div style={{ textAlign: 'center', padding: '48px', color: 'var(--bf-text-500)' }}>
                    <div style={{ marginBottom: '16px', display: 'flex', justifyContent: 'center' }}>
                        <Icon name="habits" size={64} color="var(--bf-text-500)" />
                    </div>
                    <div style={{ fontSize: 'var(--bf-font-size-lg)', marginBottom: '8px' }}>No habits yet</div>
                    <div style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)' }}>Create your first habit to start tracking!</div>
                </div>
            ) : (
                <div style={{ display: 'grid', gridTemplateColumns: viewMode === 'compact' ? 'repeat(auto-fill, minmax(280px, 1fr))' : '1fr', gap: '16px' }}>
                    {habits.map(habit => {
                        const streak = getStreak(habit);
                        const completionRate = getCompletionRate(habit);
                        return (
                            <div key={habit.id} className="card" style={{ 
                                background: viewMode === 'compact' ? `linear-gradient(135deg, ${habit.color}15, ${habit.color}05)` : 'var(--bf-surface-100)',
                                border: `2px solid ${habit.color}40`,
                                position: 'relative',
                                overflow: 'hidden'
                            }}>
                                {viewMode === 'compact' && (
                                    <div style={{ 
                                        position: 'absolute', 
                                        top: 0, 
                                        right: 0, 
                                        width: '60px', 
                                        height: '60px', 
                                        background: `linear-gradient(135deg, ${habit.color}, ${habit.color}80)`,
                                        borderRadius: '0 0 0 100%',
                                        opacity: 0.1
                                    }}></div>
                                )}
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px', position: 'relative', zIndex: 1 }}>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '6px' }}>
                                            <div style={{ 
                                                width: viewMode === 'compact' ? '8px' : '12px', 
                                                height: viewMode === 'compact' ? '8px' : '12px', 
                                                borderRadius: '50%', 
                                                backgroundColor: habit.color, 
                                                boxShadow: `0 0 8px ${habit.color}60`,
                                                flexShrink: 0
                                            }}></div>
                                            <h3 style={{ 
                                                margin: 0, 
                                                fontSize: viewMode === 'compact' ? 'var(--bf-font-size-base)' : 'var(--bf-font-size-lg)',
                                                fontWeight: 600,
                                                color: 'var(--bf-text-900)'
                                            }}>{habit.name}</h3>
                                        </div>
                                        <div style={{ display: 'flex', gap: '12px', alignItems: 'center', fontSize: 'var(--bf-font-size-xs)', color: 'var(--bf-text-500)' }}>
                                            <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                🔥 {streak} day{streak !== 1 ? 's' : ''}
                                            </span>
                                            <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                <Icon name="check" size={12} color="var(--bf-success-500)" style={{ display: 'inline-block', marginRight: '4px' }} />
                                                {completionRate}%
                                            </span>
                                        </div>
                                    </div>
                                    <button className="btn btn-secondary" onClick={() => {
                                        if (confirm(`Delete habit "${habit.name}"?`)) {
                                            saveHabits(habits.filter(h => h.id !== habit.id));
                                        }
                                    }} style={{ padding: '4px 8px', fontSize: 'var(--bf-font-size-xs)', minWidth: 'auto', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                        <Icon name="close" size={12} />
                                    </button>
                                </div>
                                {viewMode === 'detailed' && (
                                    <>
                                        <div style={{ marginBottom: '12px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-700)' }}>
                                            <span>{monthNames[currentMonth.getMonth()]} {currentMonth.getFullYear()}</span>
                                            <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: 'var(--bf-font-size-xs)' }}>
                                                    <span>Size:</span>
                                                    <button className="btn btn-secondary" onClick={() => setTileSize(Math.max(16, tileSize - 4))} style={{ padding: '2px 6px', fontSize: 'var(--bf-font-size-xs)', minWidth: 'auto' }}>−</button>
                                                    <span style={{ minWidth: '30px', textAlign: 'center' }}>{tileSize}px</span>
                                                    <button className="btn btn-secondary" onClick={() => setTileSize(Math.min(48, tileSize + 4))} style={{ padding: '2px 6px', fontSize: 'var(--bf-font-size-xs)', minWidth: 'auto' }}>+</button>
                                                </div>
                                                <button className="btn btn-secondary" onClick={() => navigateMonth(-1)} style={{ padding: '2px 8px', fontSize: 'var(--bf-font-size-xs)' }}>←</button>
                                                <button className="btn btn-secondary" onClick={() => setCurrentMonth(new Date())} style={{ padding: '2px 8px', fontSize: 'var(--bf-font-size-xs)' }}>Today</button>
                                                <button className="btn btn-secondary" onClick={() => navigateMonth(1)} style={{ padding: '2px 8px', fontSize: 'var(--bf-font-size-xs)' }}>→</button>
                                            </div>
                                        </div>
                                        <div style={{ marginBottom: '8px' }}>
                                            <input 
                                                type="range" 
                                                min="16" 
                                                max="48" 
                                                step="2" 
                                                value={tileSize} 
                                                onChange={(e) => setTileSize(parseInt(e.target.value))}
                                                style={{ width: '100%' }}
                                            />
                                        </div>
                                    </>
                                )}
                                {viewMode === 'detailed' && (
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '2px', marginBottom: '8px' }}>
                                        {dayNames.map(day => (
                                            <div key={day} style={{ 
                                                textAlign: 'center', 
                                                fontSize: 'var(--bf-font-size-xs)', 
                                                fontWeight: 600, 
                                                color: 'var(--bf-text-500)',
                                                padding: '4px 0'
                                            }}>{day}</div>
                                        ))}
                                    </div>
                                )}
                                <div style={{ 
                                    display: 'grid', 
                                    gridTemplateColumns: viewMode === 'compact' ? 'repeat(14, 1fr)' : 'repeat(7, 1fr)', 
                                    gap: viewMode === 'compact' ? '2px' : (tileSize < 24 ? '2px' : '3px'),
                                    justifyContent: viewMode === 'detailed' ? 'start' : 'stretch'
                                }}>
                                    {days.map((date, index) => {
                                        if (!date) return <div key={index}></div>;
                                        const dateStr = date.toISOString().split('T')[0];
                                        const isChecked = habit.entries[dateStr];
                                        const isToday = date.toDateString() === new Date().toDateString();
                                        const isPast = date < new Date() && !isToday;
                                        return (
                                            <div
                                                key={index}
                                                onClick={() => toggleHabitDay(habit.id, date)}
                                                style={{
                                                    aspectRatio: '1',
                                                    minHeight: viewMode === 'compact' ? '20px' : `${tileSize}px`,
                                                    width: viewMode === 'detailed' ? `${tileSize}px` : 'auto',
                                                    backgroundColor: isChecked 
                                                        ? habit.color 
                                                        : isPast 
                                                            ? 'var(--bf-surface-200)' 
                                                            : 'var(--bf-surface-100)',
                                                    borderRadius: viewMode === 'compact' ? '3px' : 'var(--bf-radius-sm)',
                                                    cursor: 'pointer',
                                                    border: isToday 
                                                        ? `2px solid ${habit.color}` 
                                                        : isChecked 
                                                            ? `1px solid ${habit.color}80` 
                                                            : '1px solid var(--bf-surface-200)',
                                                    opacity: isChecked ? 1 : (isPast ? 0.4 : 0.7),
                                                    transition: 'all var(--bf-transition-base)',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    fontSize: viewMode === 'compact' ? '10px' : (tileSize < 24 ? '10px' : tileSize < 32 ? 'var(--bf-font-size-xs)' : 'var(--bf-font-size-sm)'),
                                                    color: isChecked ? 'white' : 'var(--bf-text-500)',
                                                    position: 'relative',
                                                    boxShadow: isChecked ? `0 2px 4px ${habit.color}40` : 'none'
                                                }}
                                                onMouseEnter={(e) => {
                                                    if (!isChecked) {
                                                        e.currentTarget.style.backgroundColor = `${habit.color}30`;
                                                        e.currentTarget.style.transform = 'scale(1.1)';
                                                        e.currentTarget.style.zIndex = 10;
                                                    }
                                                }}
                                                onMouseLeave={(e) => {
                                                    if (!isChecked) {
                                                        e.currentTarget.style.backgroundColor = isPast ? 'var(--bf-surface-200)' : 'var(--bf-surface-100)';
                                                        e.currentTarget.style.transform = 'scale(1)';
                                                        e.currentTarget.style.zIndex = 1;
                                                    }
                                                }}
                                                title={`${date.toLocaleDateString()}${isChecked ? ' ✓' : ''}`}
                                            >
                                                {viewMode === 'detailed' && date.getDate()}
                                                {viewMode === 'compact' && isChecked && <Icon name="check" size={10} color="white" style={{ strokeWidth: 3 }} />}
                                            </div>
                                        );
                                    })}
                                </div>
                                {viewMode === 'compact' && (
                                    <div style={{ marginTop: '12px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: 'var(--bf-font-size-xs)', color: 'var(--bf-text-500)' }}>
                                        <span>{monthNames[currentMonth.getMonth()].substring(0, 3)}</span>
                                        <div style={{ display: 'flex', gap: '4px' }}>
                                            <button className="btn btn-secondary" onClick={() => navigateMonth(-1)} style={{ padding: '2px 6px', fontSize: '10px', minWidth: 'auto' }}>←</button>
                                            <button className="btn btn-secondary" onClick={() => navigateMonth(1)} style={{ padding: '2px 6px', fontSize: '10px', minWidth: 'auto' }}>→</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            )}
        </div>
    );
}

function SettingsPage() {
    const { theme, setTheme } = useTheme();
    const { logout } = useAuth();
    const [fontSize, setFontSize] = useState(StorageService.getSettings().fontSize || 16);
    const availableSections = [
        { id: 'dashboard', label: 'Dashboard', icon: 'dashboard' },
        { id: 'inbox', label: 'Inbox', icon: 'inbox' },
        { id: 'today', label: 'Today', icon: 'today' },
        { id: 'mindmap', label: 'Mind Map', icon: 'mindmap', required: true },
        { id: 'projects', label: 'Projects', icon: 'projects' },
        { id: 'calendar', label: 'Calendar', icon: 'calendar' },
        { id: 'habits', label: 'Habits', icon: 'habits' },
    ];
    const [visibleSections, setVisibleSections] = useState(() => {
        const saved = StorageService.getSettings().visibleSections;
        if (saved) return saved;
        // Default: all sections visible
        return availableSections.map(s => s.id);
    });
    useEffect(() => {
        const saved = StorageService.getSettings().fontSize || 16;
        document.documentElement.style.setProperty('--bf-font-size-base', `${saved}px`);
        setFontSize(saved);
    }, []);
    const toggleSection = (sectionId) => {
        const section = availableSections.find(s => s.id === sectionId);
        if (section?.required) return; // Can't hide required sections
        const newVisible = visibleSections.includes(sectionId)
            ? visibleSections.filter(id => id !== sectionId)
            : [...visibleSections, sectionId];
        setVisibleSections(newVisible);
        StorageService.updateSettings({ visibleSections: newVisible });
        // Reload page to apply changes
        window.location.reload();
    };
    return (
        <div>
            <h1 style={{ fontSize: 'var(--bf-font-size-2xl)', fontWeight: 700, marginBottom: '24px' }}>Settings</h1>
            <div className="card" style={{ marginBottom: '16px' }}>
                <h3 style={{ marginBottom: '16px' }}>Visible Sections</h3>
                <p style={{ fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)', marginBottom: '16px' }}>
                    Vyberte sekce, které chcete zobrazit v navigaci. Mind Map je vždy zobrazena.
                </p>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                    {availableSections.map(section => (
                        <label key={section.id} style={{ display: 'flex', alignItems: 'center', gap: '12px', padding: '12px', borderRadius: 'var(--bf-radius-md)', backgroundColor: visibleSections.includes(section.id) ? 'var(--bf-surface-100)' : 'transparent', border: `2px solid ${visibleSections.includes(section.id) ? 'var(--bf-primary-500)' : 'var(--bf-surface-200)'}`, cursor: section.required ? 'not-allowed' : 'pointer', opacity: section.required ? 0.7 : 1 }}>
                            <input
                                type="checkbox"
                                checked={visibleSections.includes(section.id)}
                                onChange={() => toggleSection(section.id)}
                                disabled={section.required}
                                style={{ width: '20px', height: '20px', cursor: section.required ? 'not-allowed' : 'pointer' }}
                            />
                            <Icon name={section.icon} size={20} color={visibleSections.includes(section.id) ? 'var(--bf-primary-500)' : 'var(--bf-text-500)'} />
                            <span style={{ flex: 1, fontSize: 'var(--bf-font-size-base)', fontWeight: visibleSections.includes(section.id) ? 500 : 400 }}>
                                {section.label}
                                {section.required && <span style={{ fontSize: 'var(--bf-font-size-xs)', color: 'var(--bf-text-500)', marginLeft: '8px' }}>(vždy zobrazeno)</span>}
                            </span>
                        </label>
                    ))}
                </div>
            </div>
            <div className="card" style={{ marginBottom: '16px' }}>
                <h3 style={{ marginBottom: '12px' }}>Theme</h3>
                <select className="input" value={theme} onChange={(e) => setTheme(e.target.value)} style={{ maxWidth: '200px' }}>
                    <option value="light">Light</option>
                    <option value="dark">Dark (Purple)</option>
                    <option value="dark-blue">Dark (Blue)</option>
                    <option value="dark-green">Dark (Green)</option>
                    <option value="mind-eye">Mind-Eye (Special)</option>
                    <option value="high-contrast">High Contrast</option>
                </select>
                {theme === 'mind-eye' && (
                    <div style={{ marginTop: '12px', padding: '12px', backgroundColor: 'var(--bf-surface-100)', borderRadius: 'var(--bf-radius-sm)', fontSize: 'var(--bf-font-size-sm)', color: 'var(--bf-text-500)', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <Icon name="habits" size={16} color="var(--bf-text-500)" />
                        Speciální theme s animovaným pozadím a moderním designem
                    </div>
                )}
                <div style={{ marginTop: '12px' }}>
                    <label style={{ display: 'block', marginBottom: '8px', fontSize: 'var(--bf-font-size-sm)' }}>Font Size</label>
                    <input type="range" min="12" max="20" step="1" value={fontSize} onChange={(e) => {
                        const newSize = parseInt(e.target.value);
                        StorageService.updateSettings({ fontSize: newSize });
                        document.documentElement.style.setProperty('--bf-font-size-base', `${newSize}px`);
                        setFontSize(newSize);
                    }} style={{ width: '100%' }} />
                    <div style={{ fontSize: 'var(--bf-font-size-xs)', color: 'var(--bf-text-500)', marginTop: '4px' }}>
                        {fontSize}px
                    </div>
                </div>
            </div>
            <div className="card">
                <h3 style={{ marginBottom: '12px' }}>Account</h3>
                <button className="btn btn-secondary" onClick={logout}>Logout</button>
            </div>
        </div>
    );
}

function LoginPage() {
    const [email, setEmail] = useState('');
    const [name, setName] = useState('');
    const [isRegistering, setIsRegistering] = useState(false);
    const { login, register, isLoading } = useAuth();
    const handleSubmit = async (e) => {
        e.preventDefault();
        if (isRegistering) await register(email, name);
        else await login(email);
        window.location.hash = 'dashboard';
    };
    return (
        <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'linear-gradient(135deg, var(--bf-primary-500) 0%, var(--bf-success-500) 100%)' }}>
            <div className="card" style={{ width: '100%', maxWidth: '400px', padding: '32px' }}>
                <h1 style={{ fontSize: 'var(--bf-font-size-3xl)', fontWeight: 700, background: 'linear-gradient(135deg, var(--bf-primary-500), var(--bf-success-500))', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', backgroundClip: 'text', textAlign: 'center', marginBottom: '8px' }}>⚡ Blitzfit</h1>
                <p style={{ textAlign: 'center', color: 'var(--bf-text-700)', marginBottom: '24px' }}>Personal coordination platform</p>
                <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                    {isRegistering && <input type="text" className="input" placeholder="Name (optional)" value={name} onChange={(e) => setName(e.target.value)} />}
                    <input type="email" className="input" placeholder="Email" value={email} onChange={(e) => setEmail(e.target.value)} required />
                    <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Loading...' : (isRegistering ? 'Register' : 'Login')}</button>
                    <button type="button" onClick={() => setIsRegistering(!isRegistering)} style={{ background: 'none', border: 'none', color: 'var(--bf-success-500)', cursor: 'pointer', textDecoration: 'underline', fontSize: 'var(--bf-font-size-sm)', fontWeight: 500 }}>{isRegistering ? 'Already have an account? Login' : 'Need an account? Register'}</button>
                </form>
            </div>
        </div>
    );
}
    </script>

    <script type="text/babel">
// Blitzfit - Main Application
const { useState, useEffect } = React;

function Layout({ currentPage, setCurrentPage }) {
    const { user, logout } = useAuth();
    const { theme, toggleTheme } = useTheme();
    const { refreshKey, refresh } = useRefresh();
    const [commandPaletteOpen, setCommandPaletteOpen] = useState(false);
    const allNavItems = [
        { id: 'dashboard', label: 'Dashboard', icon: 'dashboard' },
        { id: 'inbox', label: 'Inbox', icon: 'inbox' },
        { id: 'today', label: 'Today', icon: 'today' },
        { id: 'mindmap', label: 'Mind Map', icon: 'mindmap', required: true },
        { id: 'projects', label: 'Projects', icon: 'projects' },
        { id: 'calendar', label: 'Calendar', icon: 'calendar' },
        { id: 'habits', label: 'Habits', icon: 'habits' },
        { id: 'settings', label: 'Settings', icon: 'settings' },
    ];
    // Get visible sections from settings
    const visibleSections = StorageService.getSettings().visibleSections || allNavItems.map(item => item.id);
    const navItems = allNavItems.filter(item => visibleSections.includes(item.id) || item.id === 'settings');
    useEffect(() => {
        const handleKeyDown = (e) => {
            if (Utils.isModKey(e) && e.key === 'k') {
                e.preventDefault();
                setCommandPaletteOpen(true);
            }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, []);
    useEffect(() => {
        const hash = window.location.hash.slice(1) || 'dashboard';
        setCurrentPage(hash);
        const handleHashChange = () => {
            const newHash = window.location.hash.slice(1) || 'dashboard';
            setCurrentPage(newHash);
        };
        window.addEventListener('hashchange', handleHashChange);
        return () => window.removeEventListener('hashchange', handleHashChange);
    }, []);
    const handleNavClick = (id) => {
        window.location.hash = id;
        setCurrentPage(id);
    };
    return (
        <div style={{ display: 'flex', flexDirection: 'column', height: '100vh', overflow: 'hidden', backgroundColor: 'var(--bf-bg)' }}>
            {/* Top Navigation Bar - Modern Modular Design */}
            <header style={{ 
                padding: '12px 24px', 
                borderBottom: '1px solid var(--bf-surface-200)', 
                background: 'linear-gradient(135deg, var(--bf-surface-100) 0%, rgba(147, 51, 234, 0.05) 100%)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                gap: '16px',
                flexShrink: 0
            }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '16px', flex: 1 }}>
                    <h1 style={{ fontSize: 'var(--bf-font-size-xl)', fontWeight: 700, background: 'linear-gradient(135deg, var(--bf-primary-500), var(--bf-success-500))', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', backgroundClip: 'text', margin: 0, display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <Icon name="lightning" size={24} color="var(--bf-primary-500)" style={{ fill: 'var(--bf-primary-500)', stroke: 'none' }} />
                        Blitzfit
                    </h1>
                    {/* Modular Navigation Pills */}
                    <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', alignItems: 'center' }}>
                        {navItems.map(item => (
                            <button 
                                key={item.id} 
                                onClick={() => handleNavClick(item.id)} 
                                style={{ 
                                    display: 'flex', 
                                    alignItems: 'center', 
                                    gap: '8px', 
                                    padding: '8px 16px', 
                                    borderRadius: 'var(--bf-radius-lg)', 
                                    color: currentPage === item.id ? 'white' : 'var(--bf-text-700)', 
                                    backgroundColor: currentPage === item.id ? 'var(--bf-primary-500)' : 'var(--bf-surface-100)', 
                                    border: currentPage === item.id ? 'none' : '1px solid var(--bf-surface-200)',
                                    cursor: 'pointer', 
                                    fontSize: 'var(--bf-font-size-sm)', 
                                    fontWeight: currentPage === item.id ? 600 : 400, 
                                    transition: 'all var(--bf-transition-base)',
                                    boxShadow: currentPage === item.id ? '0 2px 8px rgba(147, 51, 234, 0.3)' : 'none'
                                }}
                            >
                                <Icon name={item.icon} size={18} color={currentPage === item.id ? 'white' : 'var(--bf-text-700)'} />
                                <span>{item.label}</span>
                            </button>
                        ))}
                    </div>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <button onClick={toggleTheme} style={{ padding: '8px', borderRadius: 'var(--bf-radius-md)', color: 'var(--bf-text-700)', backgroundColor: 'transparent', border: '1px solid var(--bf-surface-200)', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <Icon name="theme" size={18} color="var(--bf-text-700)" />
                    </button>
                    <button onClick={logout} style={{ padding: '8px', borderRadius: 'var(--bf-radius-md)', color: 'var(--bf-text-700)', backgroundColor: 'transparent', border: '1px solid var(--bf-surface-200)', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <Icon name="logout" size={18} color="var(--bf-text-700)" />
                    </button>
                </div>
            </header>
            {/* Main Content Area */}
            <main style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden', backgroundColor: 'var(--bf-bg)' }}>
                {/* Quick Capture Bar */}
                <div style={{ padding: '12px 24px', borderBottom: '1px solid var(--bf-surface-200)', background: 'var(--bf-surface-100)', flexShrink: 0 }}>
                    <QuickCapture onTaskAdded={refresh} />
                </div>
                {/* Page Content */}
                <div style={{ flex: 1, overflowY: 'auto', padding: '24px' }}>
                    {currentPage === 'dashboard' && <DashboardPage refreshKey={refreshKey} />}
                    {currentPage === 'inbox' && <InboxPage refreshKey={refreshKey} />}
                    {currentPage === 'today' && <TodayPage refreshKey={refreshKey} />}
                    {currentPage === 'mindmap' && <MindMapPage refreshKey={refreshKey} />}
                    {currentPage === 'projects' && <ProjectsPage refreshKey={refreshKey} />}
                    {currentPage === 'calendar' && <CalendarPage />}
                    {currentPage === 'habits' && <HabitsPage />}
                    {currentPage === 'settings' && <SettingsPage />}
                </div>
            </main>
            <CommandPalette isOpen={commandPaletteOpen} onClose={() => setCommandPaletteOpen(false)} />
        </div>
    );
}

function App() {
    const [currentPage, setCurrentPage] = useState('dashboard');
    const { user } = useAuth();
    useEffect(() => {
        const hash = window.location.hash.slice(1) || 'dashboard';
        setCurrentPage(hash);
        const handleHashChange = () => {
            const newHash = window.location.hash.slice(1) || 'dashboard';
            setCurrentPage(newHash);
        };
        window.addEventListener('hashchange', handleHashChange);
        return () => window.removeEventListener('hashchange', handleHashChange);
    }, []);
    if (!user) return <LoginPage />;
    return (
        <RefreshProvider>
            <Layout currentPage={currentPage} setCurrentPage={setCurrentPage} />
        </RefreshProvider>
    );
}
    </script>

    <script type="text/babel">
// Blitzfit - Entry Point
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
    <ThemeProvider>
        <AuthProvider>
            <App />
        </AuthProvider>
    </ThemeProvider>
);
    </script>
</body>
</html>
