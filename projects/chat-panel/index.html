<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdHub Multistream Chat v2</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <h1 class="app-title">
                    <span class="logo-icon">üí¨</span>
                    Multistream Chat
                    <span class="version-badge">v2</span>
                </h1>
            </div>
            <div class="header-center">
                <div class="connection-status" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span class="status-text">Nep≈ôipojeno</span>
                </div>
            </div>
            <div class="header-right">
                <button class="btn btn-icon btn-extension" id="extensionBtn" title="Chrome Extension">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                    </svg>
                    <span class="extension-status-dot" id="extensionStatusDot"></span>
                </button>
                <button class="btn btn-icon" id="settingsBtn" title="Nastaven√≠">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
                <button class="btn btn-icon" id="themeToggle" title="P≈ôepnout t√©ma">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Sidebar - Channel List -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h2>Kan√°ly</h2>
                    <button class="btn btn-primary btn-sm" id="addChannelBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        P≈ôidat
                    </button>
                </div>
                <div class="channel-filter-hint">
                    <span class="hint-icon">üí°</span>
                    <span class="hint-text">Klikni na kan√°l pro zv√Ωraznƒõn√≠ jeho zpr√°v</span>
                </div>
                <div class="channel-filter-active hidden" id="channelFilterActive">
                    <span class="filter-status">
                        <span class="filter-icon">‚òÖ</span>
                        <span class="filter-count" id="filterCount">0</span> zv√Ωraznƒõno
                    </span>
                    <button class="btn btn-sm btn-clear-filter" id="clearFilterBtn">
                        Zru≈°it filtr
                    </button>
                </div>
                <div class="channel-list" id="channelList">
                    <!-- Channels will be added here dynamically -->
                    <div class="channel-empty-state">
                        <p>Zat√≠m nem√°te ≈æ√°dn√© kan√°ly.</p>
                        <p class="hint">Kliknƒõte na "P≈ôidat" pro p≈ôipojen√≠ k chatu.</p>
                    </div>
                </div>
            </aside>

            <!-- Chat Area -->
            <section class="chat-area">
                <div class="chat-container" id="chatContainer">
                    <!-- Chat messages will be rendered here -->
                    <div class="chat-welcome">
                        <div class="welcome-icon">üéÆ</div>
                        <h2>V√≠tejte v Multistream Chat v2</h2>
                        <p>P≈ôidejte kan√°ly z Twitch, Kick nebo YouTube pro zobrazen√≠ chatu.</p>
                        <div class="platform-badges">
                            <span class="platform-badge twitch">Twitch</span>
                            <span class="platform-badge kick">Kick</span>
                            <span class="platform-badge youtube">YouTube</span>
                        </div>
                        <p class="note">Tato verze funguje kompletnƒõ v prohl√≠≈æeƒçi - ≈æ√°dn√Ω server nen√≠ pot≈ôeba!</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add Channel Modal -->
    <div class="modal-overlay" id="addChannelModal">
        <div class="modal">
            <div class="modal-header">
                <h3>P≈ôidat kan√°l</h3>
                <button class="btn btn-icon modal-close" id="closeAddModal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="platform-selector">
                    <button class="platform-btn twitch active" data-platform="twitch">
                        <svg class="platform-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M11.64 5.93h1.43v4.28h-1.43m3.93-4.28H17v4.28h-1.43M4.5 0L0 4.5v15h5.25V24l4.5-4.5h3.5L22.5 12V0zm15.75 11.25l-3.25 3.25h-3.5l-2.88 2.88V14.5h-4V2.25h13.63z"/>
                        </svg>
                        Twitch
                    </button>
                    <button class="platform-btn kick" data-platform="kick">
                        <svg class="platform-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6.5 3h3v7.5L15 3h4l-6.5 9L19 21h-4l-5.5-7.5V21h-3V3z"/>
                        </svg>
                        Kick
                    </button>
                    <button class="platform-btn youtube" data-platform="youtube">
                        <svg class="platform-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                        </svg>
                        YouTube
                    </button>
                </div>

                <!-- Twitch Form -->
                <form class="platform-form" id="twitchForm">
                    <div class="form-group">
                        <label for="twitchChannel">N√°zev kan√°lu</label>
                        <input type="text" id="twitchChannel" placeholder="nap≈ô. gamezense" autocomplete="off">
                        <span class="input-hint">Zadejte jm√©no Twitch kan√°lu bez URL</span>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">P≈ôipojit k chatu</button>
                </form>

                <!-- Kick Form -->
                <form class="platform-form hidden" id="kickForm">
                    <div class="form-group">
                        <label for="kickChannel">N√°zev kan√°lu nebo chatroom ID</label>
                        <input type="text" id="kickChannel" placeholder="nap≈ô. trainwreckstv nebo xqc:668" autocomplete="off">
                        <span class="input-hint">
                            Zn√°m√© kan√°ly: xqc, trainwreckstv, adinross, stake, roshtein, nickmercs...<br>
                            Pro ostatn√≠ zadejte: <strong>n√°zev:chatroomID</strong> (nap≈ô. streamer:12345)
                        </span>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">P≈ôipojit k chatu</button>
                </form>

                <!-- YouTube Form -->
                <form class="platform-form hidden" id="youtubeForm">
                    <!-- Mode selector -->
                    <div class="youtube-mode-selector">
                        <button type="button" class="youtube-mode-btn" data-mode="extension">
                            <span class="mode-icon">üß©</span>
                            <span class="mode-name">Extension</span>
                            <span class="mode-hint">Kombinovany chat</span>
                        </button>
                        <button type="button" class="youtube-mode-btn active" data-mode="iframe">
                            <span class="mode-icon">üì∫</span>
                            <span class="mode-name">Iframe</span>
                            <span class="mode-hint">Samostatny panel</span>
                        </button>
                        <button type="button" class="youtube-mode-btn" data-mode="api">
                            <span class="mode-icon">üîå</span>
                            <span class="mode-name">API</span>
                            <span class="mode-hint">Vyzaduje klic</span>
                        </button>
                    </div>

                    <!-- Extension mode fields -->
                    <div class="youtube-mode-fields hidden" id="youtubeExtensionFields">
                        <div class="extension-status-box" id="extensionStatusBox">
                            <div class="extension-status-icon" id="extensionStatusIcon">?</div>
                            <div class="extension-status-text" id="extensionStatusText">Kontroluji extension...</div>
                        </div>
                        <div class="form-group">
                            <label for="youtubeExtChannel">Video URL nebo ID</label>
                            <input type="text" id="youtubeExtChannel" placeholder="youtube.com/watch?v=... nebo video ID" autocomplete="off">
                            <span class="input-hint">
                                Zadejte URL nebo ID ziveho streamu.<br>
                                <strong>Vyhoda:</strong> Zpravy se zobrazi spolecne s Twitch/Kick
                            </span>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block" data-mode="extension" id="youtubeExtSubmit">Pripojit k chatu</button>
                        <div class="extension-download-section" id="extensionDownloadSection">
                            <p class="extension-download-hint" id="extensionDownloadHint">Stahnout nebo aktualizovat rozsireni:</p>
                            <button type="button" class="btn btn-secondary btn-block" id="downloadExtensionBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                <span id="downloadExtensionBtnText">Stahnout AdHub Chat Reader Extension</span>
                            </button>
                            <p class="extension-version-info hidden" id="extensionVersionInfo"></p>
                            <p class="extension-commit-info hidden" id="extensionCommitInfo"></p>
                        </div>
                    </div>

                    <!-- Iframe mode fields -->
                    <div class="youtube-mode-fields" id="youtubeIframeFields">
                        <div class="form-group">
                            <label for="youtubeChannel">Kanal nebo Video ID</label>
                            <input type="text" id="youtubeChannel" placeholder="napr. @MrBeast, UC..., nebo video ID" autocomplete="off">
                            <span class="input-hint">
                                Zadejte: @handle, channel ID (UC...), video ID, nebo celou URL<br>
                                <strong>Pozor:</strong> Iframe zobrazi chat v samostatnem panelu
                            </span>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block" data-mode="iframe">Zobrazit chat (iframe)</button>
                    </div>

                    <!-- API mode fields -->
                    <div class="youtube-mode-fields hidden" id="youtubeApiFields">
                        <div class="form-group">
                            <label for="youtubeVideoId">Video/Stream ID</label>
                            <input type="text" id="youtubeVideoId" placeholder="napr. dQw4w9WgXcQ" autocomplete="off">
                            <span class="input-hint">ID videa z URL: youtube.com/watch?v=<strong>ID</strong></span>
                        </div>
                        <div class="form-group">
                            <label for="youtubeApiKey">YouTube API klic</label>
                            <input type="password" id="youtubeApiKey" placeholder="AIza..." autocomplete="off">
                            <span class="input-hint">
                                <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener">Ziskat API klic</a>
                                - klic je ulozen pouze lokalne
                            </span>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block" data-mode="api">Pripojit k chatu (API)</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal modal-wide">
            <div class="modal-header">
                <h3>Nastaveni</h3>
                <button class="btn btn-icon modal-close" id="closeSettingsModal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Settings Tabs Navigation -->
                <div class="settings-tabs" id="settingsTabs">
                    <button class="settings-tab active" data-tab="tab-kick">Kick</button>
                    <button class="settings-tab" data-tab="tab-twitch">Twitch</button>
                    <button class="settings-tab" data-tab="tab-obs">OBS / Overlay</button>
                    <button class="settings-tab" data-tab="tab-appearance">Vzhled</button>
                    <button class="settings-tab" data-tab="tab-services">Sluzby</button>
                    <button class="settings-tab" data-tab="tab-data">Data</button>
                </div>

                <!-- TAB: Kick -->
                <div class="settings-tab-panel active" id="tab-kick">
                    <div class="settings-section">
                        <h4>Kick kanaly</h4>
                        <p class="setting-hint">Kanaly pridavejte tlacitkem "Pridat" v hlavnim panelu. Zde vidite stav pripojeni.</p>
                        <div class="cp-channel-list" id="cpKickChannelList">
                            <div class="cp-channel-empty">Zadny Kick kanal neni pripojen</div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>Filtr zprav (Kick)</h4>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="cpKickFilterEnabled">
                                Povolit filtr klicovych slov
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="cpKickFilterKeywords">Klicova slova (oddelena carkou)</label>
                            <textarea id="cpKickFilterKeywords" rows="3" placeholder="slovo1, slovo2, slovo3&#10;Zpravy obsahujici tato slova nebudou zobrazeny"></textarea>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="cpKickSave">Ulozit Kick nastaveni</button>
                </div>

                <!-- TAB: Twitch -->
                <div class="settings-tab-panel" id="tab-twitch">
                    <div class="settings-section">
                        <h4>Twitch kanaly</h4>
                        <p class="setting-hint">Kanaly pridavejte tlacitkem "Pridat" v hlavnim panelu. Zde vidite stav pripojeni.</p>
                        <div class="cp-channel-list" id="cpTwitchChannelList">
                            <div class="cp-channel-empty">Zadny Twitch kanal neni pripojen</div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>Twitch EventSub (volitelne)</h4>
                        <p class="setting-hint">Zakladni alerty (sub, resub, gift, raid) funguji bez prihlaseni. EventSub pridava: follows, cheers, channel points.</p>
                        <div id="eventsubStatus" class="eventsub-status">
                            <span class="eventsub-dot disconnected"></span>
                            <span class="eventsub-label" id="eventsubLabel">Nepripojeno</span>
                        </div>
                        <div class="eventsub-fields" id="eventsubFields">
                            <div class="form-group">
                                <label for="eventsubClientId">Twitch Client ID</label>
                                <input type="text" id="eventsubClientId" placeholder="Vloz Client ID z dev.twitch.tv" autocomplete="off">
                                <span class="input-hint">Vytvor aplikaci na <a href="https://dev.twitch.tv/console/apps" target="_blank" rel="noopener">dev.twitch.tv</a>, Redirect URI: nastav na URL teto stranky + <code>/oauth-callback.html</code></span>
                            </div>
                            <div class="eventsub-actions">
                                <button class="btn btn-sm btn-primary" id="eventsubConnectBtn">Pripojit Twitch</button>
                                <button class="btn btn-sm btn-danger" id="eventsubDisconnectBtn" style="display:none">Odpojit</button>
                            </div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>Filtr zprav (Twitch)</h4>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="cpTwitchFilterEnabled">
                                Povolit filtr klicovych slov
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="cpTwitchFilterKeywords">Klicova slova (oddelena carkou)</label>
                            <textarea id="cpTwitchFilterKeywords" rows="3" placeholder="slovo1, slovo2, slovo3&#10;Zpravy obsahujici tato slova nebudou zobrazeny"></textarea>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="cpTwitchSave">Ulozit Twitch nastaveni</button>
                </div>

                <!-- TAB: OBS / Overlay -->
                <div class="settings-tab-panel" id="tab-obs">
                    <div class="settings-section">
                        <h4>OBS Overlay nastaveni</h4>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="cpObsTransparentBg" checked>
                                Transparentni pozadi
                            </label>
                        </div>
                        <div class="setting-item">
                            <label for="cpObsFontSize">Velikost pisma (px)</label>
                            <input type="number" id="cpObsFontSize" value="14" min="8" max="48" style="width:80px">
                        </div>
                        <div class="setting-item">
                            <label for="cpObsTextColor">Barva textu</label>
                            <input type="color" id="cpObsTextColor" value="#ffffff">
                        </div>
                        <div class="setting-item">
                            <label for="cpObsUsernameColor">Barva uzivatelskeho jmena</label>
                            <input type="color" id="cpObsUsernameColor" value="#00ff7f">
                        </div>
                        <div class="setting-item">
                            <label for="cpObsMaxMessages">Max. pocet zprav</label>
                            <input type="number" id="cpObsMaxMessages" value="50" min="10" max="500" style="width:80px">
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>Bad Word filtr (cenzura)</h4>
                        <p class="setting-hint">Slova budou nahrazena *** ve zobrazeni. Zprava se nepreskoci, pouze se cenzuruje.</p>
                        <div class="form-group">
                            <label for="cpObsBadWords">Zakazana slova (jedno slovo na radek nebo oddelena carkou)</label>
                            <textarea id="cpObsBadWords" rows="4" placeholder="slovo1&#10;slovo2&#10;slovo3"></textarea>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>Chat Style (OBS / Streamlabs)</h4>
                        <div class="style-selector">
                            <label class="style-radio">
                                <input type="radio" name="chatStyle" value="default" checked>
                                <span>Default</span>
                            </label>
                            <label class="style-radio">
                                <input type="radio" name="chatStyle" value="preset">
                                <span>Preset</span>
                            </label>
                            <label class="style-radio">
                                <input type="radio" name="chatStyle" value="custom">
                                <span>Custom CSS</span>
                            </label>
                        </div>
                        <div id="stylePresetPanel" class="style-panel" style="display:none">
                            <select id="stylePresetSelect">
                                <option value="">-- Vyber preset --</option>
                                <option value="clean-dark">Clean Dark</option>
                                <option value="neon-glow">Neon Glow</option>
                                <option value="bubble">Chat Bubbles</option>
                                <option value="minimal">Minimal</option>
                                <option value="twitch-native">Twitch Native</option>
                            </select>
                        </div>
                        <div id="styleCustomPanel" class="style-panel" style="display:none">
                            <div class="code-editor-tabs">
                                <button class="code-tab active" data-codetab="css">CSS</button>
                                <button class="code-tab" data-codetab="html">HTML</button>
                                <button class="code-tab" data-codetab="js">JS</button>
                            </div>
                            <div class="code-tab-panel active" id="codetab-css">
                                <textarea id="customCSSEditor" rows="10" placeholder="/* Streamlabs / vlastni CSS */&#10;/* Tridy: #log, .wrap, .meta, .name, .message, .emote */&#10;/* Promenne: {font_size}, {text_color}, {background_color} */"></textarea>
                            </div>
                            <div class="code-tab-panel" id="codetab-html">
                                <textarea id="customHTMLEditor" rows="10" placeholder="<!-- Vlastni HTML sablona pro zpravy -->&#10;<!-- Pouzij Streamlabs strukturu: -->&#10;<!-- <div id='log'><div class='wrap'>...</div></div> -->"></textarea>
                                <details class="style-html-ref">
                                    <summary>HTML Reference (vychozi struktura)</summary>
                                    <pre><code>&lt;div id="log"&gt;
  &lt;div class="wrap" data-from="user"&gt;
    &lt;div class="meta" style="color:#ff0"&gt;
      &lt;span class="badges"&gt;&lt;img class="badge"&gt;&lt;/span&gt;
      &lt;span class="name"&gt;User&lt;/span&gt;
      &lt;span class="colon"&gt;: &lt;/span&gt;
    &lt;/div&gt;
    &lt;span class="message"&gt;text&lt;/span&gt;
  &lt;/div&gt;
&lt;/div&gt;</code></pre>
                                </details>
                            </div>
                            <div class="code-tab-panel" id="codetab-js">
                                <textarea id="customJSEditor" rows="10" placeholder="// Vlastni JavaScript pro OBS overlay&#10;// Pristup k chatovym zprav pres: document.getElementById('log')&#10;// Priklad animace:&#10;// document.addEventListener('onMessage', function(e) { ... });"></textarea>
                            </div>
                            <div class="code-editor-footer">
                                <p class="code-security-warn">Vlastni HTML/JS kod muze mit bezpecnostni rizika. Pouzivejte pouze duveryhodny kod.</p>
                                <button class="btn btn-sm btn-ghost" id="resetCustomCode">Resetovat kod</button>
                            </div>
                        </div>
                        <div id="styleVarsPanel" class="style-panel" style="display:none">
                            <div class="style-vars-grid">
                                <label><span>{font_size}</span><input type="number" id="varFontSize" value="14" min="10" max="32"></label>
                                <label><span>{text_color}</span><input type="color" id="varTextColor" value="#ffffff"></label>
                                <label><span>{background_color}</span><input type="color" id="varBgColor" value="#000000"></label>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-secondary" id="applyStyleBtn" style="margin-top:6px">Aplikovat styl</button>
                    </div>
                    <div class="settings-section">
                        <h4>OBS Browser Source</h4>
                        <div class="obs-section">
                            <div class="obs-url-container">
                                <input type="text" id="obsUrlInput" readonly placeholder="Klikni na 'Generovat' pro vytvoreni URL">
                                <button class="btn btn-sm btn-secondary" id="obsUrlCopy" title="Kopirovat URL">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="obs-settings-row">
                                <label>
                                    <input type="checkbox" id="obsShowAlerts" checked>
                                    Alerty v OBS
                                </label>
                                <label>
                                    <input type="checkbox" id="obsShowChannelNames" checked>
                                    Nazvy kanalu
                                </label>
                                <label>
                                    Skryt po
                                    <input type="number" id="obsHideAfter" value="0" min="0" max="300" style="width:50px">
                                    s (0 = nikdy)
                                </label>
                            </div>
                            <div class="obs-btn-row">
                                <button class="btn btn-primary btn-sm" id="obsGenerateUrl">Generovat OBS URL</button>
                                <button class="btn btn-secondary btn-sm" id="obsPreviewBtn">Nahled v novem tabu</button>
                            </div>
                            <p class="obs-hint">Doporucena velikost: 400 x 600 px. Vlozte URL do OBS jako Browser Source.</p>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="cpObsSave">Ulozit OBS nastaveni</button>
                </div>

                <!-- TAB: Appearance -->
                <div class="settings-tab-panel" id="tab-appearance">
                    <div class="settings-section">
                        <h4>Zobrazeni</h4>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="showTimestamps" checked>
                                Zobrazit casove znacky
                            </label>
                        </div>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="showPlatformBadges" checked>
                                Zobrazit badge platformy
                            </label>
                        </div>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="showEmotes" checked>
                                Zobrazit emotes
                            </label>
                        </div>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="compactMode">
                                Kompaktni rezim
                            </label>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>Chat</h4>
                        <div class="setting-item">
                            <label for="maxMessages">Max. pocet zprav</label>
                            <input type="number" id="maxMessages" value="500" min="100" max="2000">
                        </div>
                        <div class="setting-item">
                            <label for="fontSize">Velikost pisma</label>
                            <select id="fontSize">
                                <option value="12">Male (12px)</option>
                                <option value="14" selected>Stredni (14px)</option>
                                <option value="16">Velke (16px)</option>
                                <option value="18">Extra velke (18px)</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>Event Alerts</h4>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="showAlerts" checked>
                                Zobrazit event alerty v chatu
                            </label>
                        </div>
                        <div class="alert-type-toggles" id="alertTypeToggles">
                            <div class="setting-item setting-sub-item">
                                <label><input type="checkbox" data-alert-type="subscribe" checked> Subscriptions</label>
                            </div>
                            <div class="setting-item setting-sub-item">
                                <label><input type="checkbox" data-alert-type="follow" checked> Follows</label>
                            </div>
                            <div class="setting-item setting-sub-item">
                                <label><input type="checkbox" data-alert-type="gift_sub" checked> Gift Subs</label>
                            </div>
                            <div class="setting-item setting-sub-item">
                                <label><input type="checkbox" data-alert-type="cheer" checked> Cheers/Bits</label>
                            </div>
                            <div class="setting-item setting-sub-item">
                                <label><input type="checkbox" data-alert-type="raid" checked> Raids</label>
                            </div>
                        </div>
                        <div class="alert-test-section">
                            <p class="setting-hint">Otestovat alerty:</p>
                            <div class="alert-test-buttons">
                                <button class="btn btn-xs btn-test" data-test-alert="subscribe" title="Test Subscribe">
                                    <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                    Sub
                                </button>
                                <button class="btn btn-xs btn-test" data-test-alert="resubscribe" title="Test Resub">
                                    <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                    Resub
                                </button>
                                <button class="btn btn-xs btn-test" data-test-alert="gift_sub" title="Test Gift Sub">
                                    <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2a3 3 0 0 0-3 3c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/></svg>
                                    Gift
                                </button>
                                <button class="btn btn-xs btn-test" data-test-alert="follow" title="Test Follow">
                                    <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                    Follow
                                </button>
                                <button class="btn btn-xs btn-test" data-test-alert="cheer" title="Test Cheer">
                                    <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg>
                                    Bits
                                </button>
                                <button class="btn btn-xs btn-test" data-test-alert="donation" title="Test Donation">
                                    <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                                    Donate
                                </button>
                                <button class="btn btn-xs btn-test" data-test-alert="raid" title="Test Raid">
                                    <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M15 13V5c0-1.66-1.34-3-3-3S9 3.34 9 5v8c-1.21.91-2 2.37-2 4 0 2.76 2.24 5 5 5s5-2.24 5-5c0-1.63-.79-3.09-2-4z"/></svg>
                                    Raid
                                </button>
                                <button class="btn btn-xs btn-test" data-test-alert="channel_points" title="Test Channel Points">
                                    <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                    Points
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: Services -->
                <div class="settings-tab-panel" id="tab-services">
                    <div class="settings-section">
                        <h4>YouTube API</h4>
                        <p class="setting-hint">Pro YouTube API rezim (polling) je potreba API klic. Ostatni YouTube rezimy (iframe, extension) ho nevyzaduji.</p>
                        <div class="form-group">
                            <label for="cpYoutubeApiKey">YouTube Data API v3 Key</label>
                            <input type="password" id="cpYoutubeApiKey" placeholder="AIza..." autocomplete="off">
                            <span class="input-hint"><a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener">Ziskat API klic</a> - klic je ulozen pouze lokalne v prohlizeci</span>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>Donace (volitelne)</h4>
                        <p class="setting-hint">Pripojte Streamlabs nebo StreamElements pro zobrazeni donaci v chatu. Token najdete v nastaveni prislusne sluzby.</p>
                        <div class="donation-service">
                            <div class="donation-service-header">
                                <span class="donation-service-name">Streamlabs</span>
                                <span class="donation-dot disconnected" id="slDot"></span>
                            </div>
                            <div class="form-group">
                                <input type="password" id="streamlabsToken" placeholder="Socket API Token" autocomplete="off">
                                <span class="input-hint">Nastaveni -> API Settings -> Socket API Token na <a href="https://streamlabs.com/dashboard#/settings/api-settings" target="_blank" rel="noopener">streamlabs.com</a></span>
                            </div>
                            <div class="donation-actions">
                                <button class="btn btn-sm btn-primary" id="slConnectBtn">Pripojit</button>
                                <button class="btn btn-sm btn-danger" id="slDisconnectBtn" style="display:none">Odpojit</button>
                            </div>
                        </div>
                        <div class="donation-service">
                            <div class="donation-service-header">
                                <span class="donation-service-name">StreamElements</span>
                                <span class="donation-dot disconnected" id="seDot"></span>
                            </div>
                            <div class="form-group">
                                <input type="password" id="streamelementsToken" placeholder="JWT Token" autocomplete="off">
                                <span class="input-hint">Profil -> Channels -> Show Secrets -> JWT Token na <a href="https://streamelements.com/dashboard/account/channels" target="_blank" rel="noopener">streamelements.com</a></span>
                            </div>
                            <div class="donation-actions">
                                <button class="btn btn-sm btn-primary" id="seConnectBtn">Pripojit</button>
                                <button class="btn btn-sm btn-danger" id="seDisconnectBtn" style="display:none">Odpojit</button>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="cpServicesSave">Ulozit sluzby</button>
                </div>

                <!-- TAB: Data -->
                <div class="settings-tab-panel" id="tab-data">
                    <div class="settings-section">
                        <h4>Data</h4>
                        <button class="btn btn-secondary" id="exportSettings">Exportovat nastaveni</button>
                        <button class="btn btn-secondary" id="importSettings">Importovat nastaveni</button>
                        <button class="btn btn-danger" id="clearAllData">Vymazat vsechna data</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Extension Modal -->
    <div class="modal-overlay" id="extensionModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üß© Chrome Extension</h3>
                <button class="btn btn-icon modal-close" id="closeExtensionModal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="extension-modal-status" id="extensionModalStatus">
                    <div class="extension-status-icon-large" id="extensionModalIcon">?</div>
                    <div class="extension-status-info">
                        <div class="extension-status-title" id="extensionModalTitle">Kontroluji extension...</div>
                        <div class="extension-status-version" id="extensionModalVersion"></div>
                    </div>
                </div>

                <div class="extension-version-details" id="extensionVersionDetails">
                    <div class="version-row">
                        <span class="version-label">Aktivn√≠:</span>
                        <span class="version-value" id="extensionActiveStatus">-</span>
                    </div>
                    <div class="version-row">
                        <span class="version-label">Naƒçten√° verze:</span>
                        <span class="version-value" id="extensionLoadedCommit">-</span>
                    </div>
                    <div class="version-row">
                        <span class="version-label">Dostupn√° verze:</span>
                        <span class="version-value" id="extensionGithubCommit">naƒç√≠t√°m...</span>
                    </div>
                    <div class="version-row update-status" id="extensionUpdateRow" style="display: none;">
                        <span class="version-label"></span>
                        <span class="version-value update-available" id="extensionUpdateStatus">‚¨Ü K dispozici aktualizace</span>
                    </div>
                </div>

                <div class="extension-features">
                    <h4>Funkce roz≈°√≠≈ôen√≠</h4>
                    <div class="extension-feature">
                        <span class="feature-icon youtube">‚ñ∂</span>
                        <div class="feature-info">
                            <strong>YouTube Chat Reader</strong>
                            <p>ƒåte zpr√°vy z YouTube live chatu a zobrazuje je spoleƒçnƒõ s Twitch/Kick</p>
                        </div>
                    </div>
                    <div class="extension-feature">
                        <span class="feature-icon twitch">‚öî</span>
                        <div class="feature-info">
                            <strong>Twitch Moderator</strong>
                            <p>Odes√≠l√° moderaƒçn√≠ p≈ô√≠kazy (/ban, /timeout, /delete) p≈ôes popup okna</p>
                        </div>
                    </div>
                </div>

                <div class="extension-note">
                    <strong>Bez p≈ôihla≈°ov√°n√≠!</strong> Roz≈°√≠≈ôen√≠ vyu≈æ√≠v√° va≈°i existuj√≠c√≠ session na YouTube a Twitch.
                </div>

                <div class="extension-actions">
                    <button class="btn btn-primary btn-block" id="extensionModalDownloadBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        <span id="extensionModalDownloadText">St√°hnout roz≈°√≠≈ôen√≠</span>
                    </button>
                    <a href="moderator.html" class="btn btn-secondary btn-block" target="_blank">
                        V√≠ce informac√≠
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Streaming Overlay + Settings Tabs CSS -->
    <style>
        /* Settings Tabs */
        .settings-tabs {
            display: flex;
            gap: 2px;
            border-bottom: 2px solid var(--bg-tertiary, #1f1f23);
            margin-bottom: 16px;
            overflow-x: auto;
            flex-wrap: nowrap;
        }
        .settings-tab {
            padding: 8px 14px;
            background: none;
            border: none;
            color: var(--text-secondary, #adadb8);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            white-space: nowrap;
            transition: color 0.2s, border-color 0.2s;
        }
        .settings-tab:hover {
            color: var(--text-primary, #efeff1);
        }
        .settings-tab.active {
            color: var(--accent-primary, #9147ff);
            border-bottom-color: var(--accent-primary, #9147ff);
        }
        .settings-tab-panel {
            display: none;
        }
        .settings-tab-panel.active {
            display: block;
        }
        .modal-wide .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Connection status dot for settings tabs */
        .cp-status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
            margin-left: 8px;
            vertical-align: middle;
        }
        .cp-status-dot.connected { background: #53fc18; }
        .cp-status-dot.error { background: #ff4444; }
        .cp-status-dot.connecting { background: #ffaa00; animation: pulse-dot 1s infinite; }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Channel list in settings tabs */
        .cp-channel-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 8px;
        }
        .cp-channel-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            font-size: 13px;
        }
        .cp-channel-item .cp-status-dot {
            margin-left: 0;
            flex-shrink: 0;
        }
        .cp-channel-item .cp-channel-name {
            flex: 1;
            color: #e0e0e0;
        }
        .cp-channel-item .cp-channel-state {
            font-size: 11px;
            color: #888;
            text-transform: capitalize;
        }
        .cp-channel-empty {
            color: #666;
            font-size: 13px;
            font-style: italic;
            padding: 8px 0;
        }

        /* Code editor tabs (HTML/CSS/JS) */
        .code-editor-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border-color, #333);
            margin-bottom: 0;
        }
        .code-tab {
            padding: 6px 16px;
            background: transparent;
            border: none;
            color: var(--text-muted, #888);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }
        .code-tab:hover { color: var(--text-primary, #e0e0e0); }
        .code-tab.active {
            color: var(--accent-primary, #53fc18);
            border-bottom-color: var(--accent-primary, #53fc18);
        }
        .code-tab-panel {
            display: none;
        }
        .code-tab-panel.active {
            display: block;
        }
        .code-tab-panel textarea {
            width: 100%;
            padding: 10px;
            background: var(--bg-primary, #0a0a0a);
            border: 1px solid var(--border-color, #333);
            border-top: none;
            border-radius: 0 0 var(--border-radius-sm, 4px) var(--border-radius-sm, 4px);
            color: var(--text-primary, #e0e0e0);
            font-family: 'Consolas', 'Monaco', 'Fira Code', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
            min-height: 120px;
            tab-size: 2;
        }
        .code-editor-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 6px;
            gap: 8px;
        }
        .code-security-warn {
            font-size: 11px;
            color: #ff9800;
            margin: 0;
            flex: 1;
        }
        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border-color, #333);
            color: var(--text-muted, #888);
            font-size: 11px;
            padding: 3px 10px;
            border-radius: var(--border-radius-sm, 4px);
            cursor: pointer;
        }
        .btn-ghost:hover {
            color: var(--text-primary, #e0e0e0);
            border-color: var(--text-muted, #888);
        }

        /* Input with button inline */
        .input-with-btn {
            display: flex;
            gap: 8px;
        }
        .input-with-btn input { flex: 1; }

        /* OBS button row */
        .obs-btn-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        /* OBS Overlay Mode */
        body.obs-mode {
            background: transparent !important;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body.obs-mode .app-header,
        body.obs-mode .sidebar,
        body.obs-mode .modal-overlay,
        body.obs-mode .toast-container,
        body.obs-mode .chat-welcome {
            display: none !important;
        }
        body.obs-mode .app-container {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }
        body.obs-mode .main-content {
            padding: 0 !important;
        }
        body.obs-mode .chat-area {
            border: none !important;
            box-shadow: none !important;
            background: transparent !important;
        }
        body.obs-mode .chat-container {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            height: 100vh;
            max-height: 100vh;
        }
        body.obs-mode .chat-messages {
            background: transparent !important;
        }
        body.obs-mode .chat-message {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }
        /* OBS: streamer label hidden by default, shown via dynamic CSS when showChannelNames=true */
        body.obs-mode .message-streamer-label {
            display: none;
        }
        body.obs-mode .alert-streamer-label {
            display: none;
        }
        /* OBS: when channel names enabled, show streamer labels */
        body.obs-mode.obs-show-channels .message-streamer-label {
            display: flex !important;
            min-width: 90px;
            max-width: 120px;
        }
        body.obs-mode.obs-show-channels .alert-streamer-label {
            display: flex !important;
        }
        body.obs-mode.obs-show-channels .message-streamer-label .streamer-name {
            color: rgba(255, 255, 255, 0.6);
        }
        /* OBS: style alerts to look good on transparent background */
        body.obs-mode .chat-alert {
            background: rgba(0, 0, 0, 0.5) !important;
            border-radius: 6px;
            margin: 4px 0;
            padding: 4px 0;
        }
        body.obs-mode .chat-alert .alert-content {
            color: #ffffff;
        }
        body.obs-mode .chat-alert .alert-detail {
            color: rgba(255, 255, 255, 0.75);
        }
        /* OBS: alert type accent colors on border */
        body.obs-mode .chat-alert.alert-subscribe,
        body.obs-mode .chat-alert.alert-resubscribe {
            border-left-color: #b366ff;
        }
        body.obs-mode .chat-alert.alert-gift_sub,
        body.obs-mode .chat-alert.alert-gift_sub_received {
            border-left-color: #ff69b4;
        }
        body.obs-mode .chat-alert.alert-follow {
            border-left-color: #ff4444;
        }
        body.obs-mode .chat-alert.alert-cheer,
        body.obs-mode .chat-alert.alert-donation {
            border-left-color: #ffd700;
        }
        body.obs-mode .chat-alert.alert-raid {
            border-left-color: #00bfff;
        }
        body.obs-mode .chat-alert.alert-channel_points {
            border-left-color: #00ff7f;
        }
        /* OBS: keep border-left visible on messages for platform color */
        body.obs-mode .chat-message.platform-twitch {
            border-left: 3px solid var(--twitch-color, #9146ff) !important;
        }
        body.obs-mode .chat-message.platform-kick {
            border-left: 3px solid var(--kick-color, #53fc18) !important;
        }
        body.obs-mode .chat-message.platform-youtube {
            border-left: 3px solid var(--youtube-color, #ff0000) !important;
        }
        /* OBS: ensure chat input is hidden */
        body.obs-mode .chat-input-area,
        body.obs-mode .chat-input-container {
            display: none !important;
        }
        /* OBS: mod trigger hidden */
        body.obs-mode .message-mod-trigger {
            display: none !important;
        }
    </style>

    <!-- Scripts -->
    <script src="adapters/base-adapter.js"></script>
    <script src="adapters/twitch-adapter.js"></script>
    <script src="adapters/kick-adapter.js"></script>
    <script src="adapters/youtube-adapter.js"></script>
    <script src="adapters/youtube-iframe-adapter.js"></script>
    <script src="adapters/youtube-extension-adapter.js"></script>
    <script src="adapters/twitch-eventsub-adapter.js"></script>
    <script src="adapters/donation-adapter.js"></script>
    <script src="jszip.min.js"></script>
    <script src="script.js"></script>

    <!-- Streaming Overlay Tool: Settings tabs, keyword filter, bad word censor, OBS mode -->
    <script>
    (function() {
        'use strict';

        // =====================================================================
        // CHATPANEL_SETTINGS localStorage schema (Phase 1)
        // =====================================================================

        const CP_STORAGE_KEY = 'chatpanel_settings';

        const CP_DEFAULTS = {
            kick: {
                filter: { enabled: false, keywords: [] }
            },
            twitch: {
                clientId: '',
                filter: { enabled: false, keywords: [] }
            },
            services: {
                youtubeApiKey: '',
                streamlabsToken: '',
                streamelementsToken: ''
            },
            obs: {
                transparentBg: true,
                fontSize: 14,
                textColor: '#ffffff',
                usernameColor: '#00ff7f',
                maxMessages: 50,
                badWordList: []
            },
            ui: {
                theme: 'dark',
                showBadges: true,
                showTimestamps: true
            }
        };

        function loadCPSettings() {
            try {
                const raw = localStorage.getItem(CP_STORAGE_KEY);
                if (raw) {
                    const parsed = JSON.parse(raw);
                    return deepMerge(JSON.parse(JSON.stringify(CP_DEFAULTS)), parsed);
                }
            } catch (e) {
                console.warn('[CP] Failed to load chatpanel_settings:', e);
            }
            return JSON.parse(JSON.stringify(CP_DEFAULTS));
        }

        function saveCPSettings(settings) {
            try {
                // Normalize keywords: trim, lowercase, filter empty
                if (settings.kick && settings.kick.filter && settings.kick.filter.keywords) {
                    settings.kick.filter.keywords = normalizeKeywords(settings.kick.filter.keywords);
                }
                if (settings.twitch && settings.twitch.filter && settings.twitch.filter.keywords) {
                    settings.twitch.filter.keywords = normalizeKeywords(settings.twitch.filter.keywords);
                }
                if (settings.obs && settings.obs.badWordList) {
                    settings.obs.badWordList = normalizeKeywords(settings.obs.badWordList);
                }
                localStorage.setItem(CP_STORAGE_KEY, JSON.stringify(settings));
            } catch (e) {
                console.error('[CP] Failed to save chatpanel_settings:', e);
            }
        }

        function normalizeKeywords(arr) {
            if (!Array.isArray(arr)) return [];
            return arr.map(s => String(s).trim().toLowerCase()).filter(Boolean);
        }

        function deepMerge(target, source) {
            if (!source || typeof source !== 'object') return target;
            for (const key of Object.keys(source)) {
                if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                    if (!target[key] || typeof target[key] !== 'object') target[key] = {};
                    deepMerge(target[key], source[key]);
                } else {
                    target[key] = source[key];
                }
            }
            return target;
        }

        // Current in-memory state
        let cpSettings = loadCPSettings();

        // =====================================================================
        // POPULATE UI FROM SETTINGS (Phase 1.4)
        // =====================================================================

        function populateSettingsUI() {
            const s = cpSettings;
            // Kick tab - filter settings only, channels shown dynamically
            const kickFilterEnabled = document.getElementById('cpKickFilterEnabled');
            const kickFilterKeywords = document.getElementById('cpKickFilterKeywords');
            if (kickFilterEnabled) kickFilterEnabled.checked = s.kick.filter.enabled;
            if (kickFilterKeywords) kickFilterKeywords.value = (s.kick.filter.keywords || []).join(', ');

            // Twitch tab - filter settings only, channels shown dynamically
            const twitchFilterEnabled = document.getElementById('cpTwitchFilterEnabled');
            const twitchFilterKeywords = document.getElementById('cpTwitchFilterKeywords');
            if (twitchFilterEnabled) twitchFilterEnabled.checked = s.twitch.filter.enabled;
            if (twitchFilterKeywords) twitchFilterKeywords.value = (s.twitch.filter.keywords || []).join(', ');

            // Twitch Client ID
            const eventsubClientId = document.getElementById('eventsubClientId');
            if (eventsubClientId && s.twitch.clientId && !eventsubClientId.value) {
                eventsubClientId.value = s.twitch.clientId;
            }

            // Services tab
            const ytApiKey = document.getElementById('cpYoutubeApiKey');
            const slToken = document.getElementById('streamlabsToken');
            const seToken = document.getElementById('streamelementsToken');
            if (ytApiKey && s.services.youtubeApiKey) ytApiKey.value = s.services.youtubeApiKey;
            if (slToken && s.services.streamlabsToken && !slToken.value) slToken.value = s.services.streamlabsToken;
            if (seToken && s.services.streamelementsToken && !seToken.value) seToken.value = s.services.streamelementsToken;

            // Sync YouTube API key to AppState
            if (typeof AppState !== 'undefined' && s.services.youtubeApiKey) {
                AppState.youtubeApiKey = s.services.youtubeApiKey;
            }
            // Also populate the YouTube API key input in the Add Channel modal
            const ytApiKeyModal = document.getElementById('youtubeApiKey');
            if (ytApiKeyModal && s.services.youtubeApiKey && !ytApiKeyModal.value) {
                ytApiKeyModal.value = s.services.youtubeApiKey;
            }

            // OBS tab
            const obsTransparent = document.getElementById('cpObsTransparentBg');
            const obsFontSize = document.getElementById('cpObsFontSize');
            const obsTextColor = document.getElementById('cpObsTextColor');
            const obsUsernameColor = document.getElementById('cpObsUsernameColor');
            const obsMaxMsg = document.getElementById('cpObsMaxMessages');
            const obsBadWords = document.getElementById('cpObsBadWords');
            if (obsTransparent) obsTransparent.checked = s.obs.transparentBg;
            if (obsFontSize) obsFontSize.value = s.obs.fontSize;
            if (obsTextColor) obsTextColor.value = s.obs.textColor;
            if (obsUsernameColor) obsUsernameColor.value = s.obs.usernameColor;
            if (obsMaxMsg) obsMaxMsg.value = s.obs.maxMessages;
            if (obsBadWords) obsBadWords.value = (s.obs.badWordList || []).join('\n');
        }

        // =====================================================================
        // SETTINGS TABS (Phase 1.1)
        // =====================================================================

        function initSettingsTabs() {
            const tabContainer = document.getElementById('settingsTabs');
            if (!tabContainer) return;

            tabContainer.addEventListener('click', function(e) {
                const tab = e.target.closest('.settings-tab');
                if (!tab) return;
                const targetId = tab.dataset.tab;
                if (!targetId) return;

                // Deactivate all tabs and panels
                tabContainer.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.settings-tab-panel').forEach(p => p.classList.remove('active'));

                // Activate clicked tab and panel
                tab.classList.add('active');
                const panel = document.getElementById(targetId);
                if (panel) panel.classList.add('active');
            });
        }

        // =====================================================================
        // SAVE BUTTONS (Phase 1.5)
        // =====================================================================

        function initSaveButtons() {
            // Kick Save (filter settings only)
            const kickSave = document.getElementById('cpKickSave');
            if (kickSave) {
                kickSave.addEventListener('click', function() {
                    cpSettings.kick.filter.enabled = document.getElementById('cpKickFilterEnabled')?.checked || false;
                    cpSettings.kick.filter.keywords = parseKeywordInput(document.getElementById('cpKickFilterKeywords')?.value || '');
                    saveCPSettings(cpSettings);
                    if (typeof showToast === 'function') showToast('Kick filtr ulozen', 'success');
                });
            }

            // Twitch Save (filter settings + EventSub client ID)
            const twitchSave = document.getElementById('cpTwitchSave');
            if (twitchSave) {
                twitchSave.addEventListener('click', function() {
                    cpSettings.twitch.clientId = (document.getElementById('eventsubClientId')?.value || '').trim();
                    cpSettings.twitch.filter.enabled = document.getElementById('cpTwitchFilterEnabled')?.checked || false;
                    cpSettings.twitch.filter.keywords = parseKeywordInput(document.getElementById('cpTwitchFilterKeywords')?.value || '');
                    saveCPSettings(cpSettings);
                    if (typeof showToast === 'function') showToast('Twitch nastaveni ulozeno', 'success');
                });
            }

            // Services Save
            const servicesSave = document.getElementById('cpServicesSave');
            if (servicesSave) {
                servicesSave.addEventListener('click', function() {
                    cpSettings.services.youtubeApiKey = (document.getElementById('cpYoutubeApiKey')?.value || '').trim();
                    cpSettings.services.streamlabsToken = (document.getElementById('streamlabsToken')?.value || '').trim();
                    cpSettings.services.streamelementsToken = (document.getElementById('streamelementsToken')?.value || '').trim();
                    saveCPSettings(cpSettings);
                    // Sync YouTube API key to AppState so it's available when adding channels
                    if (typeof AppState !== 'undefined') {
                        AppState.youtubeApiKey = cpSettings.services.youtubeApiKey;
                    }
                    if (typeof showToast === 'function') showToast('Sluzby ulozeny', 'success');
                });
            }

            // OBS Save
            const obsSave = document.getElementById('cpObsSave');
            if (obsSave) {
                obsSave.addEventListener('click', function() {
                    cpSettings.obs.transparentBg = document.getElementById('cpObsTransparentBg')?.checked || false;
                    cpSettings.obs.fontSize = parseInt(document.getElementById('cpObsFontSize')?.value) || 14;
                    cpSettings.obs.textColor = document.getElementById('cpObsTextColor')?.value || '#ffffff';
                    cpSettings.obs.usernameColor = document.getElementById('cpObsUsernameColor')?.value || '#00ff7f';
                    cpSettings.obs.maxMessages = parseInt(document.getElementById('cpObsMaxMessages')?.value) || 50;
                    cpSettings.obs.badWordList = parseKeywordInput(document.getElementById('cpObsBadWords')?.value || '', true);
                    saveCPSettings(cpSettings);
                    if (typeof showToast === 'function') showToast('OBS nastaveni ulozeno', 'success');
                });
            }
        }

        function parseKeywordInput(text, allowNewlines) {
            if (!text) return [];
            // Split by comma or newline
            const parts = text.split(/[,\n]+/);
            return parts.map(s => s.trim().toLowerCase()).filter(Boolean);
        }

        // =====================================================================
        // KEYWORD FILTER - Monkey-patch handleMessage (Phase 2.4 / 3.5)
        // =====================================================================

        function shouldFilterMessage(message) {
            if (!message || !message.content) return false;
            const platform = (message.platform || '').split('-')[0].toLowerCase();
            const text = message.content.toLowerCase();

            let filterConfig = null;
            if (platform === 'kick') {
                filterConfig = cpSettings.kick.filter;
            } else if (platform === 'twitch') {
                filterConfig = cpSettings.twitch.filter;
            }

            if (!filterConfig || !filterConfig.enabled || !filterConfig.keywords || filterConfig.keywords.length === 0) {
                return false;
            }

            // Whole-word match, case-insensitive
            for (const keyword of filterConfig.keywords) {
                if (!keyword) continue;
                try {
                    const re = new RegExp('\\b' + escapeRegex(keyword) + '\\b', 'i');
                    if (re.test(text)) return true;
                } catch (e) {
                    // Fallback: simple includes
                    if (text.includes(keyword)) return true;
                }
            }
            return false;
        }

        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // =====================================================================
        // BAD WORD CENSOR (Phase 4.4)
        // =====================================================================

        function censorBadWords(text) {
            const badWords = cpSettings.obs.badWordList;
            if (!badWords || badWords.length === 0) return text;

            let result = text;
            for (const word of badWords) {
                if (!word) continue;
                try {
                    const re = new RegExp('\\b' + escapeRegex(word) + '\\b', 'gi');
                    result = result.replace(re, '***');
                } catch (e) {
                    // Fallback: simple replace
                    result = result.split(new RegExp(escapeRegex(word), 'gi')).join('***');
                }
            }
            return result;
        }

        // Monkey-patch renderMessage to add keyword filter and bad word censor.
        // We patch renderMessage (not handleMessage) because adapters bind handleMessage
        // by reference at connect time, but handleMessage calls renderMessage by NAME,
        // so global name resolution picks up our patched version at call time.
        if (typeof renderMessage === 'function') {
            const _originalRenderMessage = renderMessage;
            window.renderMessage = function(message) {
                // Phase 2.4 / 3.5: Skip filtered messages
                if (shouldFilterMessage(message)) {
                    return; // Do not render
                }
                // Phase 4.4: Censor bad words in content before rendering
                if (message && message.content) {
                    message.content = censorBadWords(message.content);
                }
                return _originalRenderMessage(message);
            };
        }

        // =====================================================================
        // CONNECTION STATUS DOTS (Phase 2.1 / 3.3 status indicators)
        // =====================================================================

        function updateCPStatusDots() {
            if (typeof AppState === 'undefined') return;

            const kickChannels = [];
            const twitchChannels = [];

            for (const [id, data] of AppState.channels) {
                const platform = (data.platform || '').split('-')[0];
                const name = data.name || id.replace(/^(kick|twitch)-/, '');
                const state = data.state || 'disconnected';
                if (platform === 'kick') kickChannels.push({ name: name, state: state });
                if (platform === 'twitch') twitchChannels.push({ name: name, state: state });
            }

            renderChannelList('cpKickChannelList', kickChannels, 'Kick');
            renderChannelList('cpTwitchChannelList', twitchChannels, 'Twitch');
        }

        function renderChannelList(containerId, channels, platformLabel) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (channels.length === 0) {
                container.innerHTML = '<div class="cp-channel-empty">Zadny ' + platformLabel + ' kanal neni pripojen</div>';
                return;
            }

            const stateLabels = { connected: 'Pripojeno', connecting: 'Pripojovani...', disconnected: 'Odpojeno', error: 'Chyba' };
            let html = '';
            for (var i = 0; i < channels.length; i++) {
                var ch = channels[i];
                var dotClass = 'cp-status-dot';
                if (ch.state === 'connected') dotClass += ' connected';
                else if (ch.state === 'connecting') dotClass += ' connecting';
                else if (ch.state === 'error') dotClass += ' error';
                html += '<div class="cp-channel-item">' +
                    '<span class="' + dotClass + '"></span>' +
                    '<span class="cp-channel-name">' + ch.name + '</span>' +
                    '<span class="cp-channel-state">' + (stateLabels[ch.state] || ch.state) + '</span>' +
                    '</div>';
            }
            container.innerHTML = html;
        }

        // Poll status dots every 3 seconds
        setInterval(updateCPStatusDots, 3000);

        // =====================================================================
        // OBS OVERLAY MODE (Phase 5)
        // =====================================================================

        function checkOBSMode() {
            const params = new URLSearchParams(window.location.search);
            const isOBS = params.get('obs') === '1' || params.get('obs') === 'true';
            if (!isOBS) return false;

            document.body.classList.add('obs-mode');

            // Channel names visibility (early, before reading other params)
            var showChannelNamesEarly = true;
            if (params.has('showChannelNames')) {
                showChannelNamesEarly = params.get('showChannelNames') !== 'false';
            }
            if (showChannelNamesEarly) {
                document.body.classList.add('obs-show-channels');
            }

            // Read settings from URL params (fallback to localStorage)
            const fontSize = params.get('fontsize') || params.get('fontSize') || cpSettings.obs.fontSize;
            const textColor = params.get('textcolor') || params.get('textColor') || cpSettings.obs.textColor;
            const usernameColor = params.get('usernamecolor') || params.get('usernameColor') || cpSettings.obs.usernameColor;
            const maxMsg = parseInt(params.get('maxmsg') || params.get('maxMessages')) || cpSettings.obs.maxMessages;
            const showBadges = params.has('showbadges') ? params.get('showbadges') !== '0' : cpSettings.ui.showBadges;
            const showTimestamps = params.has('showtimestamps') ? params.get('showtimestamps') !== '0' : cpSettings.ui.showTimestamps;
            const showAlerts = params.has('showAlerts') ? params.get('showAlerts') !== 'false' : true;
            const showChannelNames = params.has('showChannelNames') ? params.get('showChannelNames') !== 'false' : true;
            const theme = params.get('theme') || cpSettings.ui.theme;

            // Bad words from URL param (comma-separated)
            if (params.has('badwords')) {
                const bw = decodeURIComponent(params.get('badwords')).split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
                cpSettings.obs.badWordList = bw;
            }

            // Apply OBS styles
            document.documentElement.style.setProperty('--font-size-base', fontSize + 'px');
            document.documentElement.style.setProperty('--obs-text-color', textColor);
            document.documentElement.style.setProperty('--obs-username-color', usernameColor);

            // Inject dynamic OBS CSS
            const obsStyle = document.createElement('style');
            obsStyle.textContent = `
                body.obs-mode .chat-message .message-text { color: ${textColor}; }
                body.obs-mode .chat-message .message-author { color: ${usernameColor}; }
                body.obs-mode .chat-message .message-timestamp { color: ${textColor}; opacity: 0.6; }
                body.obs-mode .message-timestamp { display: ${showTimestamps ? 'inline' : 'none'}; }
                body.obs-mode .user-badges { display: ${showBadges ? 'inline-flex' : 'none'}; }
                body.obs-mode .chat-alert { display: ${showAlerts ? 'flex' : 'none'} !important; }
            `;
            document.head.appendChild(obsStyle);

            // Apply custom code (CSS, HTML, JS) from URL params or localStorage
            var obsConf = {};
            try { obsConf = JSON.parse(localStorage.getItem('adhub_obs_config') || '{}'); } catch (e) {}

            // Custom CSS
            var customCSSText = '';
            if (params.has('customCSS')) {
                try { customCSSText = atob(params.get('customCSS')); } catch (e) {}
            } else if (obsConf.customCSS) {
                customCSSText = obsConf.customCSS;
            }
            if (customCSSText) {
                var customStyleEl = document.createElement('style');
                customStyleEl.id = 'custom-styles';
                customStyleEl.textContent = customCSSText;
                document.head.appendChild(customStyleEl);
            }

            // Custom HTML
            var customHTMLText = '';
            if (params.has('customHTML')) {
                try { customHTMLText = atob(params.get('customHTML')); } catch (e) {}
            } else if (obsConf.customHTML) {
                customHTMLText = obsConf.customHTML;
            }
            if (customHTMLText) {
                var customHTMLEl = document.createElement('div');
                customHTMLEl.id = 'custom-html';
                customHTMLEl.innerHTML = customHTMLText;
                document.body.appendChild(customHTMLEl);
            }

            // Custom JS
            var customJSText = '';
            if (params.has('customJS')) {
                try { customJSText = atob(params.get('customJS')); } catch (e) {}
            } else if (obsConf.customJS) {
                customJSText = obsConf.customJS;
            }
            if (customJSText) {
                var customScriptEl = document.createElement('script');
                customScriptEl.textContent = customJSText;
                document.body.appendChild(customScriptEl);
            }

            // Override AppState settings for OBS
            if (typeof AppState !== 'undefined') {
                AppState.settings.maxMessages = maxMsg;
                AppState.settings.fontSize = parseInt(fontSize);
                AppState.settings.showTimestamps = showTimestamps;
                AppState.settings.showPlatformBadges = showBadges;
            }

            // Set theme
            document.documentElement.dataset.theme = theme;

            // Auto-connect from URL params
            const platform = params.get('platform') || 'both';
            const channelKick = params.get('channel_kick') || '';
            const channelTwitch = params.get('channel_twitch') || '';

            // Wait for adapters to load then connect
            setTimeout(function() {
                if (typeof addChannel !== 'function') return;

                if ((platform === 'kick' || platform === 'both') && channelKick) {
                    addChannel('kick', channelKick);
                }
                if ((platform === 'twitch' || platform === 'both') && channelTwitch) {
                    addChannel('twitch', channelTwitch);
                }

                // Also try channels param (existing obs/ format)
                if (params.has('channels')) {
                    const channels = params.get('channels').split(',');
                    for (const ch of channels) {
                        const parts = ch.split(':');
                        if (parts.length >= 2) {
                            const plat = parts[0];
                            const name = parts.slice(1).join(':');
                            const cid = plat + '-' + name.split(':')[0].toLowerCase();
                            if (!AppState.channels.has(cid)) {
                                addChannel(plat, name);
                            }
                        }
                    }
                }
            }, 500);

            return true;
        }

        // =====================================================================
        // GENERATE OBS URL (Phase 5.3) - Enhanced version
        // =====================================================================

        function generateEnhancedOBSUrl() {
            const params = new URLSearchParams();
            params.set('obs', '1');

            // Channels from current connections
            if (typeof AppState !== 'undefined') {
                for (const [id, data] of AppState.channels) {
                    const platform = data.platform.split('-')[0];
                    if (platform === 'kick') {
                        params.set('channel_kick', data.channel + (data.adapter?.chatroomId ? ':' + data.adapter.chatroomId : ''));
                    } else if (platform === 'twitch') {
                        params.set('channel_twitch', data.channel);
                    }
                }
            }

            // Determine platform
            const hasKick = params.has('channel_kick');
            const hasTwitch = params.has('channel_twitch');
            if (hasKick && hasTwitch) params.set('platform', 'both');
            else if (hasKick) params.set('platform', 'kick');
            else if (hasTwitch) params.set('platform', 'twitch');

            // OBS settings - URLSearchParams.set() handles encoding automatically
            params.set('fontsize', String(cpSettings.obs.fontSize));
            params.set('textcolor', cpSettings.obs.textColor);
            params.set('usernamecolor', cpSettings.obs.usernameColor);
            params.set('maxmsg', String(cpSettings.obs.maxMessages));
            params.set('showbadges', cpSettings.ui.showBadges ? '1' : '0');
            params.set('showtimestamps', cpSettings.ui.showTimestamps ? '1' : '0');
            params.set('theme', cpSettings.ui.theme || 'dark');

            // Bad words - URLSearchParams handles encoding
            if (cpSettings.obs.badWordList && cpSettings.obs.badWordList.length > 0) {
                params.set('badwords', cpSettings.obs.badWordList.join(','));
            }

            // OBS-specific settings from existing UI
            const obsShowAlerts = document.getElementById('obsShowAlerts');
            if (obsShowAlerts) params.set('showAlerts', String(obsShowAlerts.checked));
            const obsShowChannelNames = document.getElementById('obsShowChannelNames');
            if (obsShowChannelNames) params.set('showChannelNames', String(obsShowChannelNames.checked));
            const obsHideAfter = document.getElementById('obsHideAfter');
            if (obsHideAfter && parseInt(obsHideAfter.value) > 0) {
                params.set('hideAfter', obsHideAfter.value);
            }

            // Custom code from style manager (adhub_obs_config)
            try {
                var obsConf = JSON.parse(localStorage.getItem('adhub_obs_config') || '{}');
                if (obsConf.customCSS) {
                    params.set('customCSS', btoa(obsConf.customCSS));
                }
                if (obsConf.customHTML) {
                    params.set('customHTML', btoa(obsConf.customHTML));
                }
                if (obsConf.customJS) {
                    params.set('customJS', btoa(obsConf.customJS));
                }
            } catch (e) {}

            const baseUrl = window.location.origin + window.location.pathname;
            return baseUrl + '?' + params.toString();
        }

        // =====================================================================
        // CODE EDITOR TABS (HTML/CSS/JS)
        // =====================================================================

        function initCodeEditorTabs() {
            // Tab switching for code editor
            var tabContainer = document.querySelector('.code-editor-tabs');
            if (tabContainer) {
                tabContainer.addEventListener('click', function(e) {
                    var tab = e.target.closest('.code-tab');
                    if (!tab) return;
                    var targetId = tab.dataset.codetab;
                    if (!targetId) return;

                    // Deactivate all
                    tabContainer.querySelectorAll('.code-tab').forEach(function(t) { t.classList.remove('active'); });
                    document.querySelectorAll('.code-tab-panel').forEach(function(p) { p.classList.remove('active'); });

                    // Activate clicked
                    tab.classList.add('active');
                    var panel = document.getElementById('codetab-' + targetId);
                    if (panel) panel.classList.add('active');
                });
            }

            // Reset button
            var resetBtn = document.getElementById('resetCustomCode');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    var cssEditor = document.getElementById('customCSSEditor');
                    var htmlEditor = document.getElementById('customHTMLEditor');
                    var jsEditor = document.getElementById('customJSEditor');
                    if (cssEditor) cssEditor.value = '';
                    if (htmlEditor) htmlEditor.value = '';
                    if (jsEditor) jsEditor.value = '';
                    if (typeof showToast === 'function') showToast('Vlastni kod resetovan', 'info');
                });
            }

            // Intercept Apply Style button to also save HTML and JS
            var applyBtn = document.getElementById('applyStyleBtn');
            if (applyBtn) {
                applyBtn.addEventListener('click', function() {
                    var htmlCode = (document.getElementById('customHTMLEditor')?.value || '').trim();
                    var jsCode = (document.getElementById('customJSEditor')?.value || '').trim();
                    if (typeof saveOBSConfig === 'function') {
                        saveOBSConfig({ customHTML: htmlCode, customJS: jsCode });
                    }
                });
            }

            // Load saved custom HTML and JS into editors
            try {
                var saved = JSON.parse(localStorage.getItem('adhub_obs_config') || '{}');
                if (saved.customHTML) {
                    var htmlEditor = document.getElementById('customHTMLEditor');
                    if (htmlEditor) htmlEditor.value = saved.customHTML;
                }
                if (saved.customJS) {
                    var jsEditor = document.getElementById('customJSEditor');
                    if (jsEditor) jsEditor.value = saved.customJS;
                }
            } catch (e) {}
        }

        // Override the existing OBS URL generation
        function initEnhancedOBSUrl() {
            const genBtn = document.getElementById('obsGenerateUrl');
            const urlInput = document.getElementById('obsUrlInput');

            if (genBtn) {
                // Remove old listeners by cloning
                const newBtn = genBtn.cloneNode(true);
                genBtn.parentNode.replaceChild(newBtn, genBtn);

                newBtn.addEventListener('click', function() {
                    // Also try existing generateOBSUrl for the obs/ page URL
                    const enhancedUrl = generateEnhancedOBSUrl();
                    if (urlInput) urlInput.value = enhancedUrl;

                    // Copy to clipboard
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(enhancedUrl).then(function() {
                            if (typeof showToast === 'function') showToast('OBS URL zkopirovan do schranky!', 'success');
                        }).catch(function() {
                            if (typeof showToast === 'function') showToast('OBS URL vygenerovan', 'info');
                        });
                    } else {
                        if (typeof showToast === 'function') showToast('OBS URL vygenerovan', 'info');
                    }
                });
            }

            // Copy button
            const copyBtn = document.getElementById('obsUrlCopy');
            if (copyBtn) {
                const newCopy = copyBtn.cloneNode(true);
                copyBtn.parentNode.replaceChild(newCopy, copyBtn);
                newCopy.addEventListener('click', function() {
                    if (!urlInput || !urlInput.value) {
                        if (typeof showToast === 'function') showToast('Nejprve vygenerujte URL', 'warning');
                        return;
                    }
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(urlInput.value).then(function() {
                            if (typeof showToast === 'function') showToast('OBS URL zkopirovan!', 'success');
                        }).catch(function() {
                            urlInput.select();
                            document.execCommand('copy');
                            if (typeof showToast === 'function') showToast('OBS URL zkopirovan!', 'success');
                        });
                    }
                });
            }

            // Preview button (Phase 5.4)
            const previewBtn = document.getElementById('obsPreviewBtn');
            if (previewBtn) {
                previewBtn.addEventListener('click', function() {
                    const url = urlInput?.value || generateEnhancedOBSUrl();
                    if (url) {
                        window.open(url, '_blank');
                    } else {
                        if (typeof showToast === 'function') showToast('Nejprve vygenerujte URL', 'warning');
                    }
                });
            }
        }

        // =====================================================================
        // AUTO-SCROLL WITH PAUSE ON MANUAL SCROLL (Phase 4.2)
        // =====================================================================

        let autoScrollEnabled = true;

        function initAutoScrollPause() {
            const container = document.getElementById('chatContainer');
            if (!container) return;

            container.addEventListener('scroll', function() {
                const atBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 50;
                autoScrollEnabled = atBottom;
            });

            // Monkey-patch scrollToBottom to respect pause
            if (typeof scrollToBottom === 'function') {
                const _origScroll = scrollToBottom;
                window.scrollToBottom = function() {
                    if (autoScrollEnabled) {
                        _origScroll();
                    }
                };
            }
        }

        // =====================================================================
        // INITIALIZATION
        // =====================================================================

        function initStreamingOverlay() {
            // Check OBS mode first - if active, skip settings UI init
            const isOBS = checkOBSMode();

            if (!isOBS) {
                initSettingsTabs();
                populateSettingsUI();
                initSaveButtons();
                initCodeEditorTabs();
                initEnhancedOBSUrl();
                initAutoScrollPause();
            }

            // Update status dots
            setTimeout(updateCPStatusDots, 2000);
        }

        // Run after DOM is ready (script.js DOMContentLoaded has already fired by now)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initStreamingOverlay);
        } else {
            // DOM already ready, run on next tick to ensure script.js has initialized
            setTimeout(initStreamingOverlay, 0);
        }

    })();
    </script>
</body>
</html>
